import common from '@ohos.app.ability.common';
import { BusinessError } from '@ohos.base';
import { Want } from '@kit.AbilityKit';
import pasteboard from '@ohos.pasteboard';
import promptAction from '@ohos.promptAction';

@Entry
@Component
struct InvoiceVerifyPage {
  private context = getContext(this) as common.UIAbilityContext;

  @State showError: boolean = false;
  @State errorMessage: string = '';

  private async openInvoiceWebsite(): Promise<void> {
    // å…ˆæ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    try {
      await promptAction.showDialog({
        title: 'è·³è½¬åˆ°å¤–éƒ¨ç½‘ç«™',
        message: 'å³å°†è·³è½¬åˆ°å›½å®¶ç¨åŠ¡æ€»å±€å‘ç¥¨æŸ¥éªŒå¹³å°ï¼ˆå®˜æ–¹ç½‘ç«™ï¼‰ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ',
        buttons: [
          { text: 'å–æ¶ˆ', color: '#999999' },
          { text: 'å‰å¾€', color: $r('app.color.button_primary') }
        ]
      }).then((result) => {
        // ç”¨æˆ·ç‚¹å‡»"å‰å¾€"æŒ‰é’®ï¼ˆç´¢å¼•ä¸º1ï¼‰
        if (result.index === 1) {
          this.doOpenInvoiceWebsite();
        }
      }).catch((err: Error) => {
        console.error(`Failed to show dialog: ${err.message}`);
      });
    } catch (err) {
      console.error(`Failed to show dialog: ${err instanceof Error ? err.message : String(err)}`);
    }
  }

  private async doOpenInvoiceWebsite(): Promise<void> {
    const url = 'https://inv-veri.chinatax.gov.cn';
    
    // ä¼˜å…ˆå°è¯•ä½¿ç”¨é€šç”¨ Intent æ‰“å¼€ URL
    const want: Want = {
      action: 'ohos.want.action.viewData',
      uri: url,
      type: 'text/html'
    };

    try {
      await this.context.startAbility(want);
    } catch (err) {
      // å¦‚æœé€šç”¨ Intent å¤±è´¥ï¼Œå°è¯•åä¸ºæµè§ˆå™¨
      try {
        await this.context.startAbility({
          bundleName: 'com.huawei.hmos.browser',
          abilityName: 'com.huawei.hmos.browser.MainAbility',
          uri: url,
          parameters: {
            url: url
          }
        });
      } catch (browserErr) {
        // å¦‚æœéƒ½å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤ºå’Œæ‰‹åŠ¨è¾“å…¥é€‰é¡¹
        this.errorMessage = 'æ— æ³•è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ç½‘å€åˆ°æµè§ˆå™¨è®¿é—®';
        this.showError = true;
        setTimeout(() => {
          this.showError = false;
        }, 5000);
      }
    }
  }

  build() {
    Navigation() {
      Scroll() {
        Column() {
          // é”™è¯¯æç¤º
          if (this.showError) {
            Row() {
              Text(this.errorMessage)
                .fontSize(14)
                .fontColor($r('app.color.text_white'))
                .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            }
              .width('100%')
              .backgroundColor($r('app.color.color_red'))
              .justifyContent(FlexAlign.Center)
              .margin({ top: 0, left: 16, right: 16 })
          }

          // å®˜æ–¹æŸ¥éªŒå…¥å£
          Column() {
            Text('ğŸ”')
              .fontSize(48)
              .margin({ bottom: 16 })
            Text('å›½å®¶ç¨åŠ¡æ€»å±€')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
            Text('å…¨å›½å¢å€¼ç¨å‘ç¥¨æŸ¥éªŒå¹³å°')
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))
              .margin({ top: 8 })

            Button('å‰å¾€æŸ¥éªŒ')
              .type(ButtonType.Normal)
              .backgroundColor($r('app.color.button_primary'))
              .fontColor($r('app.color.text_white'))
              .fontSize(16)
              .width(200)
              .height(48)
              .borderRadius(24)
              .margin({ top: 24 })
              .onClick(() => {
                this.openInvoiceWebsite();
              })

            Row() {
              Text('https://inv-veri.chinatax.gov.cn')
                .fontSize(12)
                .fontColor($r('app.color.text_tertiary'))
              Text('ï¼ˆç‚¹å‡»å¤åˆ¶ï¼‰')
                .fontSize(11)
                .fontColor($r('app.color.button_primary'))
                .margin({ left: 8 })
            }
            .margin({ top: 12 })
            .onClick(() => {
              // å¤åˆ¶åˆ°å‰ªè´´æ¿
              const systemPasteboard = pasteboard.getSystemPasteboard();
              const data: pasteboard.PasteData = pasteboard.createPlainTextData('https://inv-veri.chinatax.gov.cn');
              systemPasteboard.setPasteData(data).then(() => {
                try {
                  promptAction.showToast({
                    message: 'ç½‘å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿',
                    duration: 2000
                  });
                } catch (err) {
                  console.error(`Failed to show toast: ${err instanceof Error ? err.message : String(err)}`);
                }
              }).catch(() => {
                try {
                  promptAction.showToast({
                    message: 'å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥ç½‘å€',
                    duration: 2000
                  });
                } catch (err) {
                  console.error(`Failed to show toast: ${err instanceof Error ? err.message : String(err)}`);
                }
              });
            })
          }
          .width('100%')
          .padding(40)
          .backgroundColor($r('app.color.bg_card'))
          .margin({ top: 0, left: 16, right: 16 })

          // æŸ¥éªŒè¯´æ˜
          Column() {
            Text('æŸ¥éªŒé¡»çŸ¥')
              .fontSize(17)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 16 })

            this.InfoItem('1', 'å‡†å¤‡å‘ç¥¨ä»£ç ã€å‘ç¥¨å·ç ã€å¼€ç¥¨æ—¥æœŸã€æ ¡éªŒç å6ä½')
            this.InfoItem('2', 'æ¯å¼ å‘ç¥¨æ¯å¤©å¯æŸ¥éªŒ5æ¬¡')
            this.InfoItem('3', 'æ”¯æŒå¢å€¼ç¨ä¸“ç”¨å‘ç¥¨ã€æ™®é€šå‘ç¥¨ã€ç”µå­å‘ç¥¨ç­‰')
            this.InfoItem('4', 'æŸ¥éªŒç»“æœä»…ä¾›å‚è€ƒï¼Œä»¥ç¨åŠ¡æœºå…³è®¤å®šä¸ºå‡†')
          }
          .width('100%')
          .padding(20)
          .backgroundColor($r('app.color.bg_card'))
          .margin({ top: 16, left: 16, right: 16 })

          // å…¶ä»–æŸ¥éªŒæ¸ é“
          Column() {
            Text('å…¶ä»–æŸ¥éªŒæ¸ é“')
              .fontSize(17)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 16 })

            this.ChannelItem('å¾®ä¿¡å°ç¨‹åº', 'æœç´¢"ç¥¨å¤§ä¾ "æˆ–"å‘ç¥¨åŠ©æ‰‹"')
            Divider().color($r('app.color.gray_border')).margin({ top: 12, bottom: 12 })
            this.ChannelItem('æ”¯ä»˜å®', 'æœç´¢"å‘ç¥¨ç®¡å®¶"')
            Divider().color($r('app.color.gray_border')).margin({ top: 12, bottom: 12 })
            this.ChannelItem('å„çœç”µå­ç¨åŠ¡å±€', 'ç™»å½•å½“åœ°ç”µå­ç¨åŠ¡å±€ç½‘ç«™')
          }
          .width('100%')
          .padding(20)
          .backgroundColor($r('app.color.bg_card'))
          .margin({ top: 16, left: 16, right: 16, bottom: 16 })
          .alignItems(HorizontalAlign.Start)
        }
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
      .backgroundColor($r('app.color.bg_page'))
    }
    .title('å‘ç¥¨çœŸä¼ªæŸ¥è¯¢')
    .titleMode(NavigationTitleMode.Mini)
    .hideBackButton(false)
    .backgroundColor($r('app.color.bg_page'))
  }

  @Builder
  InfoItem(num: string, text: string) {
    Row() {
      Text(num)
        .fontSize(12)
        .fontColor($r('app.color.text_white'))
        .backgroundColor($r('app.color.button_primary'))
        .width(20)
        .height(20)
        .borderRadius(10)
        .textAlign(TextAlign.Center)
      Text(text)
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
        .margin({ left: 12 })
        .layoutWeight(1)
    }
    .width('100%')
    .margin({ bottom: 12 })
  }

  @Builder
  ChannelItem(title: string, desc: string) {
    Column() {
      Text(title)
        .fontSize(15)
        .fontColor($r('app.color.text_primary'))
      Text(desc)
        .fontSize(13)
        .fontColor($r('app.color.text_tertiary'))
        .margin({ top: 4 })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }
}

