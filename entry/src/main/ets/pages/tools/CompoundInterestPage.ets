import { inputMethod } from '@kit.IMEKit';
import { AmountInput } from '../../components/AmountInput';
import { InputValidator } from '../../utils/inputValidator';

@Entry
@Component
    struct CompoundInterestPage {
    @State principal: string = '';
    @State annualRate: string = '';
    @State years: string = '';
    @State compoundFrequency: number = 1; // å¤åˆ©é¢‘ç‡ï¼š1=å¹´ï¼Œ2=åŠå¹´ï¼Œ4=å­£åº¦ï¼Œ12=æœˆ
    @State finalAmount: number = 0;
    @State totalInterest: number = 0;
    @State showResult: boolean = false;
    @State errorMessage: string = '';

    private frequencyLabels: string[] = ['å¹´å¤åˆ©', 'åŠå¹´å¤åˆ©', 'å­£åº¦å¤åˆ©', 'æœˆå¤åˆ©'];
    private frequencyValues: number[] = [1, 2, 4, 12];

    private validateInputs(): boolean {
        if (!this.principal || this.principal.trim() === '') {
            this.errorMessage = 'è¯·è¾“å…¥æœ¬é‡‘';
            return false;
        }
        if (!this.annualRate || this.annualRate.trim() === '') {
            this.errorMessage = 'è¯·è¾“å…¥å¹´åŒ–æ”¶ç›Šç‡';
            return false;
        }
        if (!this.years || this.years.trim() === '') {
            this.errorMessage = 'è¯·è¾“å…¥æŠ•èµ„æœŸé™';
            return false;
        }
        const p = parseFloat(this.principal);
        const r = parseFloat(this.annualRate);
        const n = parseFloat(this.years);
        if (isNaN(p) || p <= 0) {
            this.errorMessage = 'æœ¬é‡‘å¿…é¡»å¤§äº0';
            return false;
        }
        if (isNaN(r) || r < 0) {
            this.errorMessage = 'å¹´åŒ–æ”¶ç›Šç‡ä¸èƒ½ä¸ºè´Ÿæ•°';
            return false;
        }
        if (isNaN(n) || n <= 0) {
            this.errorMessage = 'æŠ•èµ„æœŸé™å¿…é¡»å¤§äº0';
            return false;
        }
        this.errorMessage = '';
        return true;
    }

    private calculate(): void {
        if (!this.validateInputs()) {
            return;
        }

        const p = parseFloat(this.principal);
        const r = parseFloat(this.annualRate);
        const n = parseFloat(this.years);
        const m = this.frequencyValues[this.compoundFrequency];

        if (p > 0 && r > 0 && n > 0) {
            // å¤åˆ©å…¬å¼ï¼šA = P(1 + r/m)^(m*n)
            const ratePerPeriod = r / 100 / m;
            const totalPeriods = m * n;
            this.finalAmount = p * Math.pow(1 + ratePerPeriod, totalPeriods);
            this.totalInterest = this.finalAmount - p;
        } else {
            this.finalAmount = 0;
            this.totalInterest = 0;
        }

        this.showResult = true;
    }

    build() {
        Navigation() {
            Scroll() {
                Column() {
                    Column() {
                        Text('å¤åˆ©é¢‘ç‡')
                            .fontSize(14)
                            .fontColor($r('app.color.text_secondary'))
                            .alignSelf(ItemAlign.Start)
                            .margin({ bottom: 12 })
                        Row() {
                            ForEach(this.frequencyLabels, (label: string, index: number) => {
                                this.FrequencyButton(label, index)
                            })
                        }
            .width('100%')
                            .justifyContent(FlexAlign.SpaceBetween)
                    }
          .width('100%')
                        .padding(20)
                        .backgroundColor($r('app.color.bg_card'))
                        .borderRadius(0)
                        .margin({ top: 0, left: 16, right: 16 })

                    Column() {
                        AmountInput({
                            label: 'æœ¬é‡‘ï¼ˆå…ƒï¼‰',
                            placeholder: 'è¯·è¾“å…¥æœ¬é‡‘',
                            value: this.principal,
                            onChange: (val: string) => {
                                this.principal = val;
                            }
                        })
                            .margin({ bottom: 16 })
                        this.InputField('å¹´åŒ–æ”¶ç›Šç‡ï¼ˆ%ï¼‰', this.annualRate, (v: string) => { this.annualRate = v; })
                        this.InputField('æŠ•èµ„å¹´é™', this.years, (v: string) => { this.years = v; })
                    }
          .width('100%')
                        .padding(20)
                        .backgroundColor($r('app.color.bg_card'))
                        .borderRadius(0)
                        .margin({ top: 16, left: 16, right: 16 })

                    Button('è®¡ç®—')
                        .type(ButtonType.Normal)
                        .backgroundColor($r('app.color.button_primary'))
                        .fontColor($r('app.color.text_white'))
                        .fontSize(16)
                        .width('80%')
                        .constraintSize({ maxWidth: 320 })
                        .height(48)
                        .borderRadius(8)
                        .margin({ top: 16, left: 16, right: 16 })
                        .onClick(() => {
                            this.calculate();
                            inputMethod.getController().stopInputSession();
                        })

                    if (this.showResult) {
                        Column() {
                            Text('å¤åˆ©ç»ˆå€¼')
                                .fontSize(14)
                                .fontColor($r('app.color.text_tertiary'))
                            Text(`Â¥${this.finalAmount.toFixed(2)}`)
                                .fontSize(32)
                                .fontWeight(FontWeight.Bold)
                                .fontColor($r('app.color.button_primary'))
                                .margin({ top: 8 })

                            Divider()
                                .color($r('app.color.gray_border'))
                                .margin({ top: 16, bottom: 16 })

                            Row() {
                                Column() {
                                    Text('æœ¬é‡‘')
                                        .fontSize(12)
                                        .fontColor($r('app.color.text_tertiary'))
                                    Text(`Â¥${parseFloat(this.principal || '0').toFixed(2)}`)
                                        .fontSize(16)
                                        .fontWeight(FontWeight.Medium)
                                        .fontColor($r('app.color.text_dark'))
                                        .margin({ top: 4 })
                                }
                .layoutWeight(1)

                                Divider()
                                    .vertical(true)
                                    .height(50)
                                    .color($r('app.color.gray_border'))

                                Column() {
                                    Text('åˆ©æ¯æ”¶ç›Š')
                                        .fontSize(12)
                                        .fontColor($r('app.color.text_tertiary'))
                                    Text(`Â¥${this.totalInterest.toFixed(2)}`)
                                        .fontSize(16)
                                        .fontWeight(FontWeight.Medium)
                                        .fontColor($r('app.color.color_green'))
                                        .margin({ top: 4 })
                                }
                .layoutWeight(1)
                            }
              .width('100%')

                            Text(`å¤åˆ©é¢‘ç‡ï¼š${this.frequencyLabels[this.compoundFrequency]}`)
                                .fontSize(12)
                                .fontColor($r('app.color.text_tertiary'))
                                .margin({ top: 16 })
                        }
            .width('100%')
                            .padding(24)
                            .backgroundColor($r('app.color.bg_card'))
                            .borderRadius(0)
                            .margin({ top: 16, left: 16, right: 16 })
                    }

                    Column() {
                        Text('å¤åˆ©è®¡ç®—å…¬å¼')
                            .fontSize(15)
                            .fontWeight(FontWeight.Bold)
                            .fontColor($r('app.color.text_primary'))
                            .alignSelf(ItemAlign.Start)
                            .margin({ bottom: 12 })
                        Text('A = P(1 + r/m)^(mÃ—n)')
                            .fontSize(14)
                            .fontColor($r('app.color.text_secondary'))
                            .margin({ bottom: 8 })
                        Text('å…¶ä¸­ï¼š')
                            .fontSize(13)
                            .fontColor($r('app.color.text_secondary'))
                            .margin({ bottom: 4 })
                        Text('â€¢ A = å¤åˆ©ç»ˆå€¼')
                            .fontSize(13)
                            .fontColor($r('app.color.text_secondary'))
                            .margin({ bottom: 2 })
                        Text('â€¢ P = æœ¬é‡‘')
                            .fontSize(13)
                            .fontColor($r('app.color.text_secondary'))
                            .margin({ bottom: 2 })
                        Text('â€¢ r = å¹´åŒ–æ”¶ç›Šç‡')
                            .fontSize(13)
                            .fontColor($r('app.color.text_secondary'))
                            .margin({ bottom: 2 })
                        Text('â€¢ m = å¤åˆ©é¢‘ç‡ï¼ˆå¹´/åŠå¹´/å­£åº¦/æœˆï¼‰')
                            .fontSize(13)
                            .fontColor($r('app.color.text_secondary'))
                            .margin({ bottom: 2 })
                        Text('â€¢ n = æŠ•èµ„å¹´é™')
                            .fontSize(13)
                            .fontColor($r('app.color.text_secondary'))
                            .margin({ top: 8 })
                        Text('ğŸ’¡ å¤åˆ©é¢‘ç‡è¶Šé«˜ï¼Œæ”¶ç›Šè¶Šå¤§')
                            .fontSize(13)
                            .fontColor($r('app.color.button_primary'))
                            .margin({ top: 8 })
                    }
          .width('100%')
                        .padding(20)
                        .backgroundColor($r('app.color.bg_card'))
                        .borderRadius(0)
                        .margin({ top: 16, left: 16, right: 16, bottom: 16 })
                        .alignItems(HorizontalAlign.Start)
                }
            }
      .scrollBar(BarState.Off)
                .edgeEffect(EdgeEffect.Spring)
                .backgroundColor($r('app.color.bg_page'))
        }
    .title('å¤åˆ©è®¡ç®—å™¨')
            .titleMode(NavigationTitleMode.Mini)
            .hideBackButton(false)
            .backgroundColor($r('app.color.bg_page'))
    }

    @Builder
    FrequencyButton(label: string, index: number) {
        Button(label)
            .type(ButtonType.Normal)
            .fontSize(12)
            .fontColor(this.compoundFrequency === index ? $r('app.color.text_white') : $r('app.color.text_secondary'))
            .backgroundColor(this.compoundFrequency === index ? $r('app.color.button_primary') : $r('app.color.bg_secondary'))
            .height(36)
            .borderRadius(16)
            .onClick(() => { this.compoundFrequency = index; })
    }

    @Builder
    InputField(label: string, value: string, onChange: (v: string) => void) {
        Column() {
            Text(label)
                .fontSize(14)
                .fontColor($r('app.color.text_secondary'))
                .margin({ bottom: 8 })
            TextInput({ text: value, placeholder: 'è¯·è¾“å…¥' })
                .type(InputType.Number)
                .height(48)
                .backgroundColor($r('app.color.bg_secondary'))
                .borderRadius(8)
                .onChange((newValue: string) => {
                    // æ ¹æ®æ ‡ç­¾åˆ¤æ–­éªŒè¯æ–¹å¼
                    let validatedValue = newValue;
                    if (label.includes('æ”¶ç›Šç‡') || label.includes('åˆ©ç‡') || label.includes('%')) {
                        validatedValue = InputValidator.validatePercentageInput(newValue);
                    } else {
                        validatedValue = InputValidator.validateNumberInput(newValue);
                    }
                    onChange(validatedValue);
                })
        }
    .width('100%')
            .alignItems(HorizontalAlign.Start)
            .margin({ bottom: 16 })
    }
}

