interface TaxDeadline {
    name: string;
    deadline: string;
    frequency: string;
    important: boolean;
    month?: number; // æœˆä»½ï¼ˆ1-12ï¼‰
    day?: number; // æ—¥æœŸï¼ˆ1-31ï¼‰
}

interface AdjustedDate {
    year: number;
    month: number;
    day: number;
}

@Entry
@Component
    struct TaxCalendarPage {
    @State currentMonth: number = 1;
    @State currentDay: number = 1;
    @State currentYear: number = 2025;
    @State nextDeadline: string = '';
    @State nextDeadlineDays: number = 0;

    private deadlines: TaxDeadline[] = [
        { name: 'å¢å€¼ç¨ç”³æŠ¥', deadline: 'æ¬¡æœˆ15æ—¥', frequency: 'æœˆåº¦/å­£åº¦', important: true },
        { name: 'ä¼ä¸šæ‰€å¾—ç¨é¢„ç¼´', deadline: 'æ¬¡æœˆ15æ—¥', frequency: 'å­£åº¦', important: true },
        { name: 'ä¸ªäººæ‰€å¾—ç¨æ‰£ç¼´', deadline: 'æ¬¡æœˆ15æ—¥', frequency: 'æœˆåº¦', important: true },
        { name: 'åŸå»ºç¨åŠé™„åŠ ', deadline: 'æ¬¡æœˆ15æ—¥', frequency: 'æœˆåº¦/å­£åº¦', important: false },
        { name: 'å°èŠ±ç¨ç”³æŠ¥', deadline: 'æ¬¡æœˆ15æ—¥', frequency: 'æœˆåº¦/å­£åº¦', important: false },
        { name: 'æˆ¿äº§ç¨', deadline: '4æœˆ/10æœˆ', frequency: 'åŠå¹´', important: false },
        { name: 'åŸé•‡åœŸåœ°ä½¿ç”¨ç¨', deadline: '4æœˆ/10æœˆ', frequency: 'åŠå¹´', important: false },
        { name: 'ä¼ä¸šæ‰€å¾—ç¨æ±‡ç®—æ¸…ç¼´', deadline: '5æœˆ31æ—¥', frequency: 'å¹´åº¦', important: true, month: 5, day: 31 },
        { name: 'ä¸ªäººæ‰€å¾—ç¨æ±‡ç®—æ¸…ç¼´', deadline: '6æœˆ30æ—¥', frequency: 'å¹´åº¦', important: true, month: 6, day: 30 },
        { name: 'å·¥å•†å¹´æŠ¥', deadline: '6æœˆ30æ—¥', frequency: 'å¹´åº¦', important: true, month: 6, day: 30 },
        { name: 'æ®‹ä¿é‡‘ç”³æŠ¥', deadline: 'å„åœ°ä¸åŒ', frequency: 'å¹´åº¦', important: false }
    ];

    aboutToAppear(): void {
        const now = new Date();
        this.currentYear = now.getFullYear();
        this.currentMonth = now.getMonth() + 1;
        this.currentDay = now.getDate();
        this.calculateNextDeadline();
    }

    private isWeekend(month: number, day: number, year: number): boolean {
        const date = new Date(year, month - 1, day);
        const dayOfWeek = date.getDay();
        return dayOfWeek === 0 || dayOfWeek === 6; // 0=å‘¨æ—¥, 6=å‘¨å…­
    }

    private adjustForWeekend(month: number, day: number, year: number): AdjustedDate {
        let adjustedYear = year;
        let adjustedMonth = month;
        let adjustedDay = day;

        // å¦‚æœæˆªæ­¢æ—¥æ˜¯å‘¨æœ«ï¼Œé¡ºå»¶åˆ°ä¸‹ä¸€ä¸ªå·¥ä½œæ—¥
        while (this.isWeekend(adjustedMonth, adjustedDay, adjustedYear)) {
            adjustedDay++;
            // å¤„ç†æœˆæœ«è·¨æœˆ
            const daysInMonth = new Date(adjustedYear, adjustedMonth, 0).getDate();
            if (adjustedDay > daysInMonth) {
                adjustedDay = 1;
                adjustedMonth++;
                if (adjustedMonth > 12) {
                    adjustedMonth = 1;
                    adjustedYear++;
                }
            }
        }
        const result: AdjustedDate = {
            year: adjustedYear,
            month: adjustedMonth,
            day: adjustedDay
        };
        return result;
    }

    /**
     * è®¡ç®—ä¸‹ä¸€ä¸ªæˆªæ­¢æ—¥æœŸ
     * ç»¼åˆè€ƒè™‘æœˆåº¦ç”³æŠ¥ï¼ˆæ¬¡æœˆ15æ—¥ï¼‰å’Œå¹´åº¦èŠ‚ç‚¹ï¼ˆå¦‚5/31ã€6/30ç­‰ï¼‰
     */
    private calculateNextDeadline(): void {
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth() + 1;
        const currentDay = now.getDate();
        const today = new Date(currentYear, currentMonth - 1, currentDay);

        let nearestDeadline: Date | null = null;
        let nearestDeadlineText = '';
        let nearestDays = Infinity;

        // éå†æ‰€æœ‰æˆªæ­¢æ—¥æœŸèŠ‚ç‚¹
        for (const deadline of this.deadlines) {
            let candidateDates: Date[] = [];

            if (deadline.month && deadline.day) {
                // å¹´åº¦æˆ–åŠå¹´åº¦èŠ‚ç‚¹ï¼ˆå¦‚5/31ã€6/30ã€4/15ã€10/15ç­‰ï¼‰
                // è®¡ç®—ä»Šå¹´çš„æ—¥æœŸ
                const thisYearDate = new Date(currentYear, deadline.month - 1, deadline.day);
                if (thisYearDate >= today) {
                    const adjusted = this.adjustForWeekend(deadline.month, deadline.day, currentYear);
                    candidateDates.push(new Date(adjusted.year, adjusted.month - 1, adjusted.day));
                }
                
                // å¦‚æœä»Šå¹´çš„å·²ç»è¿‡äº†ï¼Œè®¡ç®—æ˜å¹´çš„
                if (candidateDates.length === 0) {
                    const adjusted = this.adjustForWeekend(deadline.month, deadline.day, currentYear + 1);
                    candidateDates.push(new Date(adjusted.year, adjusted.month - 1, adjusted.day));
                }
            } else if (deadline.deadline === 'æ¬¡æœˆ15æ—¥') {
                // æœˆåº¦ç”³æŠ¥èŠ‚ç‚¹
                // åˆ¤æ–­æ˜¯æœ¬æœˆ15æ—¥è¿˜æ˜¯æ¬¡æœˆ15æ—¥
                let targetMonth: number;
                let targetYear: number;
                if (currentDay <= 15) {
                    targetMonth = currentMonth;
                    targetYear = currentYear;
                } else {
                    targetMonth = currentMonth + 1;
                    targetYear = currentYear;
                    if (targetMonth > 12) {
                        targetMonth = 1;
                        targetYear++;
                    }
                }
                const adjusted = this.adjustForWeekend(targetMonth, 15, targetYear);
                candidateDates.push(new Date(adjusted.year, adjusted.month - 1, adjusted.day));
            }

            // æ‰¾åˆ°æœ€è¿‘çš„æ—¥æœŸ
            for (const candidateDate of candidateDates) {
                const diffTime = candidateDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays >= 0 && diffDays < nearestDays) {
                    nearestDays = diffDays;
                    nearestDeadline = candidateDate;
                    const month = candidateDate.getMonth() + 1;
                    const day = candidateDate.getDate();
                    nearestDeadlineText = `${month}æœˆ${day}æ—¥`;
                }
            }
        }

        this.nextDeadline = nearestDeadlineText || 'æš‚æ— ';
        this.nextDeadlineDays = nearestDays === Infinity ? 0 : nearestDays;
    }

    build() {
        Navigation() {
            Scroll() {
                Column() {
                    // æœ¬æœˆé‡è¦æé†’
                    Column() {
                        Row() {
                            Text('ğŸ“…')
                                .fontSize(20)
                                .margin({ right: 8 })
                            Text('æœ¬æœˆç”³æŠ¥æˆªæ­¢')
                                .fontSize(17)
                                .fontWeight(FontWeight.Bold)
                                .fontColor($r('app.color.text_primary'))
                        }
            .width('100%')
                            .margin({ bottom: 16 })

                        Row() {
                            Column() {
                                Text(String(this.nextDeadlineDays > 0 ? this.nextDeadlineDays : 0))
                                    .fontSize(36)
                                    .fontWeight(FontWeight.Bold)
                                    .fontColor($r('app.color.color_red'))
                                Text('å¤©åæˆªæ­¢')
                                    .fontSize(14)
                                    .fontColor($r('app.color.text_secondary'))
                            }
                            .width(100)
                            .padding(16)
                            .backgroundColor($r('app.color.bg_blue_light'))
                            .borderRadius(12)

                            Column() {
                                Text(`ä¸‹æ¬¡ç”³æŠ¥æˆªæ­¢ï¼š${this.nextDeadline}`)
                                    .fontSize(14)
                                    .fontColor($r('app.color.text_primary'))
                                    .fontWeight(FontWeight.Medium)
                                Text('å¢å€¼ç¨ã€ä¼ä¸šæ‰€å¾—ç¨é¢„ç¼´')
                                    .fontSize(13)
                                    .fontColor($r('app.color.text_secondary'))
                                    .margin({ top: 4 })
                                Text('ä¸ªäººæ‰€å¾—ç¨æ‰£ç¼´ç”³æŠ¥')
                                    .fontSize(13)
                                    .fontColor($r('app.color.text_secondary'))
                                    .margin({ top: 2 })
                                Text('é™„åŠ ç¨è´¹ç”³æŠ¥')
                                    .fontSize(13)
                                    .fontColor($r('app.color.text_secondary'))
                                    .margin({ top: 2 })
                            }
                            .alignItems(HorizontalAlign.Start)
                            .layoutWeight(1)
                            .margin({ left: 20 })
                        }
            .width('100%')

                        Text(`* å½“å‰æ—¥æœŸï¼š${this.currentYear}å¹´${this.currentMonth}æœˆ${this.currentDay}æ—¥ï¼Œé‡èŠ‚å‡æ—¥é¡ºå»¶`)
                            .fontSize(12)
                            .fontColor($r('app.color.text_tertiary'))
                            .margin({ top: 12 })
                    }
                    .width('100%')
                        .padding(20)
                        .backgroundColor($r('app.color.bg_card'))
                        .margin({ top: 0, left: 16, right: 16 })

                    // ç”³æŠ¥æ—¥å†åˆ—è¡¨
                    Column() {
                        Text('ç”³æŠ¥æ—¥å†')
                            .fontSize(17)
                            .fontWeight(FontWeight.Bold)
                            .fontColor($r('app.color.text_primary'))
                            .alignSelf(ItemAlign.Start)
                            .margin({ bottom: 16 })

                        ForEach(this.deadlines, (item: TaxDeadline, index: number) => {
                            Row() {
                                Column() {
                                    Row() {
                                        if (item.important) {
                                            Text('é‡è¦')
                                                .fontSize(10)
                                                .fontColor($r('app.color.text_white'))
                                                .backgroundColor($r('app.color.color_red'))
                                                .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                                                .borderRadius(4)
                                                .margin({ right: 8 })
                                        }
                                        Text(item.name)
                                            .fontSize(15)
                                            .fontColor($r('app.color.text_primary'))
                                    }
                                    Row() {
                                        Text(item.frequency)
                                            .fontSize(12)
                                            .fontColor($r('app.color.text_tertiary'))
                                        Text(' | ')
                                            .fontSize(12)
                                            .fontColor($r('app.color.light_gray'))
                                        Text(`æˆªæ­¢ï¼š${item.deadline}`)
                                            .fontSize(12)
                                            .fontColor($r('app.color.button_primary'))
                                    }
                  .margin({ top: 4 })
                                }
                .alignItems(HorizontalAlign.Start)
                                    .layoutWeight(1)
                            }
              .width('100%')
                                .padding({ top: 12, bottom: 12 })

                            if (index < this.deadlines.length - 1) {
                                Divider().color($r('app.color.gray_border'))
                            }
                        })
                    }
          .width('100%')
                        .padding(20)
                        .backgroundColor($r('app.color.bg_card'))
                        .margin({ top: 16, left: 16, right: 16 })

                    // æç¤º
                    Column() {
                        Text('ğŸ’¡ æ¸©é¦¨æç¤º')
                            .fontSize(15)
                            .fontWeight(FontWeight.Bold)
                            .fontColor($r('app.color.color_orange'))
                            .alignSelf(ItemAlign.Start)
                            .margin({ bottom: 12 })
                        Text('â€¢ ç”³æŠ¥æˆªæ­¢æ—¥å¦‚é‡æ³•å®šèŠ‚å‡æ—¥ï¼Œé¡ºå»¶è‡³ä¸‹ä¸€å·¥ä½œæ—¥')
                            .fontSize(13)
                            .fontColor($r('app.color.text_secondary'))
                            .margin({ bottom: 4 })
                        Text('â€¢ å„åœ°åŒºå¯èƒ½æœ‰å·®å¼‚ï¼Œè¯·ä»¥å½“åœ°ç¨åŠ¡æœºå…³é€šçŸ¥ä¸ºå‡†')
                            .fontSize(13)
                            .fontColor($r('app.color.text_secondary'))
                            .margin({ bottom: 4 })
                        Text('â€¢ å»ºè®®æå‰2-3å¤©å®Œæˆç”³æŠ¥ï¼Œé¿å…ç³»ç»Ÿæ‹¥å µ')
                            .fontSize(13)
                            .fontColor($r('app.color.text_secondary'))
                    }
          .width('100%')
                        .padding(20)
                        .backgroundColor($r('app.color.bg_yellow_light'))
                        .margin({ top: 16, left: 16, right: 16, bottom: 16 })
                        .alignItems(HorizontalAlign.Start)
                }
            }
      .layoutWeight(1)
                .scrollBar(BarState.Off)
                .backgroundColor($r('app.color.bg_page'))
        }
    .title('ç¨åŠ¡æ—¥å†')
            .titleMode(NavigationTitleMode.Mini)
            .hideBackButton(false)
            .backgroundColor($r('app.color.bg_page'))
    }
}

