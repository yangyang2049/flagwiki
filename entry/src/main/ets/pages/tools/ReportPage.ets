import common from '@ohos.app.ability.common';
import { BusinessError } from '@ohos.base';
import { Want } from '@kit.AbilityKit';
import promptAction from '@ohos.promptAction';

interface ReportType {
  name: string;
  desc: string;
}

@Entry
@Component
struct ReportPage {
  private context = getContext(this) as common.UIAbilityContext;
  
  @State reportTypes: ReportType[] = [
    { name: 'å·ç¨æ¼ç¨', desc: 'ä¼ä¸šæˆ–ä¸ªäººæ•…æ„å°‘ç¼´ã€ä¸ç¼´ç¨æ¬¾' },
    { name: 'è™šå¼€å‘ç¥¨', desc: 'è™šå¼€å¢å€¼ç¨ä¸“ç”¨å‘ç¥¨æˆ–å…¶ä»–å‘ç¥¨' },
    { name: 'å‡å‘ç¥¨', desc: 'ä½¿ç”¨å‡å‘ç¥¨ã€ä¼ªé€ å‘ç¥¨' },
    { name: 'ä¼šè®¡é€ å‡', desc: 'ä¼ªé€ ä¼šè®¡å‡­è¯ã€è´¦ç°¿ã€æŠ¥è¡¨' },
    { name: 'éª—å–å‡ºå£é€€ç¨', desc: 'ä»¥å‡æŠ¥å‡ºå£ç­‰æ–¹å¼éª—å–å‡ºå£é€€ç¨' },
    { name: 'å…¶ä»–ç¨æ”¶è¿æ³•', desc: 'å…¶ä»–ç¨æ”¶è¿æ³•è¡Œä¸º' }
  ];

  @State showError: boolean = false;
  @State errorMessage: string = '';

  private async openReportWebsite(): Promise<void> {
    // å…ˆæ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    try {
      await promptAction.showDialog({
        title: 'è·³è½¬åˆ°å¤–éƒ¨ç½‘ç«™',
        message: 'å³å°†è·³è½¬åˆ°å›½å®¶ç¨åŠ¡æ€»å±€ç¨æ”¶è¿æ³•è¡Œä¸ºä¸¾æŠ¥å¹³å°ï¼ˆå®˜æ–¹ç½‘ç«™ï¼‰ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ',
        buttons: [
          { text: 'å–æ¶ˆ', color: '#999999' },
          { text: 'å‰å¾€', color: $r('app.color.button_primary') }
        ]
      }).then((result) => {
        // ç”¨æˆ·ç‚¹å‡»"å‰å¾€"æŒ‰é’®ï¼ˆç´¢å¼•ä¸º1ï¼‰
        if (result.index === 1) {
          this.doOpenReportWebsite();
        }
      }).catch((err: Error) => {
        console.error(`Failed to show dialog: ${err.message}`);
      });
    } catch (err) {
      console.error(`Failed to show dialog: ${err instanceof Error ? err.message : String(err)}`);
    }
  }

  private async doOpenReportWebsite(): Promise<void> {
    const url = 'https://fgk.chinatax.gov.cn/jzxx2023/wfjj2023.html';
    
    // ä¼˜å…ˆå°è¯•ä½¿ç”¨é€šç”¨ Intent æ‰“å¼€ URL
    const want: Want = {
      action: 'ohos.want.action.viewData',
      uri: url,
      type: 'text/html'
    };

    try {
      await this.context.startAbility(want);
    } catch (err) {
      // å¦‚æœé€šç”¨ Intent å¤±è´¥ï¼Œå°è¯•åä¸ºæµè§ˆå™¨
      try {
        await this.context.startAbility({
          bundleName: 'com.huawei.hmos.browser',
          abilityName: 'com.huawei.hmos.browser.MainAbility',
          uri: url,
          parameters: {
            url: url
          }
        });
      } catch (browserErr) {
        // å¦‚æœéƒ½å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º
        this.errorMessage = 'æ— æ³•è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ç½‘å€åˆ°æµè§ˆå™¨è®¿é—®';
        this.showError = true;
        setTimeout(() => {
          this.showError = false;
        }, 5000);
      }
    }
  }

  build() {
    Navigation() {
      Scroll() {
        Column() {
          // é”™è¯¯æç¤º
          if (this.showError) {
            Row() {
              Text(this.errorMessage)
                .fontSize(14)
                .fontColor($r('app.color.text_white'))
                .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            }
              .width('100%')
              .backgroundColor($r('app.color.color_red'))
              .justifyContent(FlexAlign.Center)
              .margin({ top: 0, left: 16, right: 16 })
          }

          // ä¸¾æŠ¥è¯´æ˜
          Column() {
            Text('ğŸš¨')
              .fontSize(48)
              .margin({ bottom: 16 })
            Text('ç¨æ”¶è¿æ³•è¡Œä¸ºä¸¾æŠ¥')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .margin({ bottom: 8 })
            Text('ç»´æŠ¤ç¨æ”¶ç§©åºï¼Œæ‰“å‡»ç¨æ”¶è¿æ³•')
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))

            Button('å‰å¾€å›½å®¶ç¨åŠ¡æ€»å±€ä¸¾æŠ¥')
              .type(ButtonType.Normal)
              .fontSize(16)
              .fontColor($r('app.color.text_white'))
              .backgroundColor($r('app.color.color_red'))
              .width('80%')
              .constraintSize({ maxWidth: 280 })
              .height(48)
              .borderRadius(24)
              .margin({ top: 24 })
              .onClick(() => {
                this.openReportWebsite();
              })
          }
          .width('100%')
          .padding(32)
          .backgroundColor($r('app.color.bg_card'))
          .margin({ top: 0, left: 16, right: 16 })

          // ä¸¾æŠ¥ç±»å‹
          Column() {
            Text('å¸¸è§ä¸¾æŠ¥ç±»å‹')
              .fontSize(17)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 16 })

            ForEach(this.reportTypes, (type: ReportType) => {
              Column() {
                Row() {
                  Text('â€¢')
                    .fontSize(20)
                    .fontColor($r('app.color.color_red'))
                    .margin({ right: 8 })
                  Column() {
                    Text(type.name)
                      .fontSize(15)
                      .fontWeight(FontWeight.Medium)
                      .fontColor($r('app.color.text_primary'))
                      .alignSelf(ItemAlign.Start)
                    Text(type.desc)
                      .fontSize(13)
                      .fontColor($r('app.color.text_tertiary'))
                      .margin({ top: 4 })
                      .alignSelf(ItemAlign.Start)
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Start)
                }
                .width('100%')
                .padding({ top: 12, bottom: 12 })
              }
              .width('100%')
            })
          }
          .width('100%')
          .padding(20)
          .backgroundColor($r('app.color.bg_card'))
          .margin({ top: 16, left: 16, right: 16 })
          .alignItems(HorizontalAlign.Start)

          // ä¸¾æŠ¥æ–¹å¼
          Column() {
            Text('ä¸¾æŠ¥æ–¹å¼')
              .fontSize(17)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 16 })

            this.ReportMethodItem('ğŸ“±', '12366çº³ç¨æœåŠ¡çƒ­çº¿', 'æ‹¨æ‰“å½“åœ°12366çº³ç¨æœåŠ¡çƒ­çº¿')
            Divider().color($r('app.color.gray_border')).margin({ top: 12, bottom: 12 })
            this.ReportMethodItem('ğŸ’»', 'ç½‘ä¸Šä¸¾æŠ¥', 'ç™»å½•å›½å®¶ç¨åŠ¡æ€»å±€æˆ–å½“åœ°ç¨åŠ¡å±€ç½‘ç«™')
            Divider().color($r('app.color.gray_border')).margin({ top: 12, bottom: 12 })
            this.ReportMethodItem('âœ‰ï¸', 'ä¿¡å‡½ä¸¾æŠ¥', 'å‘å½“åœ°ç¨åŠ¡æœºå…³é‚®å¯„ä¸¾æŠ¥ä¿¡')
            Divider().color($r('app.color.gray_border')).margin({ top: 12, bottom: 12 })
            this.ReportMethodItem('ğŸ¢', 'ç°åœºä¸¾æŠ¥', 'å‰å¾€å½“åœ°ç¨åŠ¡æœºå…³ç°åœºä¸¾æŠ¥')
          }
          .width('100%')
          .padding(20)
          .backgroundColor($r('app.color.bg_card'))
          .margin({ top: 16, left: 16, right: 16 })
          .alignItems(HorizontalAlign.Start)

          // ä¸¾æŠ¥é¡»çŸ¥
          Column() {
            Text('âš ï¸ ä¸¾æŠ¥é¡»çŸ¥')
              .fontSize(17)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.color_orange'))
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 16 })

            this.NoticeItem('1', 'å®åä¸¾æŠ¥ä¼˜å…ˆå—ç†ï¼ŒåŒ¿åä¸¾æŠ¥ä¹Ÿä¼šä¾æ³•å¤„ç†')
            this.NoticeItem('2', 'æä¾›å…·ä½“çº¿ç´¢å’Œè¯æ®ï¼Œæé«˜åŠç†æ•ˆç‡')
            this.NoticeItem('3', 'ä¸¾æŠ¥äººä¿¡æ¯ä¾æ³•ä¿å¯†ï¼Œä¿æŠ¤ä¸¾æŠ¥äººæƒç›Š')
            this.NoticeItem('4', 'ä¸å¾—è¯¬å‘Šé™·å®³ä»–äººï¼Œå¦åˆ™æ‰¿æ‹…æ³•å¾‹è´£ä»»')
            this.NoticeItem('5', 'ä¸¾æŠ¥å±å®çš„ï¼Œå¯ä¾è§„å®šè·å¾—å¥–åŠ±')
          }
          .width('100%')
          .padding(20)
          .backgroundColor($r('app.color.bg_orange_light'))
          .margin({ top: 16, left: 16, right: 16 })
          .alignItems(HorizontalAlign.Start)

          // è”ç³»æ–¹å¼
          Column() {
            Text('ğŸ“ ä¸¾æŠ¥å’¨è¯¢')
              .fontSize(17)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 16 })

            Row() {
              Column() {
                Text('å…¨å›½ç»Ÿä¸€çƒ­çº¿')
                  .fontSize(14)
                  .fontColor($r('app.color.text_secondary'))
                Text('12366')
                  .fontSize(24)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.button_primary'))
                  .margin({ top: 8 })
              }
              .layoutWeight(1)
              .alignItems(HorizontalAlign.Start)

              Column() {
                Text('ä¸¾æŠ¥ä¸­å¿ƒ')
                  .fontSize(14)
                  .fontColor($r('app.color.text_secondary'))
                Text('010-63417425')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor($r('app.color.button_primary'))
                  .margin({ top: 8 })
              }
              .layoutWeight(1)
              .alignItems(HorizontalAlign.Start)
            }
            .width('100%')

            Text('â€¢ å·¥ä½œæ—¶é—´ï¼šå‘¨ä¸€è‡³å‘¨äº” 9:00-17:00')
              .fontSize(12)
              .fontColor($r('app.color.text_tertiary'))
              .margin({ top: 16 })
              .alignSelf(ItemAlign.Start)
          }
          .width('100%')
          .padding(20)
          .backgroundColor($r('app.color.bg_card'))
          .margin({ top: 16, left: 16, right: 16, bottom: 16 })
          .alignItems(HorizontalAlign.Start)
        }
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
      .backgroundColor($r('app.color.bg_page'))
    }
    .title('ç¨åŠ¡è¿æ³•ä¸¾æŠ¥')
    .titleMode(NavigationTitleMode.Mini)
    .hideBackButton(false)
    .backgroundColor($r('app.color.bg_page'))
  }

  @Builder
  ReportMethodItem(icon: string, title: string, desc: string) {
    Row() {
      Text(icon)
        .fontSize(24)
        .margin({ right: 12 })
      Column() {
        Text(title)
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
          .alignSelf(ItemAlign.Start)
        Text(desc)
          .fontSize(13)
          .fontColor($r('app.color.text_tertiary'))
          .margin({ top: 4 })
          .alignSelf(ItemAlign.Start)
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
  }

  @Builder
  NoticeItem(num: string, text: string) {
    Row() {
      Text(num)
        .fontSize(12)
        .fontColor($r('app.color.text_white'))
        .backgroundColor($r('app.color.color_orange'))
        .width(20)
        .height(20)
        .borderRadius(10)
        .textAlign(TextAlign.Center)
      Text(text)
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
        .margin({ left: 12 })
        .layoutWeight(1)
    }
    .width('100%')
    .margin({ bottom: 12 })
  }
}

