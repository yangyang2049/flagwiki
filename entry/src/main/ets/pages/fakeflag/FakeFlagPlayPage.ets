import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import common from '@ohos.app.ability.common';
import { getCountryByCode } from '../../utils/countryData';
import { FakeFlagLevel, FakeFlagQuestion, getFakeFlagLevel, getAllFakeFlagLevels } from './FakeFlagLevels';
import { GameProgressManager, GameType } from '../../utils/GameProgressManager';
import { SoundEffectUtil } from '../../utils/SoundEffectUtil';
import { VibratorUtil } from '../../utils/VibratorUtil';

interface RouterParams {
  levelId: number;
}

@Entry
@Component
  struct FakeFlagPlayPage {
  @State level: FakeFlagLevel | undefined = undefined;
  @State currentIndex: number = 0;
  @State lives: number = 3;
  @State selectedCode: string = '';
  @State isAnswered: boolean = false;
  @State isCorrect: boolean = false;
  @State showResult: boolean = false;
  @State correctAnswers: number = 0;
  @State animatingCode: string = '';
  @State scaleValue: number = 1;
  @State showCompareDialog: boolean = false;
  @State flagVisible: boolean[] = [false, false, false, false];  // å›½æ——é€‰é¡¹å¯è§æ€§
  private context = getContext(this) as common.UIAbilityContext;

  async aboutToAppear() {
    // åˆå§‹åŒ–éŸ³æ•ˆæ’­æ”¾å™¨
    await SoundEffectUtil.init(this.context);
    await VibratorUtil.init(this.context);

    const params = router.getParams() as RouterParams;
    if (params) {
      const levelId = params.levelId || 1;
      this.loadLevel(levelId);
    }
  }

  aboutToDisappear() {
    // é‡Šæ”¾éŸ³æ•ˆèµ„æº
    SoundEffectUtil.release();
  }

  private loadLevel(levelId: number): void {
    this.level = getFakeFlagLevel(levelId);
    if (this.level) {
      this.lives = this.level.lives;
      this.currentIndex = 0;
      this.selectedCode = '';
      this.isAnswered = false;
      this.isCorrect = false;
      this.showResult = false;
      this.correctAnswers = 0;
      this.animatingCode = '';
      this.scaleValue = 1;
      this.showCompareDialog = false;
      this.flagVisible = [false, false, false, false];
      // è§¦å‘é€‰é¡¹åŠ¨ç”»
      this.animateFlags();
    }
  }

  private getCurrentQuestion(): FakeFlagQuestion | undefined {
    if (!this.level || this.currentIndex >= this.level.questions.length) {
      return undefined;
    }
    return this.level.questions[this.currentIndex];
  }

  private selectFlag(code: string): void {
    // å¦‚æœå·²ç­”å¯¹ã€æ­£åœ¨åŠ¨ç”»ä¸­ã€æˆ–è€…å½“å‰æ­£åœ¨æ˜¾ç¤ºé”™è¯¯çŠ¶æ€ï¼Œåˆ™ä¸å¤„ç†
    if (this.isAnswered || this.animatingCode !== '' || this.selectedCode !== '') return;

    // ç‚¹å‡»æŒ¯åŠ¨åé¦ˆ
    VibratorUtil.vibrateTap();

    const question = this.getCurrentQuestion();
    if (!question) return;

    // å¼€å§‹åŠ¨ç”»
    this.animatingCode = code;
    this.scaleValue = 1.05;

    // åŠ¨ç”»ç»“æŸåæ£€æŸ¥ç­”æ¡ˆ
    setTimeout(() => {
      this.scaleValue = 1;
      setTimeout(async () => {
        await this.checkAnswer(code);
      }, 100);
    }, 150);
  }

  private async checkAnswer(code: string): Promise<void> {
    const question = this.getCurrentQuestion();
    if (!question) return;

    this.selectedCode = code;
    this.animatingCode = '';
    this.isCorrect = code === question.fakeCountryCode;

    if (this.isCorrect) {
      // æ’­æ”¾æ­£ç¡®ç­”æ¡ˆéŸ³æ•ˆå’ŒæŒ¯åŠ¨
      await SoundEffectUtil.playCorrect();
      VibratorUtil.vibrateCorrect();
      this.isAnswered = true;
      this.correctAnswers++;
      // æ­£ç¡®æ—¶æ˜¾ç¤ºå¯¹æ¯”å¼¹çª—ï¼ˆå»¶è¿Ÿå¼¹å‡ºï¼‰
      setTimeout(() => {
        this.showCompareDialog = true;
      }, 800);
    } else {
      // æ’­æ”¾é”™è¯¯ç­”æ¡ˆéŸ³æ•ˆå’ŒæŒ¯åŠ¨
      await SoundEffectUtil.playIncorrect();
      VibratorUtil.vibrateIncorrect();
      // é”™è¯¯æ—¶æ‰£é™¤ç”Ÿå‘½å€¼ï¼Œä½†å…è®¸ç»§ç»­é€‰æ‹©
      this.lives--;
      // çŸ­æš‚æ˜¾ç¤ºé”™è¯¯çŠ¶æ€åé‡ç½®é€‰æ‹©
      setTimeout(() => {
        this.selectedCode = '';
      }, 800);

      if (this.lives <= 0) {
        setTimeout(async () => {
          await SoundEffectUtil.playOver();
          this.showGameOver();
        }, 1000);
        return;
      }
    }
  }

  private async nextQuestion(): Promise<void> {
    // æ’­æ”¾æŒ‰é’®ç‚¹å‡»éŸ³æ•ˆå’ŒæŒ¯åŠ¨
    await SoundEffectUtil.playButton();
    VibratorUtil.vibrateTap();

    if (!this.level) return;

    this.showCompareDialog = false;

    if (this.currentIndex < this.level.questions.length - 1) {
      this.currentIndex++;
      this.selectedCode = '';
      this.isAnswered = false;
      this.isCorrect = false;
      this.animatingCode = '';
      this.scaleValue = 1;
      this.flagVisible = [false, false, false, false];
      // è§¦å‘é€‰é¡¹åŠ¨ç”»
      this.animateFlags();
    } else {
      // å®Œæˆæ‰€æœ‰é¢˜ç›®ï¼Œè§£é”ä¸‹ä¸€å…³
      await GameProgressManager.init(this.context);
      await GameProgressManager.unlockNextLevel(GameType.FAKE_FLAG, this.level.id);
      // æ’­æ”¾æ­å–œéŸ³æ•ˆå’ŒæŒ¯åŠ¨
      await SoundEffectUtil.playCongrats();
      VibratorUtil.vibrateWin();
      this.showResult = true;
    }
  }

  private showGameOver(): void {
    promptAction.showDialog({
      title: 'æŒ‘æˆ˜å¤±è´¥',
      message: `æ­£ç¡®æ‰¾å‡ºäº† ${this.correctAnswers} ä¸ªå‡æ——`,
      buttons: [
        { text: 'è¿”å›', color: '#666666' },
        { text: 'é‡æ–°å¼€å§‹', color: '#1677FF' }
      ]
    }).then((result) => {
      if (result.index === 0) {
        router.back();
      } else {
        this.restartGame();
      }
    });
  }

  private animateFlags(): void {
    // é‡ç½®æ‰€æœ‰é€‰é¡¹ä¸ºä¸å¯è§
    this.flagVisible = [false, false, false, false];
    
    // é€ä¸ªæ˜¾ç¤ºé€‰é¡¹
    for (let i = 0; i < 4; i++) {
      setTimeout(() => {
        const newVisible = [...this.flagVisible];
        newVisible[i] = true;
        this.flagVisible = newVisible;
      }, i * 100); // æ¯ä¸ªé€‰é¡¹å»¶è¿Ÿ100ms
    }
  }

  private restartGame(): void {
    this.currentIndex = 0;
    this.selectedCode = '';
    this.isAnswered = false;
    this.isCorrect = false;
    this.correctAnswers = 0;
    this.showResult = false;
    this.showCompareDialog = false;
    this.animatingCode = '';
    this.scaleValue = 1;
    this.flagVisible = [false, false, false, false];
    if (this.level) {
      this.lives = this.level.lives;
      // è§¦å‘é€‰é¡¹åŠ¨ç”»
      this.animateFlags();
    }
  }

  private getFlagSource(code: string, question: FakeFlagQuestion): string {
    // å¦‚æœè¿™æ˜¯å‡æ——ä¸”ç±»å‹æ˜¯wrongFlagï¼Œæ˜¾ç¤ºæ›¿ä»£çš„æ——å¸œ
    if (code === question.fakeCountryCode && question.fakeType === 'wrongFlag') {
      return `flags/${question.fakeFlagAssetPath}.svg`;
    }
    return `flags/${code}.svg`;
  }

  private getFlagSourceForCode(code: string): string {
    const question = this.getCurrentQuestion();
    if (question) {
      return this.getFlagSource(code, question);
    }
    return `flags/${code}.svg`;
  }

  private getFlagTransform(code: string, question: FakeFlagQuestion): TransformOptions {
    // å¦‚æœè¿™æ˜¯å‡æ——ï¼Œæ ¹æ®ç±»å‹åº”ç”¨å˜æ¢
    if (code === question.fakeCountryCode) {
      if (question.fakeType === 'flipX') {
        return { x: -1, y: 1 };
      } else if (question.fakeType === 'flipY') {
        return { x: 1, y: -1 };
      }
    }
    return { x: 1, y: 1 };
  }

  private getFlagTransformForCode(code: string): TransformOptions {
    const question = this.getCurrentQuestion();
    if (question) {
      return this.getFlagTransform(code, question);
    }
    return { x: 1, y: 1 };
  }

  private getCountryName(code: string): string {
    const country = getCountryByCode(code);
    return country?.nameCN || code.toUpperCase();
  }

  private getCardBorderColor(code: string): Resource {
    if (!this.isAnswered) {
      return $r('app.color.gray_border');
    }

    const question = this.getCurrentQuestion();
    if (!question) return $r('app.color.gray_border');

    if (code === question.fakeCountryCode) {
      return $r('app.color.color_green');
    }
    if (code === this.selectedCode && !this.isCorrect) {
      return $r('app.color.color_red');
    }
    return $r('app.color.gray_border');
  }

  private getCardBackgroundColor(code: string): Resource {
    if (!this.isAnswered) {
      return $r('app.color.bg_card');
    }

    const question = this.getCurrentQuestion();
    if (!question) return $r('app.color.bg_card');

    if (code === question.fakeCountryCode) {
      return $r('app.color.bg_green_light');
    }
    if (code === this.selectedCode && !this.isCorrect) {
      return $r('app.color.bg_red_light');
    }
    return $r('app.color.bg_card');
  }

  build() {
    Stack() {
      Navigation() {
        if (this.showResult) {
          this.ResultView()
        } else if (this.level && this.getCurrentQuestion()) {
          Column() {
            // é¡¶éƒ¨çŠ¶æ€æ 
            Row() {
              Text(`ç¬¬ ${this.level?.id} å…³`)
                .fontSize(15)
                .fontWeight(FontWeight.Medium)
                .fontColor($r('app.color.text_secondary'))
                .layoutWeight(1)

              Row() {
                ForEach(Array.from({ length: this.level?.lives || 3 }), (_: undefined, index: number) => {
                  Text(index < this.lives ? 'â¤ï¸' : 'ğŸ–¤')
                    .fontSize(14)
                    .margin({ left: 1, right: 1 })
                })
              }
              .layoutWeight(1)
                .justifyContent(FlexAlign.Center)

              Text(`${this.currentIndex + 1} / ${this.level?.questions.length}`)
                .fontSize(15)
                .fontWeight(FontWeight.Medium)
                .fontColor($r('app.color.text_secondary'))
                .layoutWeight(1)
                .textAlign(TextAlign.End)
            }
            .width('100%')
              .padding({ left: 20, right: 20, top: 12, bottom: 12 })

            // æç¤ºæ–‡å­—
            Text('æ‰¾å‡ºå‡æ——')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .margin({ top: 60, bottom: 60 })

            // 4ä¸ªå›½æ——é€‰é¡¹ - 2x2ç½‘æ ¼
            this.FlagGrid()

            Blank()
          }
          .width('100%')
            .height('100%')
            .backgroundColor($r('app.color.bg_page'))
        } else {
          Column() {
            Text('åŠ è½½ä¸­...')
              .fontSize(16)
              .fontColor($r('app.color.text_tertiary'))
          }
          .width('100%')
            .height('100%')
            .justifyContent(FlexAlign.Center)
        }
      }
      .title('')
        .titleMode(NavigationTitleMode.Mini)
        .backgroundColor($r('app.color.bg_page'))

      // å¯¹æ¯”å¼¹çª—
      if (this.showCompareDialog) {
        this.CompareDialog()
      }
    }
    .width('100%')
      .height('100%')
  }

  @Builder
  FlagGrid() {
    Grid() {
      ForEach(this.getCurrentQuestion()?.countryCodes || [], (code: string, index: number) => {
        GridItem() {
          this.FlagCard(code, index)
        }
      })
    }
    .columnsTemplate('1fr 1fr')
      .rowsTemplate('1fr 1fr')
      .columnsGap(16)
      .rowsGap(16)
      .width('100%')
      .height(340)
      .padding({ left: 20, right: 20 })
  }

  @Builder
  FlagCard(code: string, index: number) {
    Column() {
      Image($rawfile(this.getFlagSourceForCode(code)))
        .width('90%')
        .height('70%')
        .objectFit(ImageFit.Contain)
        .scale(this.getFlagTransformForCode(code))

      Text(this.getCountryName(code))
        .fontSize(13)
        .fontColor($r('app.color.text_primary'))
        .margin({ top: 8 })
        .maxLines(1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .backgroundColor(this.getCardBackgroundColor(code))
    .borderRadius(12)
    .border({
      width: 2,
      color: this.getCardBorderColor(code)
    })
    .opacity(this.flagVisible[index] ? 1 : 0)
    .scale({
      x: this.animatingCode === code ? this.scaleValue : (this.flagVisible[index] ? 1 : 0.8),
      y: this.animatingCode === code ? this.scaleValue : (this.flagVisible[index] ? 1 : 0.8)
    })
    .animation({ duration: 300, curve: Curve.EaseOut })
    .onClick(async () => {
      await this.selectFlag(code);
    })
  }

  @Builder
  CompareDialog() {
    Stack({ alignContent: Alignment.Center }) {
      // é®ç½©å±‚
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.6)')

      // å¯¹è¯æ¡†å†…å®¹
      Column() {
        // å‡æ——éƒ¨åˆ†ï¼ˆå¸¦å·¦ä¾§æµ®åŠ¨Xæ ‡è®°ï¼‰
        Stack({ alignContent: Alignment.Start }) {
          // å›½æ——å±…ä¸­
          Image($rawfile(this.getFakeFlagSource()))
            .width('100%')
            .height(100)
            .objectFit(ImageFit.Contain)
            .scale(this.getFakeFlagTransform())
            .backgroundColor($r('app.color.bg_secondary'))
            .borderRadius(8)

          // å·¦ä¾§æµ®åŠ¨Xæ ‡è®°
          Stack() {
            Column()
              .width(28)
              .height(28)
              .backgroundColor($r('app.color.color_red'))
              .borderRadius(14)
            Text('âœ—')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
          }
          .position({ x: 8, y: 36 })
        }
        .width('90%')
          .margin({ top: 20 })

        // å›½å®¶åç§°
        Text(this.getFakeCountryName())
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))
          .margin({ top: 16, bottom: 16 })

        // çœŸæ——éƒ¨åˆ†ï¼ˆå¸¦å·¦ä¾§æµ®åŠ¨âœ“æ ‡è®°ï¼‰
        Stack({ alignContent: Alignment.Start }) {
          // å›½æ——å±…ä¸­
          Image($rawfile(this.getTrueFlagSource()))
            .width('100%')
            .height(100)
            .objectFit(ImageFit.Contain)
            .backgroundColor($r('app.color.bg_secondary'))
            .borderRadius(8)

          // å·¦ä¾§æµ®åŠ¨âœ“æ ‡è®°
          Stack() {
            Column()
              .width(28)
              .height(28)
              .backgroundColor($r('app.color.color_green'))
              .borderRadius(14)
            Text('âœ“')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
          }
          .position({ x: 8, y: 36 })
        }
        .width('90%')

        // æŒ‰é’®
        Button(this.currentIndex < (this.level?.questions.length || 0) - 1 ? 'ä¸‹ä¸€é¢˜' : 'æŸ¥çœ‹ç»“æœ')
          .width('90%')
          .height(44)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .backgroundColor($r('app.color.button_primary'))
          .margin({ top: 24, bottom: 20 })
          .onClick(async () => {
            await this.nextQuestion();
          })
      }
      .width('85%')
        .constraintSize({ maxWidth: 320 })
        .backgroundColor($r('app.color.bg_card'))
        .borderRadius(20)
        .shadow({
          radius: 20,
          color: 'rgba(0, 0, 0, 0.3)',
          offsetX: 0,
          offsetY: 4
        })
    }
    .width('100%')
      .height('100%')
  }

  private getFakeFlagSource(): string {
    const question = this.getCurrentQuestion();
    if (question) {
      if (question.fakeType === 'wrongFlag' && question.fakeFlagAssetPath) {
        return `flags/${question.fakeFlagAssetPath}.svg`;
      }
      return `flags/${question.fakeCountryCode}.svg`;
    }
    return 'flags/cn.svg';
  }

  private getFakeFlagTransform(): TransformOptions {
    const question = this.getCurrentQuestion();
    if (question) {
      if (question.fakeType === 'flipX') {
        return { x: -1, y: 1 };
      } else if (question.fakeType === 'flipY') {
        return { x: 1, y: -1 };
      }
    }
    return { x: 1, y: 1 };
  }

  private getTrueFlagSource(): string {
    const question = this.getCurrentQuestion();
    if (question) {
      return `flags/${question.fakeCountryCode}.svg`;
    }
    return 'flags/cn.svg';
  }

  private getFakeCountryName(): string {
    const question = this.getCurrentQuestion();
    if (question) {
      const country = getCountryByCode(question.fakeCountryCode);
      return country?.nameCN || question.fakeCountryCode.toUpperCase();
    }
    return '';
  }

  @Builder
  ResultView() {
    Column() {
      Text('ğŸ‰')
        .fontSize(64)
        .margin({ top: 60 })

      Text('æ­å–œè¿‡å…³ï¼')
        .fontSize(28)
        .fontWeight(FontWeight.Bold)
        .fontColor($r('app.color.text_primary'))
        .margin({ top: 24 })

      Text(`ç¬¬ ${this.level?.id} å…³ Â· ${this.level?.name}`)
        .fontSize(16)
        .fontColor($r('app.color.text_secondary'))
        .margin({ top: 8 })

      Column() {
        Row() {
          Text('æ­£ç¡®æ‰¾å‡º')
            .fontSize(16)
            .fontColor($r('app.color.text_secondary'))
          Blank()
          Text(`${this.correctAnswers} / ${this.level?.questions.length}`)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.text_primary'))
        }
        .width('100%')
          .padding({ top: 16, bottom: 16 })

        Divider().color($r('app.color.gray_very_light'))

        Row() {
          Text('å‰©ä½™ç”Ÿå‘½')
            .fontSize(16)
            .fontColor($r('app.color.text_secondary'))
          Blank()
          Text(`${this.lives} â¤ï¸`)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.text_primary'))
        }
        .width('100%')
          .padding({ top: 16, bottom: 16 })
      }
      .width('100%')
        .padding({ left: 24, right: 24 })
        .margin({ top: 40 })
        .backgroundColor($r('app.color.bg_card'))
        .borderRadius(16)

      Blank()

      Button('è¿”å›å…³å¡åˆ—è¡¨')
        .width('80%')
        .height(48)
        .fontSize(17)
        .fontWeight(FontWeight.Bold)
        .backgroundColor($r('app.color.button_primary'))
        .margin({ bottom: 16 })
        .onClick(() => {
          router.back();
        })

      Button(this.level && this.level.id < getAllFakeFlagLevels().length ? 'ä¸‹ä¸€å…³' : 'å®Œç¾æ”¶å®˜')
        .width('80%')
        .height(48)
        .fontSize(17)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.button_primary'))
        .backgroundColor(Color.Transparent)
        .border({ width: 1, color: $r('app.color.button_primary') })
        .margin({ bottom: 32 })
        .onClick(async () => {
          await SoundEffectUtil.playButton();
          if (this.level && this.level.id < getAllFakeFlagLevels().length) {
            // ä¸‹ä¸€å…³ - åœ¨å½“å‰é¡µé¢é‡æ–°åŠ è½½æ•°æ®
            await GameProgressManager.init(this.context);
            await GameProgressManager.unlockNextLevel(GameType.FAKE_FLAG, this.level.id);
            this.loadLevel(this.level.id + 1);
          } else {
            // å®Œç¾æ”¶å®˜ï¼Œé€€å‡º
            router.back();
          }
        })
    }
    .width('100%')
      .height('100%')
      .padding({ left: 16, right: 16 })
      .backgroundColor($r('app.color.bg_page'))
  }
}

interface TransformOptions {
  x: number;
  y: number;
}

