import router from '@ohos.router';
import common from '@ohos.app.ability.common';
import promptAction from '@ohos.promptAction';
import { systemShare } from '@kit.ShareKit';
import { uniformTypeDescriptor } from '@kit.ArkData';
import { BusinessError } from '@kit.BasicServicesKit';
import { image } from '@kit.ImageKit';
import fs from '@ohos.file.fs';
import { fileUri } from '@kit.CoreFileKit';
import { Country, getCountryByCode, FlagDesign, getFlagDesign, getFlagImageSource, InternationalOrg, getInternationalOrgByCode, isInternationalOrg } from '../../utils/countryData';
import { TextReaderUtil } from '../../utils/TextReaderUtil';
import { screenshotManager } from '../../utils/ScreenshotManager';
import { SaveFlagDialog } from '../../components/SaveFlagDialog';
import { FavoritesManager } from '../../utils/favoritesManager';
import { getCoatOfArmsImageSource } from '../../utils/coatOfArmsUtil';
import { getFlagHistory, FlagHistoryItem } from '../../utils/FlagHistoryData';

interface RouterParams {
  countryCode: string;
}

@Entry
@Component
  struct FlagDetailPage {
  @State country: Country | undefined = undefined;
  @State internationalOrg: InternationalOrg | undefined = undefined;
  @State flagDesign: FlagDesign | undefined = undefined;
  @State isReading: boolean = false;
  @State isSharing: boolean = false;
  @State flagPixelMap: image.PixelMap | null = null;
  @State isFavorite: boolean = false;
  @State coatOfArmsResource: Resource | null = null;
  @State flagHistoryItems: FlagHistoryItem[] = [];
  @State sharePixelMap: image.PixelMap | null = null;
  private context = getContext(this) as common.UIAbilityContext;
  private readonly FLAG_CONTAINER_ID = 'flagImageContainer';
  private readonly FLAG_DOWNLOAD_CONTAINER_ID = 'flagDownloadContainer';
  private readonly SHARE_CONTAINER_ID = 'flagShareContainer';
  private countryCode: string = '';

  // ä¿å­˜å¯¹è¯æ¡†æ§åˆ¶å™¨
  private saveDialogController: CustomDialogController = new CustomDialogController({
    builder: SaveFlagDialog({
      pixelMap: this.flagPixelMap,
      onClose: () => {
        this.releaseFlagPixelMap();
      },
      onSaveSuccess: () => {
        promptAction.showToast({
          message: 'å›½æ——å›¾ç‰‡å·²ä¿å­˜åˆ°ç›¸å†Œ',
          duration: 2000
        });
        this.releaseFlagPixelMap();
      },
      onSaveError: (error: Error) => {
        promptAction.showToast({
          message: `ä¿å­˜å¤±è´¥: ${error.message}`,
          duration: 2000
        });
        this.releaseFlagPixelMap();
      },
      saveScreenshot: async () => {
        await this.doSaveFlag();
      }
    }),
    autoCancel: false,
    customStyle: true
  });

  async aboutToAppear() {
    const params = router.getParams() as RouterParams;
    if (params && params.countryCode) {
      this.countryCode = params.countryCode;
      if (isInternationalOrg(params.countryCode)) {
        this.internationalOrg = getInternationalOrgByCode(params.countryCode);
      } else {
        this.country = getCountryByCode(params.countryCode);
        this.flagDesign = getFlagDesign(params.countryCode);
        // åŠ è½½å†å²å›½æ——æ•°æ®ï¼ˆä»…å›½å®¶ï¼Œä¸åŒ…æ‹¬å›½é™…ç»„ç»‡ï¼‰
        this.flagHistoryItems = getFlagHistory(this.countryCode);
      }
    }

    // åˆå§‹åŒ– TextReader
    try {
      await TextReaderUtil.init(this.context);
      TextReaderUtil.setEventListener();
      TextReaderUtil.setActionListener();
    } catch (err) {
      console.error(`Failed to init TextReader: ${JSON.stringify(err)}`);
    }

    // åˆå§‹åŒ–æˆªå›¾ç®¡ç†å™¨
    screenshotManager.init(this.getUIContext());

    // åˆå§‹åŒ–æ”¶è—ç®¡ç†å™¨å¹¶æ£€æŸ¥æ”¶è—çŠ¶æ€
    await FavoritesManager.init(this.context);
    await this.checkFavoriteStatus();

    // åŠ è½½å›½å¾½ï¼ˆä»…å›½å®¶ï¼Œä¸åŒ…æ‹¬å›½é™…ç»„ç»‡ï¼‰
    if (this.country) {
      this.loadCoatOfArms();
    }
  }

  /**
   * åŠ è½½å›½å¾½
   */
  private loadCoatOfArms(): void {
    if (!this.country) return;

    // ä»mediaæ–‡ä»¶å¤¹åŠ è½½é¢„ä¸‹è½½çš„å›½å¾½
    const resource = getCoatOfArmsImageSource(this.country.code);
    if (resource) {
      this.coatOfArmsResource = resource;
    }
  }

  private async checkFavoriteStatus(): Promise<void> {
    const pageUrl = `flag:${this.countryCode}`;
    this.isFavorite = await FavoritesManager.isFavorite(pageUrl);
  }

  private async toggleFavorite(): Promise<void> {
    const name = this.internationalOrg?.nameCN || this.country?.nameCN || 'æœªçŸ¥';
    const pageUrl = `flag:${this.countryCode}`;

    if (this.isFavorite) {
      await FavoritesManager.removeFavorite(pageUrl);
      this.isFavorite = false;
      promptAction.showToast({
        message: 'å·²å–æ¶ˆæ”¶è—',
        duration: 2000
      });
    } else {
      await FavoritesManager.addFavorite({ name: name, pageUrl: pageUrl });
      this.isFavorite = true;
      promptAction.showToast({
        message: 'å·²æ·»åŠ åˆ°æ”¶è—',
        duration: 2000
      });
    }
  }

  private releaseFlagPixelMap(): void {
    if (this.flagPixelMap) {
      try {
        this.flagPixelMap.release();
      } catch (e) {
        console.warn('[FlagDetailPage] Failed to release pixelmap:', e);
      }
      this.flagPixelMap = null;
    }
  }

  private releaseSharePixelMap(): void {
    if (this.sharePixelMap) {
      try {
        this.sharePixelMap.release();
      } catch (e) {
        console.warn('[FlagDetailPage] Failed to release share pixelmap:', e);
      }
      this.sharePixelMap = null;
    }
  }

  private async onDownloadClick(): Promise<void> {
    if (!this.country && !this.internationalOrg) return;

    try {
      promptAction.showToast({
        message: 'æ­£åœ¨å‡†å¤‡å›¾ç‰‡...',
        duration: 1000
      });

      // å…ˆé‡Šæ”¾ä¹‹å‰çš„ PixelMapï¼Œé¿å…å†…å­˜æ³„æ¼
      this.releaseFlagPixelMap();

      // å¦‚æœå·²æœ‰å¯¹è¯æ¡†æ‰“å¼€ï¼Œå…ˆå…³é—­å¹¶é‡Šæ”¾èµ„æº
      if (this.saveDialogController) {
        try {
          this.saveDialogController.close();
        } catch (e) {
          console.warn('[FlagDetailPage] Failed to close existing dialog:', e);
        }
      }

      // æˆªå–å›½æ——å®¹å™¨å¿«ç…§
      const pixmap = await screenshotManager.captureSnapshot(this.FLAG_CONTAINER_ID);
      if (!pixmap) {
        promptAction.showToast({
          message: 'æˆªå–å›¾ç‰‡å¤±è´¥',
          duration: 2000
        });
        return;
      }

      this.flagPixelMap = pixmap;

      // æ›´æ–°å¯¹è¯æ¡†å¹¶æ˜¾ç¤º
      this.saveDialogController = new CustomDialogController({
        builder: SaveFlagDialog({
          pixelMap: this.flagPixelMap,
          onClose: () => {
            this.releaseFlagPixelMap();
          },
          onSaveSuccess: () => {
            promptAction.showToast({
              message: 'å›½æ——å›¾ç‰‡å·²ä¿å­˜åˆ°ç›¸å†Œ',
              duration: 2000
            });
          },
          onSaveError: (error: Error) => {
            promptAction.showToast({
              message: `ä¿å­˜å¤±è´¥: ${error.message}`,
              duration: 2000
            });
            this.releaseFlagPixelMap();
          },
          saveScreenshot: async () => {
            await this.doSaveFlag();
          }
        }),
        autoCancel: false,
        customStyle: true
      });

      this.saveDialogController.open();
    } catch (error) {
      console.error('[FlagDetailPage] Download error:', error);
      promptAction.showToast({
        message: 'ä¸‹è½½å¤±è´¥',
        duration: 2000
      });
    }
  }

  private async doSaveFlag(): Promise<void> {
    if (!this.flagPixelMap || (!this.country && !this.internationalOrg)) {
      throw new Error('å›¾ç‰‡æˆ–ç»„ç»‡ä¿¡æ¯ä¸å­˜åœ¨');
    }

    const name = this.internationalOrg?.nameCN || this.country?.nameCN || 'æœªçŸ¥';
    const fileName = screenshotManager.generateFileName('æ——å¸œ', name);
    const success = await screenshotManager.saveToGallery(
      this.flagPixelMap,
      fileName,
      this.context,
      false // ä¸è‡ªåŠ¨é‡Šæ”¾ï¼Œç”±å¯¹è¯æ¡†ç®¡ç†
    );

    if (!success) {
      throw new Error('ä¿å­˜åˆ°ç›¸å†Œå¤±è´¥');
    }
  }

  aboutToDisappear() {
    // é¡µé¢é”€æ¯æ—¶åœæ­¢æœ—è¯»
    if (this.isReading) {
      TextReaderUtil.stopRead();
      this.isReading = false;
    }
    // é¡µé¢é”€æ¯æ—¶é‡Šæ”¾ PixelMapï¼Œé¿å…å†…å­˜æ³„æ¼
    this.releaseFlagPixelMap();
    this.releaseSharePixelMap();
  }

  @Builder
  buildInternationalOrgPage() {
    if (this.internationalOrg) {
      Scroll() {
        Column() {
          // éšè—çš„åˆ†äº«å®¹å™¨ï¼ˆåŒ…å«æ——å¸œå’ŒåŸºæœ¬ä¿¡æ¯ï¼‰
          Column() {
            if (this.internationalOrg) {
              this.ShareContentBuilder()
            }
          }
          .id(this.SHARE_CONTAINER_ID)
          .position({ x: -1000, y: -1000 })
          .width(400)
          .backgroundColor($r('app.color.bg_page'))

          // éšè—çš„ä¸‹è½½å®¹å™¨ï¼ˆæ—  paddingï¼Œä»…ç”¨äºæˆªå›¾ï¼‰
          Column() {
            Image(getFlagImageSource(this.internationalOrg.code))
              .width('100%')
              .height(200)
              .objectFit(ImageFit.Contain)
          }
          .width(400)
            .height(200)
            .backgroundColor(Color.White)
            .id(this.FLAG_DOWNLOAD_CONTAINER_ID)
            .position({ x: -1000, y: -1000 })

          // æ——å¸œå›¾ç‰‡ï¼ˆå±•ç¤ºç”¨ï¼Œæœ‰ paddingï¼‰
          Column() {
            Image(getFlagImageSource(this.internationalOrg.code))
              .width('100%')
              .height(200)
              .objectFit(ImageFit.Contain)
          }
          .width('100%')
            .padding(16)
            .id(this.FLAG_CONTAINER_ID)

          // ç»„ç»‡åç§°
          Column() {
            Text(this.internationalOrg.nameCN)
              .fontSize(28)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .textAlign(TextAlign.Center)
              .maxLines(2)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .margin({ bottom: 4 })

            Text(this.internationalOrg.name)
              .fontSize(16)
              .fontColor($r('app.color.text_secondary'))
              .textAlign(TextAlign.Center)
              .maxLines(2)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
          }
          .width('100%')
            .padding({ left: 16, right: 16, top: 20, bottom: 16 })
            .alignItems(HorizontalAlign.Center)

          // åŸºæœ¬ä¿¡æ¯å¡ç‰‡
          Row() {
            Column() {
              Text('åŸºæœ¬ä¿¡æ¯')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.text_primary'))
                .margin({ bottom: 16 })
                .alignSelf(ItemAlign.Start)

              this.InfoItem('æ€»éƒ¨', this.internationalOrg.headquartersCN)
              Divider().color($r('app.color.gray_very_light')).margin({ top: 12, bottom: 12 })
              this.InfoItem('åœ°åŒº', this.internationalOrg.region)
              Divider().color($r('app.color.gray_very_light')).margin({ top: 12, bottom: 12 })
              this.InfoItem('ç»„ç»‡ç±»å‹', this.internationalOrg.orgTypeCN)
              Divider().color($r('app.color.gray_very_light')).margin({ top: 12, bottom: 12 })
              this.InfoItem('è¦†ç›–äººå£', this.formatPopulation(this.internationalOrg.population))
              if (this.internationalOrg.website) {
                Divider().color($r('app.color.gray_very_light')).margin({ top: 12, bottom: 12 })
                this.InfoItem('ç½‘ç«™', this.internationalOrg.website)
              }
              if (this.internationalOrg.description) {
                Divider().color($r('app.color.gray_very_light')).margin({ top: 12, bottom: 12 })
                this.DescriptionItem('ç®€ä»‹', this.internationalOrg.description)
              }
            }
          .padding(16)
              .layoutWeight(1)
              .backgroundColor($r('app.color.bg_card'))
              .borderRadius(16)
          }
          .width('100%')
            .padding({ left: 16, right: 16 })
            .margin({ top: 8 })

          // åº•éƒ¨æ“ä½œæŒ‰é’®
          Row({ space: 16 }) {
            // æ”¶è—æŒ‰é’®
            Button() {
              Row({ space: 8 }) {
                Image(this.isFavorite ? $r('app.media.icon_favorite_selected') : $r('app.media.icon_favorite'))
                  .width(20)
                  .height(20)
                Text(this.isFavorite ? 'å·²æ”¶è—' : 'æ”¶è—')
                  .fontSize(15)
                  .fontColor(this.isFavorite ? $r('app.color.button_primary') : $r('app.color.text_primary'))
              }
            }
          .layoutWeight(1)
              .height(48)
              .backgroundColor($r('app.color.bg_card'))
              .borderRadius(12)
              .onClick(() => {
                this.toggleFavorite();
              })

            // ä¸‹è½½æŒ‰é’®
            Button() {
              Row({ space: 8 }) {
                Image($r('app.media.icon_download'))
                  .width(20)
                  .height(20)
                Text('ä¸‹è½½')
                  .fontSize(15)
                  .fontColor($r('app.color.text_primary'))
              }
            }
          .layoutWeight(1)
              .height(48)
              .backgroundColor($r('app.color.bg_card'))
              .borderRadius(12)
              .onClick(() => {
                this.onDownloadClick();
              })
          }
          .width('100%')
            .padding({ left: 16, right: 16 })
            .margin({ top: 20, bottom: 24 })
        }
        .width('100%')
      }
      .width('100%')
        .height('100%')
        .scrollBar(BarState.Off)
        .edgeEffect(EdgeEffect.Spring)
        .backgroundColor($r('app.color.bg_page'))
    }
  }

  build() {
    Navigation() {
      if (this.internationalOrg) {
        this.buildInternationalOrgPage()
      } else if (this.country) {
        Scroll() {
          Column() {
            // éšè—çš„åˆ†äº«å®¹å™¨ï¼ˆåŒ…å«å›½æ——å’ŒåŸºæœ¬ä¿¡æ¯ï¼‰
            Column() {
              if (this.country) {
                this.ShareContentBuilder()
              }
            }
            .id(this.SHARE_CONTAINER_ID)
            .position({ x: -1000, y: -1000 })
            .width(400)
            .backgroundColor($r('app.color.bg_page'))

            // éšè—çš„ä¸‹è½½å®¹å™¨ï¼ˆæ—  paddingï¼Œä»…ç”¨äºæˆªå›¾ï¼‰
            Column() {
              Image(getFlagImageSource(this.country.code))
                .width('100%')
                .height(200)
                .objectFit(ImageFit.Contain)
            }
            .width(400)
              .height(200)
              .backgroundColor(Color.White)
              .id(this.FLAG_DOWNLOAD_CONTAINER_ID)
              .position({ x: -1000, y: -1000 })

            // å›½æ——å›¾ç‰‡ï¼ˆå±•ç¤ºç”¨ï¼Œæœ‰ paddingï¼‰
            Column() {
              Image(getFlagImageSource(this.country.code))
                .width('100%')
                .height(200)
                .objectFit(ImageFit.Contain)
            }
            .width('100%')
              .padding(16)
              .id(this.FLAG_CONTAINER_ID)

            // å›½å®¶åç§°
            Column() {
              Text(this.country.nameCN)
                .fontSize(28)
                .fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.text_primary'))
                .textAlign(TextAlign.Center)
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .margin({ bottom: 4 })

              Text(this.country.name)
                .fontSize(16)
                .fontColor($r('app.color.text_secondary'))
                .textAlign(TextAlign.Center)
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
            }
            .width('100%')
              .padding({ left: 16, right: 16, top: 20, bottom: 16 })
              .alignItems(HorizontalAlign.Center)

            // åŸºæœ¬ä¿¡æ¯å¡ç‰‡
            Row() {
              Column() {
                Text('åŸºæœ¬ä¿¡æ¯')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.text_primary'))
                  .margin({ bottom: 16 })
                  .alignSelf(ItemAlign.Start)

                this.InfoItem('é¦–éƒ½', this.country.capitalCN)
                Divider().color($r('app.color.gray_very_light')).margin({ top: 12, bottom: 12 })
                this.InfoItem('æ‰€å±åœ°åŒº', this.getRegionName(this.country.region))
                Divider().color($r('app.color.gray_very_light')).margin({ top: 12, bottom: 12 })
                this.InfoItem('äººå£', this.formatPopulation(this.country.population))
                Divider().color($r('app.color.gray_very_light')).margin({ top: 12, bottom: 12 })
                this.InfoItem('é¢ç§¯', this.formatArea(this.country.area))
                Divider().color($r('app.color.gray_very_light')).margin({ top: 12, bottom: 12 })
                this.InfoItem('å›½å®¶ä»£ç ', this.country.code.toUpperCase())
              }
              .padding(16)
                .layoutWeight(1)
                .backgroundColor($r('app.color.bg_card'))
                .borderRadius(16)
            }
            .width('100%')
              .padding({ left: 16, right: 16 })
              .margin({ top: 8 })

            // å…³äºè¿™é¢å›½æ——
            Row() {
              Column() {
                Text('å…³äºè¿™é¢å›½æ——')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.text_primary'))
                  .margin({ bottom: 16 })
                  .alignSelf(ItemAlign.Start)

                this.InfoItem('å›½æ——æ¯”ä¾‹', this.getFlagProportion())
                Divider().color($r('app.color.gray_very_light')).margin({ top: 12, bottom: 12 })
                this.InfoItem('é‡‡ç”¨æ—¥æœŸ', this.getFlagAdopted())
                Divider().color($r('app.color.gray_very_light')).margin({ top: 12, bottom: 16 })

                Text(this.getFlagDescription())
                  .fontSize(14)
                  .fontColor($r('app.color.text_dark'))
                  .lineHeight(22)
                  .width('100%')
                  .textAlign(TextAlign.Start)
              }
              .padding(16)
                .layoutWeight(1)
                .backgroundColor($r('app.color.bg_card'))
                .borderRadius(16)
                .alignItems(HorizontalAlign.Start)
            }
            .width('100%')
              .padding({ left: 16, right: 16 })
              .margin({ top: 16 })

            // å†å²å›½æ——bannerï¼ˆå¦‚æœæœ‰å†å²æ•°æ®ä¸”æ˜¯å›½å®¶ï¼Œæ˜¾ç¤ºåœ¨å›½å¾½å‰é¢ï¼‰
            if (this.country && this.flagHistoryItems && this.flagHistoryItems.length > 0) {
              this.HistoricalFlagsBanner()
            }

            // å›½å¾½ï¼ˆå¦‚æœæœ‰ï¼‰
            if (this.coatOfArmsResource) {
              Row() {
                Column() {
                  Text('å›½å¾½')
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor($r('app.color.text_primary'))
                    .margin({ bottom: 16 })
                    .alignSelf(ItemAlign.Start)

                  Column() {
                    Image(this.coatOfArmsResource)
                      .width(200)
                      .height(200)
                      .objectFit(ImageFit.Contain)
                  }
                  .width('100%')
                    .alignItems(HorizontalAlign.Center)
                }
                .padding(16)
                  .layoutWeight(1)
                  .backgroundColor($r('app.color.bg_card'))
                  .borderRadius(16)
                  .alignItems(HorizontalAlign.Start)
              }
              .width('100%')
                .padding({ left: 16, right: 16 })
                .margin({ top: 16 })
            }

            // åº•éƒ¨æ“ä½œæŒ‰é’®
            Row({ space: 16 }) {
              // æ”¶è—æŒ‰é’®
              Button() {
                Row({ space: 8 }) {
                  Image(this.isFavorite ? $r('app.media.icon_favorite_selected') : $r('app.media.icon_favorite'))
                    .width(20)
                    .height(20)
                  Text(this.isFavorite ? 'å·²æ”¶è—' : 'æ”¶è—')
                    .fontSize(15)
                    .fontColor(this.isFavorite ? $r('app.color.button_primary') : $r('app.color.text_primary'))
                }
              }
              .layoutWeight(1)
                .height(48)
                .backgroundColor($r('app.color.bg_card'))
                .borderRadius(12)
                .onClick(() => {
                  this.toggleFavorite();
                })

              // ä¸‹è½½æŒ‰é’®
              Button() {
                Row({ space: 8 }) {
                  Image($r('app.media.icon_download'))
                    .width(20)
                    .height(20)
                  Text('ä¸‹è½½')
                    .fontSize(15)
                    .fontColor($r('app.color.text_primary'))
                }
              }
              .layoutWeight(1)
                .height(48)
                .backgroundColor($r('app.color.bg_card'))
                .borderRadius(12)
                .onClick(() => {
                  this.onDownloadClick();
                })
            }
            .width('100%')
              .padding({ left: 16, right: 16 })
              .margin({ top: 20, bottom: 24 })
          }
          .width('100%')
        }
        .width('100%')
          .height('100%')
          .scrollBar(BarState.Off)
          .edgeEffect(EdgeEffect.Spring)
          .backgroundColor($r('app.color.bg_page'))
      } else {
        Column() {
          Text('å›½å®¶ä¿¡æ¯åŠ è½½å¤±è´¥')
            .fontSize(16)
            .fontColor($r('app.color.text_tertiary'))
        }
        .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
      }
    }
    .titleMode(NavigationTitleMode.Mini)
      .backgroundColor($r('app.color.bg_page'))
      .menus(this.MenuBuilder)
  }

  @Builder
  MenuBuilder() {
    Row({ space: 20 }) {
      Image($r('app.media.icon_voice'))
        .width(24)
        .height(24)
        .onClick(() => {
          this.onReadClick();
        })

      Image($r('app.media.icon_share'))
        .width(22)
        .height(22)
        .onClick(() => {
          this.onShareClick();
        })
    }
    .height('100%')
      .justifyContent(FlexAlign.End)
      .alignItems(VerticalAlign.Center)
      .padding({ right: 16 })
  }

  @Builder
  DescriptionItem(label: string, value: string) {
    Column() {
      Text(label)
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_secondary'))
        .margin({ bottom: 8 })
        .alignSelf(ItemAlign.Start)
      Text(value)
        .fontSize(15)
        .fontColor($r('app.color.text_primary'))
        .lineHeight(22)
        .alignSelf(ItemAlign.Start)
    }
    .width('100%')
      .alignItems(HorizontalAlign.Start)
  }

  @Builder
  InfoItem(label: string, value: string) {
    Row() {
      Text(label)
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
      Blank()
      Text(value)
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
    }
    .width('100%')
  }

  private getRegionName(region: string): string {
    const regionMap: Record<string, string> = {
      'Asia': 'äºšæ´²',
      'Europe': 'æ¬§æ´²',
      'Africa': 'éæ´²',
      'Americas': 'ç¾æ´²',
      'Oceania': 'å¤§æ´‹æ´²'
    };
    return regionMap[region] || region;
  }

  private formatPopulation(population: number): string {
    if (population >= 100000000) {
      return (population / 100000000).toFixed(2) + ' äº¿äºº';
    } else if (population >= 10000) {
      return (population / 10000).toFixed(0) + ' ä¸‡äºº';
    }
    return population.toString() + ' äºº';
  }

  private formatArea(area: number): string {
    if (area >= 10000) {
      return (area / 10000).toFixed(2) + ' ä¸‡å¹³æ–¹å…¬é‡Œ';
    }
    return area.toFixed(0) + ' å¹³æ–¹å…¬é‡Œ';
  }

  private getFlagDescription(): string {
    if (!this.country) {
      return '';
    }

    // ä½¿ç”¨ flagDesign ä¸­çš„ä¸­æ–‡æè¿°
    if (this.flagDesign && this.flagDesign.designCN) {
      return this.flagDesign.designCN;
    }

    return `${this.country.nameCN}çš„å›½æ——æ˜¯è¿™ä¸ªå›½å®¶çš„é‡è¦è±¡å¾ï¼Œä»£è¡¨ç€å›½å®¶çš„å†å²ã€æ–‡åŒ–å’Œä»·å€¼è§‚ã€‚`;
  }

  private getFlagProportion(): string {
    if (this.flagDesign && this.flagDesign.proportion) {
      return this.flagDesign.proportion;
    }
    return 'æœªçŸ¥';
  }

  private getFlagAdopted(): string {
    if (this.flagDesign && this.flagDesign.adopted) {
      return this.flagDesign.adopted;
    }
    return 'æœªçŸ¥';
  }

  private getReadContent(): string {
    const lines: string[] = [];

    if (this.internationalOrg) {
      lines.push(`${this.internationalOrg.nameCN}ï¼Œè‹±æ–‡å${this.internationalOrg.name}ã€‚`);
      lines.push(`æ€»éƒ¨ä½äº${this.internationalOrg.headquartersCN}ã€‚`);
      lines.push(`åœ°åŒºæ˜¯${this.internationalOrg.region}ã€‚`);
      lines.push(`ç»„ç»‡ç±»å‹æ˜¯${this.internationalOrg.orgTypeCN}ã€‚`);
      lines.push(`è¦†ç›–äººå£çº¦${this.formatPopulation(this.internationalOrg.population)}ã€‚`);
      if (this.internationalOrg.website) {
        lines.push(`ç½‘ç«™ï¼š${this.internationalOrg.website}ã€‚`);
      }
      if (this.internationalOrg.description) {
        lines.push(`${this.internationalOrg.description}`);
      }
    } else if (this.country) {
      lines.push(`${this.country.nameCN}ï¼Œè‹±æ–‡å${this.country.name}ã€‚`);
      lines.push(`é¦–éƒ½æ˜¯${this.country.capitalCN}ã€‚`);
      lines.push(`æ‰€å±åœ°åŒºæ˜¯${this.getRegionName(this.country.region)}ã€‚`);
      lines.push(`äººå£${this.formatPopulation(this.country.population)}ã€‚`);
      lines.push(`é¢ç§¯${this.formatArea(this.country.area)}ã€‚`);
      lines.push(`å›½æ——æ¯”ä¾‹ä¸º${this.getFlagProportion()}ã€‚`);
      lines.push(`é‡‡ç”¨æ—¥æœŸæ˜¯${this.getFlagAdopted()}ã€‚`);
      lines.push(this.getFlagDescription());
    } else {
      return '';
    }

    return lines.join('');
  }

  private async onReadClick(): Promise<void> {
    if (this.isReading) {
      TextReaderUtil.stopRead();
      this.isReading = false;
      promptAction.showToast({
        message: 'å·²åœæ­¢æœ—è¯»',
        duration: 2000
      });
    } else {
      try {
        const title = this.internationalOrg?.nameCN || this.country?.nameCN || 'è¯¦æƒ…';
        const content = this.getReadContent();
        await TextReaderUtil.startRead(this.context, title, content);
        this.isReading = true;
        promptAction.showToast({
          message: 'å¼€å§‹æœ—è¯»',
          duration: 2000
        });
      } catch (err) {
        console.error(`Failed to start read: ${JSON.stringify(err)}`);
        promptAction.showToast({
          message: 'æœ—è¯»åŠŸèƒ½æš‚ä¸å¯ç”¨',
          duration: 2000
        });
      }
    }
  }

  private async onShareClick(): Promise<void> {
    if (this.isSharing || (!this.country && !this.internationalOrg)) return;

    this.isSharing = true;
    promptAction.showToast({
      message: 'æ­£åœ¨å‡†å¤‡åˆ†äº«...',
      duration: 1500
    });

    let tempFilePath: string | null = null;

    try {
      // å…ˆé‡Šæ”¾ä¹‹å‰çš„ PixelMap
      this.releaseSharePixelMap();

      // æˆªå–åˆ†äº«å®¹å™¨å†…å®¹
      const pixmap = await screenshotManager.captureSnapshot(this.SHARE_CONTAINER_ID);
      if (!pixmap) {
        promptAction.showToast({
          message: 'æˆªå–å›¾ç‰‡å¤±è´¥',
          duration: 2000
        });
        this.isSharing = false;
        return;
      }

      this.sharePixelMap = pixmap;

      // åˆ›å»ºå›¾åƒæ‰“åŒ…å™¨å¹¶æ‰“åŒ…ä¸º ArrayBuffer
      const imagePacker = image.createImagePacker();
      const packOpts: image.PackingOption = {
        format: 'image/jpeg',
        quality: 90
      };

      const imageData: ArrayBuffer = await imagePacker.packing(pixmap, packOpts);

      // ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶
      const timestamp = Date.now();
      tempFilePath = this.context.cacheDir + '/share_flag_detail_' + timestamp + '.jpg';

      // ä½¿ç”¨åŒæ­¥æ–‡ä»¶æ“ä½œ
      const fileHandle = fs.openSync(tempFilePath, fs.OpenMode.CREATE | fs.OpenMode.WRITE_ONLY);
      fs.writeSync(fileHandle.fd, imageData);
      fs.closeSync(fileHandle);

      // éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºç©º
      const stat = fs.statSync(tempFilePath);
      if (stat.size === 0) {
        throw new Error('Image file is empty');
      }

      // è·å–æ–‡ä»¶URI
      const imageUri = fileUri.getUriFromPath(tempFilePath);

      // è·å–å›¾ç‰‡ç±»å‹æè¿°ç¬¦
      const utdTypeId = uniformTypeDescriptor.getUniformDataTypeByFilenameExtension('.jpg', uniformTypeDescriptor.UniformDataType.IMAGE);

      // ä½¿ç”¨å›¾ç‰‡URIåˆ†äº«
      const orgName = this.internationalOrg?.nameCN || this.country?.nameCN || 'è¯¦æƒ…';
      const shareData = new systemShare.SharedData({
        utd: utdTypeId,
        uri: imageUri,
        title: `${orgName}${this.internationalOrg ? 'æ——å¸œ' : 'å›½æ——'}`,
        description: 'æ¥è‡ªå›½æ——å°ç™¾ç§‘'
      });

      const controller = new systemShare.ShareController(shareData);

      // æ˜¾ç¤ºåˆ†äº«é¢æ¿
      await controller.show(this.context, {
        selectionMode: systemShare.SelectionMode.SINGLE,
        previewMode: systemShare.SharePreviewMode.DETAIL
      });

      // åˆ†äº«æˆåŠŸåé‡Šæ”¾ PixelMap
      this.releaseSharePixelMap();

      // å»¶è¿Ÿåˆ é™¤æ–‡ä»¶ï¼Œç¡®ä¿åˆ†äº«å®Œæˆ
      setTimeout(() => {
        if (tempFilePath) {
          try {
            fs.unlinkSync(tempFilePath);
          } catch (unlinkError) {
            console.warn('[FlagDetailPage] Failed to delete temp file:', unlinkError);
          }
        }
      }, 5000);

    } catch (err) {
      const error = err as BusinessError;
      console.error(`Failed to share: code: ${error?.code}, message: ${error?.message}`);
      promptAction.showToast({
        message: 'åˆ†äº«å¤±è´¥',
        duration: 2000
      });

      // æ¸…ç†èµ„æº
      this.releaseSharePixelMap();
      if (tempFilePath) {
        try {
          fs.unlinkSync(tempFilePath);
        } catch (e) {
          // ignore
        }
      }
    } finally {
      this.isSharing = false;
    }
  }

  private buildShareText(): string {
    const lines: string[] = [];

    if (this.internationalOrg) {
      lines.push(`ğŸ³ï¸ ${this.internationalOrg.nameCN} (${this.internationalOrg.name})`);
      lines.push('');
      lines.push(`ğŸ“ æ€»éƒ¨ï¼š${this.internationalOrg.headquartersCN}`);
      lines.push(`ğŸŒ åœ°åŒºï¼š${this.internationalOrg.region}`);
      lines.push(`ğŸ›ï¸ ç»„ç»‡ç±»å‹ï¼š${this.internationalOrg.orgTypeCN}`);
      lines.push(`ğŸ‘¥ è¦†ç›–äººå£ï¼š${this.formatPopulation(this.internationalOrg.population)}`);
      if (this.internationalOrg.website) {
        lines.push(`ğŸŒ ç½‘ç«™ï¼š${this.internationalOrg.website}`);
      }
      if (this.internationalOrg.description) {
        lines.push('');
        lines.push(`ğŸ“ ç®€ä»‹ï¼š${this.internationalOrg.description}`);
      }
    } else if (this.country) {
      lines.push(`ğŸ³ï¸ ${this.country.nameCN} (${this.country.name})`);
      lines.push('');
      lines.push(`ğŸ“ é¦–éƒ½ï¼š${this.country.capitalCN}`);
      lines.push(`ğŸŒ åœ°åŒºï¼š${this.getRegionName(this.country.region)}`);
      lines.push(`ğŸ‘¥ äººå£ï¼š${this.formatPopulation(this.country.population)}`);
      lines.push(`ğŸ“ é¢ç§¯ï¼š${this.formatArea(this.country.area)}`);

      if (this.flagDesign) {
        lines.push('');
        lines.push(`ğŸ“ å›½æ——æ¯”ä¾‹ï¼š${this.flagDesign.proportion}`);
        lines.push(`ğŸ“… é‡‡ç”¨æ—¥æœŸï¼š${this.flagDesign.adopted}`);
        if (this.flagDesign.designCN) {
          lines.push('');
          lines.push(`ğŸ¨ ${this.flagDesign.designCN}`);
        }
      }
    } else {
      return '';
    }

    lines.push('');
    lines.push('â€”â€” æ¥è‡ªã€Œå›½æ——å°ç™¾ç§‘ã€');

    return lines.join('\n');
  }

  @Builder
  ShareContentBuilder() {
    if (this.internationalOrg) {
      // å›½é™…ç»„ç»‡åˆ†äº«å†…å®¹
      Column({ space: 16 }) {
        // æ——å¸œå›¾ç‰‡
        Column() {
          Image(getFlagImageSource(this.internationalOrg.code))
            .width('100%')
            .height(200)
            .objectFit(ImageFit.Contain)
        }
        .width('100%')
          .padding(16)
          .backgroundColor($r('app.color.bg_page'))

        // ç»„ç»‡åç§°
        Column() {
          Text(this.internationalOrg.nameCN)
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.text_primary'))
            .textAlign(TextAlign.Center)
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ bottom: 4 })

          Text(this.internationalOrg.name)
            .fontSize(16)
            .fontColor($r('app.color.text_secondary'))
            .textAlign(TextAlign.Center)
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .width('100%')
          .padding({ left: 16, right: 16, top: 20, bottom: 16 })
          .alignItems(HorizontalAlign.Center)

        // åŸºæœ¬ä¿¡æ¯å¡ç‰‡
        Row() {
          Column() {
            Text('åŸºæœ¬ä¿¡æ¯')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .margin({ bottom: 16 })
              .alignSelf(ItemAlign.Start)

            this.InfoItem('æ€»éƒ¨', this.internationalOrg.headquartersCN)
            Divider().color($r('app.color.gray_very_light')).margin({ top: 12, bottom: 12 })
            this.InfoItem('åœ°åŒº', this.internationalOrg.region)
            Divider().color($r('app.color.gray_very_light')).margin({ top: 12, bottom: 12 })
            this.InfoItem('ç»„ç»‡ç±»å‹', this.internationalOrg.orgTypeCN)
            Divider().color($r('app.color.gray_very_light')).margin({ top: 12, bottom: 12 })
            this.InfoItem('è¦†ç›–äººå£', this.formatPopulation(this.internationalOrg.population))
            if (this.internationalOrg.website) {
              Divider().color($r('app.color.gray_very_light')).margin({ top: 12, bottom: 12 })
              this.InfoItem('ç½‘ç«™', this.internationalOrg.website)
            }
            if (this.internationalOrg.description) {
              Divider().color($r('app.color.gray_very_light')).margin({ top: 12, bottom: 12 })
              this.DescriptionItem('ç®€ä»‹', this.internationalOrg.description)
            }
          }
          .padding(16)
            .layoutWeight(1)
            .backgroundColor($r('app.color.bg_card'))
            .borderRadius(16)
        }
        .width('100%')
          .padding({ left: 16, right: 16 })
      }
      .width('100%')
        .padding({ top: 20, bottom: 20 })
        .backgroundColor($r('app.color.bg_page'))
    } else if (this.country) {
      Column({ space: 16 }) {
        // å›½æ——å›¾ç‰‡
        Column() {
          Image(getFlagImageSource(this.country.code))
            .width('100%')
            .height(200)
            .objectFit(ImageFit.Contain)
        }
        .width('100%')
          .padding(16)
          .backgroundColor($r('app.color.bg_page'))

        // å›½å®¶åç§°
        Column() {
          Text(this.country.nameCN)
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.text_primary'))
            .textAlign(TextAlign.Center)
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ bottom: 4 })

          Text(this.country.name)
            .fontSize(16)
            .fontColor($r('app.color.text_secondary'))
            .textAlign(TextAlign.Center)
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .width('100%')
          .padding({ left: 16, right: 16, top: 20, bottom: 16 })
          .alignItems(HorizontalAlign.Center)

        // åŸºæœ¬ä¿¡æ¯å¡ç‰‡ï¼ˆå…³äºï¼‰
        Row() {
          Column() {
            Text('åŸºæœ¬ä¿¡æ¯')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .margin({ bottom: 16 })
              .alignSelf(ItemAlign.Start)

            this.InfoItem('é¦–éƒ½', this.country.capitalCN)
            Divider().color($r('app.color.gray_very_light')).margin({ top: 12, bottom: 12 })
            this.InfoItem('æ‰€å±åœ°åŒº', this.getRegionName(this.country.region))
            Divider().color($r('app.color.gray_very_light')).margin({ top: 12, bottom: 12 })
            this.InfoItem('äººå£', this.formatPopulation(this.country.population))
            Divider().color($r('app.color.gray_very_light')).margin({ top: 12, bottom: 12 })
            this.InfoItem('é¢ç§¯', this.formatArea(this.country.area))
            Divider().color($r('app.color.gray_very_light')).margin({ top: 12, bottom: 12 })
            this.InfoItem('å›½å®¶ä»£ç ', this.country.code.toUpperCase())
          }
          .padding(16)
            .layoutWeight(1)
            .backgroundColor($r('app.color.bg_card'))
            .borderRadius(16)
        }
        .width('100%')
          .padding({ left: 16, right: 16 })

        // å…³äºè¿™é¢å›½æ——
        if (this.flagDesign) {
          Row() {
            Column() {
              Text('å…³äºè¿™é¢å›½æ——')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.text_primary'))
                .margin({ bottom: 16 })
                .alignSelf(ItemAlign.Start)

              this.InfoItem('å›½æ——æ¯”ä¾‹', this.getFlagProportion())
              Divider().color($r('app.color.gray_very_light')).margin({ top: 12, bottom: 12 })
              this.InfoItem('é‡‡ç”¨æ—¥æœŸ', this.getFlagAdopted())
              if (this.flagDesign.designCN) {
                Divider().color($r('app.color.gray_very_light')).margin({ top: 12, bottom: 12 })
                this.DescriptionItem('è®¾è®¡è¯´æ˜', this.flagDesign.designCN)
              }
            }
            .padding(16)
              .layoutWeight(1)
              .backgroundColor($r('app.color.bg_card'))
              .borderRadius(16)
          }
          .width('100%')
            .padding({ left: 16, right: 16 })
        }
      }
      .width('100%')
        .padding({ top: 20, bottom: 20 })
        .backgroundColor($r('app.color.bg_page'))
    }
  }

  @Builder
  HistoricalFlagsBanner() {
    Row() {
      Column() {
        // æ ‡é¢˜è¡Œ - å®Œå…¨å¤åˆ¶æ¶‚é¸¦è¯´æ˜çš„æ ·å¼
        Row() {
          Text('å†å²å›½æ——')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.text_primary'))

          Blank()

          Image($r('app.media.icon_arrow_right'))
            .width(20)
            .height(20)
        }
        .width('100%')
          .alignItems(VerticalAlign.Center)
          .margin({ bottom: 12 })

        // å†å²å›½æ——Gridï¼ˆæœ€å¤šæ˜¾ç¤º3ä¸ªï¼Œåªæ˜¾ç¤ºä¸€è¡Œï¼‰
        Grid() {
          ForEach(this.flagHistoryItems.slice(0, 3), (item: FlagHistoryItem, index: number) => {
            GridItem() {
              Column() {
                Image($rawfile(`flag_history/${item.imagePath}.webp`))
                  .width('100%')
                  .height(60)
                  .objectFit(ImageFit.Contain)
                  .borderRadius(4)
              }
              .width('100%')
                .padding(8)
                .backgroundColor($r('app.color.bg_secondary'))
                .borderRadius(8)
            }
          }, (item: FlagHistoryItem, index: number) => `history_${item.countryCode}_${item.year}_${index}`)
        }
        .columnsTemplate('1fr 1fr 1fr')
          .columnsGap(8)
          .rowsGap(8)
          .width('100%')
          .cachedCount(3)
      }
      .width('100%')
        .padding(16)
        .backgroundColor($r('app.color.bg_card'))
        .borderRadius(16)
        .onClick(() => {
          router.pushUrl({
            url: 'pages/flaghistory/FlagHistoryPage',
            params: { countryCode: this.countryCode }
          }).catch((err: Error) => {
            console.error(`Navigation failed: ${err.message}`);
          });
        })
    }
    .width('100%')
      .padding({ left: 16, right: 16 })
      .margin({ top: 16 })
  }
}

