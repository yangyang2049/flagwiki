import router from '@ohos.router';
import { TopicItem, getAllTopics } from '../topic/TopicData';
import { WeeklyFlagItem, getCurrentWeekFlag } from '../../utils/WeeklyFlagData';
import { getCountryByCode } from '../../utils/countryData';

@Component
export struct HomePage {
  @Prop refreshKey: number = 0;
  @State funFactIndex: number = 0;
  @State weeklyFlag: WeeklyFlagItem | undefined = undefined;
  onTabChange: (index: number) => void = () => {};

  aboutToAppear() {
    this.weeklyFlag = getCurrentWeekFlag();
  }

  private getRegionName(region: string): string {
    const regionMap: Record<string, string> = {
      'Asia': 'äºšæ´²',
      'Europe': 'æ¬§æ´²',
      'Africa': 'éžæ´²',
      'Americas': 'ç¾Žæ´²',
      'Oceania': 'å¤§æ´‹æ´²'
    };
    return regionMap[region] || region;
  }

  private getWeeklyFlagRegion(): string {
    if (!this.weeklyFlag) return '';
    const country = getCountryByCode(this.weeklyFlag.countryCode);
    if (country) {
      return this.getRegionName(country.region);
    }
    return '';
  }

  // å›½æ——è¶£å‘³å°çŸ¥è¯†
  private funFacts: string[] = [
    'ðŸ‡³ðŸ‡µ å°¼æ³Šå°”æ˜¯ä¸–ç•Œä¸Šå”¯ä¸€éžçŸ©å½¢çš„å›½æ——ï¼Œç”±ä¸¤ä¸ªä¸‰è§’å½¢ç»„æˆï¼',
    'ðŸ‡¨ðŸ‡­ ç‘žå£«å’Œæ¢µè’‚å†ˆæ˜¯ä¸–ç•Œä¸Šä»…æœ‰çš„ä¸¤ä¸ªæ­£æ–¹å½¢å›½æ——ï¼',
    'ðŸ‡¯ðŸ‡µ æ—¥æœ¬å›½æ——ä¸Šçš„çº¢è‰²åœ†å½¢ä»£è¡¨å¤ªé˜³ï¼Œæ—¥æœ¬è¢«ç§°ä¸º"æ—¥å‡ºä¹‹å›½"ï¼',
    'ðŸ‡±ðŸ‡¾ åˆ©æ¯”äºšåœ¨1977-2011å¹´ä½¿ç”¨è¿‡ä¸–ç•Œä¸Šå”¯ä¸€çš„çº¯è‰²å›½æ——ï¼ˆç»¿è‰²ï¼‰ï¼',
    'ðŸ‡²ðŸ‡¨ æ‘©çº³å“¥å’Œå°åº¦å°¼è¥¿äºšçš„å›½æ——å‡ ä¹Žç›¸åŒï¼Œåªæ˜¯å°ºå¯¸æ¯”ä¾‹ä¸åŒï¼',
    'ðŸ‡©ðŸ‡° ä¸¹éº¦å›½æ——æ˜¯ä¸–ç•Œä¸Šä½¿ç”¨æ—¶é—´æœ€é•¿çš„å›½æ——ï¼Œè‡ª1219å¹´å¼€å§‹ä½¿ç”¨ï¼',
    'ðŸ‡§ðŸ‡· å·´è¥¿å›½æ——ä¸Šçš„27é¢—æ˜Ÿæ˜Ÿä»£è¡¨26ä¸ªå·žå’Œ1ä¸ªè”é‚¦åŒºï¼',
    'ðŸ‡ºðŸ‡¸ ç¾Žå›½å›½æ——çš„50é¢—æ˜Ÿä»£è¡¨50ä¸ªå·žï¼Œ13é“æ¡çº¹ä»£è¡¨æœ€åˆçš„13ä¸ªæ®–æ°‘åœ°ï¼',
    'ðŸ‡¨ðŸ‡¦ åŠ æ‹¿å¤§å›½æ——ä¸Šçš„æž«å¶æœ‰11ä¸ªå°–è§’ï¼Œè¿™æ˜¯ç»è¿‡é£Žæ´žæµ‹è¯•æœ€æ¸…æ™°çš„è®¾è®¡ï¼',
    'ðŸ‡¬ðŸ‡§ è‹±å›½å›½æ——"ç±³å­—æ——"ç”±è‹±æ ¼å…°ã€è‹æ ¼å…°å’Œçˆ±å°”å…°çš„æ——å¸œç»„åˆè€Œæˆï¼'
  ];

  private switchFunFact(): void {
    this.funFactIndex = (this.funFactIndex + 1) % this.funFacts.length;
  }

  build() {
    Scroll() {
      Column() {
        // æ¬¢è¿Žå¡ç‰‡
        Column() {
          Row() {
            Column() {
              Text('å›½æ——å°ç™¾ç§‘')
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.text_white'))
              Text('æŽ¢ç´¢ä¸–ç•Œå„å›½å›½æ——çš„å¥¥ç§˜')
                .fontSize(14)
                .fontColor($r('app.color.text_white'))
                .opacity(0.85)
                .margin({ top: 8 })
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)

            // æ‰‡å½¢å›½æ——è£…é¥°
            Stack() {
              // å°åº¦ - æœ€å·¦ä¾§
              Image($rawfile('flags/in.svg'))
                .width(40)
                .height(27)
                .objectFit(ImageFit.Contain)
                .rotate({ angle: -25 })
                .offset({ x: -32, y: 12 })

              // ç¾Žå›½ - å·¦ä¾§
              Image($rawfile('flags/us.svg'))
                .width(42)
                .height(28)
                .objectFit(ImageFit.Contain)
                .rotate({ angle: -12 })
                .offset({ x: -16, y: 4 })

              // å·´è¥¿ - å³ä¾§
              Image($rawfile('flags/br.svg'))
                .width(42)
                .height(28)
                .objectFit(ImageFit.Contain)
                .rotate({ angle: 12 })
                .offset({ x: 16, y: 4 })

              // æ³•å›½ - æœ€å³ä¾§
              Image($rawfile('flags/fr.svg'))
                .width(40)
                .height(27)
                .objectFit(ImageFit.Contain)
                .rotate({ angle: 25 })
                .offset({ x: 32, y: 12 })

              // ä¸­å›½ - ä¸­é—´ï¼Œæœ€ä¸Šå±‚
              Image($rawfile('flags/cn.svg'))
                .width(48)
                .height(32)
                .objectFit(ImageFit.Contain)
                .offset({ x: 0, y: -8 })
            }
            .width(110)
            .height(65)
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)
        }
        .width('100%')
        .padding({ top: 24, bottom: 24, left: 20, right: 20 })
        .linearGradient({
          angle: 135,
          colors: [[$r('app.color.button_primary'), 0], [$r('app.color.blue'), 1]]
        })
        .borderRadius(16)
        .margin({ top: 16 })

        // æœ¬å‘¨å›½æ——
        if (this.weeklyFlag) {
          Column() {
            Row() {
              Text('æœ¬å‘¨å›½æ——')
                .fontSize(17)
                .fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.text_primary'))
            }
            .width('100%')
            .margin({ bottom: 16 })

            Row() {
              // å›½æ——å›¾ç‰‡
              Image($rawfile(`flags/${this.weeklyFlag.countryCode}.svg`))
                .width(120)
                .height(80)
                .objectFit(ImageFit.Contain)
                .margin({ right: 16 })

              // å›½å®¶ä¿¡æ¯
              Column() {
                Text(this.weeklyFlag.countryNameCN)
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.text_primary'))
                  .margin({ bottom: 6 })
                Text(`å›½åº†æ—¥: ${this.weeklyFlag.nationalDay.replace('-', 'æœˆ')}æ—¥`)
                  .fontSize(13)
                  .fontColor($r('app.color.text_secondary'))
                  .margin({ bottom: 4 })
                Text(this.getWeeklyFlagRegion())
                  .fontSize(12)
                  .fontColor($r('app.color.text_tertiary'))
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
            }
            .width('100%')
            .padding(16)
            .backgroundColor($r('app.color.bg_secondary'))
            .borderRadius(12)
          }
          .width('100%')
          .padding(20)
          .backgroundColor($r('app.color.bg_card'))
          .borderRadius(16)
          .margin({ top: 16 })
          .onClick(() => {
            if (this.weeklyFlag) {
              router.pushUrl({
                url: 'pages/gallery/FlagDetailPage',
                params: { countryCode: this.weeklyFlag.countryCode }
              });
            }
          })
        }

        // å¿«æ·å…¥å£åŒº
        Column() {
          Row() {
            Text('å¿«æ·å…¥å£')
              .fontSize(17)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
          }
          .width('100%')
          .margin({ bottom: 16 })

          Row() {
            // å›½æ——ç”»å»Š
            Column() {
              Stack() {
                Circle()
                  .width(48)
                  .height(48)
                  .fill($r('app.color.bg_blue_light'))
                Text('ðŸ‡ºðŸ‡³')
                  .fontSize(22)
              }
              Text('å›½æ——ç”»å»Š')
                .fontSize(13)
                .fontColor($r('app.color.text_dark'))
                .margin({ top: 10 })
            }
            .layoutWeight(1)
            .onClick(() => {
              this.onTabChange(1);
            })

            // å„å›½å·žæ——
            Column() {
              Stack() {
                Circle()
                  .width(48)
                  .height(48)
                  .fill($r('app.color.bg_blue_light'))
                Text('ðŸ‡ºðŸ‡¸')
                  .fontSize(22)
              }
              Text('å„å›½å·žæ——')
                .fontSize(13)
                .fontColor($r('app.color.text_dark'))
                .margin({ top: 10 })
            }
            .layoutWeight(1)
            .onClick(() => {
              router.pushUrl({ url: 'pages/stateflag/StateFlagCountryListPage' });
            })

            // å›½æ——çŒœçŒœ
            Column() {
              Stack() {
                Circle()
                  .width(48)
                  .height(48)
                  .fill($r('app.color.bg_blue_light'))
                Text('ðŸŽ¯')
                  .fontSize(22)
              }
              Text('å›½æ——çŒœçŒœ')
                .fontSize(13)
                .fontColor($r('app.color.text_dark'))
                .margin({ top: 10 })
            }
            .layoutWeight(1)
            .onClick(() => {
              router.pushUrl({ url: 'pages/quiz/QuizSelectPage' });
            })

            // æ”¶è—å¤¹
            Column() {
              Stack() {
                Circle()
                  .width(48)
                  .height(48)
                  .fill($r('app.color.bg_blue_light'))
                Text('â­')
                  .fontSize(22)
              }
              Text('æ”¶è—å¤¹')
                .fontSize(13)
                .fontColor($r('app.color.text_dark'))
                .margin({ top: 10 })
            }
            .layoutWeight(1)
            .onClick(() => {
              router.pushUrl({ url: 'pages/profile/FavoritesPage' });
            })
          }
          .width('100%')
        }
        .width('100%')
        .padding(20)
        .backgroundColor($r('app.color.bg_card'))
        .borderRadius(16)
        .margin({ top: 16 })

        // ä¸“é¢˜æŽ¨è
        Column() {
          Row() {
            Text('ä¸“é¢˜æŽ¨è')
              .fontSize(17)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
            Blank()
            Text('â€º')
              .fontSize(22)
              .fontColor($r('app.color.button_primary'))
              .onClick(() => {
                router.pushUrl({ url: 'pages/topic/TopicListPage' });
              })
          }
          .width('100%')
          .margin({ bottom: 16 })

          // æ¨ªå‘æ»šåŠ¨çš„ä¸“é¢˜å¡ç‰‡
          Scroll() {
            Row() {
              ForEach(getAllTopics().slice(0, 4), (topic: TopicItem) => {
                Column() {
                  Text(topic.emoji)
                    .fontSize(32)
                    .margin({ bottom: 8 })
                  Text(topic.name)
                    .fontSize(14)
                    .fontWeight(FontWeight.Medium)
                    .fontColor($r('app.color.text_primary'))
                    .maxLines(1)
                }
                .width(90)
                .height(90)
                .padding(12)
                .backgroundColor($r('app.color.bg_secondary'))
                .borderRadius(12)
                .margin({ right: 12 })
                .onClick(() => {
                  router.pushUrl({
                    url: 'pages/topic/TopicDetailPage',
                    params: { topicId: topic.id }
                  });
                })
              })
            }
          }
          .width('100%')
          .scrollable(ScrollDirection.Horizontal)
          .scrollBar(BarState.Off)
        }
        .width('100%')
        .padding(20)
        .backgroundColor($r('app.color.bg_card'))
        .borderRadius(16)
        .margin({ top: 16 })

        // è¶£å‘³å°çŸ¥è¯†
        Column() {
          Row() {
            Text('ðŸ’¡ è¶£å‘³å°çŸ¥è¯†')
              .fontSize(17)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
            Blank()
            Image($r('app.media.icon_redo'))
              .width(20)
              .height(20)
              .onClick(() => {
                this.switchFunFact();
              })
          }
          .width('100%')
          .margin({ bottom: 16 })

          Text(this.funFacts[this.funFactIndex])
            .fontSize(15)
            .fontColor($r('app.color.text_dark'))
            .lineHeight(24)
        }
        .width('100%')
        .padding(20)
        .backgroundColor($r('app.color.bg_card'))
        .borderRadius(16)
        .margin({ top: 16, bottom: 16 })
      }
      .width('100%')
      .padding({ left: 16, right: 16 })
    }
    .width('100%')
    .height('100%')
    .scrollBar(BarState.Off)
    .edgeEffect(EdgeEffect.Spring)
  }
}
