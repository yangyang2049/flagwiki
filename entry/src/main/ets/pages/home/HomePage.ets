import router from '@ohos.router';
import { TopicItem, getAllTopics } from '../topic/TopicData';
import { WeeklyFlagItem, getCurrentWeekFlag } from '../../utils/WeeklyFlagData';
import { getCountryByCode, getFlagImageSource } from '../../utils/countryData';

@Component
export struct HomePage {
  @Prop refreshKey: number = 0;
  @State funFactIndex: number = 0;
  @State weeklyFlag: WeeklyFlagItem | undefined = undefined;
  onTabChange: (index: number) => void = () => {};

  aboutToAppear() {
    this.weeklyFlag = getCurrentWeekFlag();
    // ÈöèÊú∫ÊòæÁ§∫Ë∂£Âë≥Áü•ËØÜ
    this.funFactIndex = Math.floor(Math.random() * this.funFacts.length);
  }

  private getRegionName(region: string): string {
    const regionMap: Record<string, string> = {
      'Asia': '‰∫öÊ¥≤',
      'Europe': 'Ê¨ßÊ¥≤',
      'Africa': 'ÈùûÊ¥≤',
      'Americas': 'ÁæéÊ¥≤',
      'Oceania': 'Â§ßÊ¥ãÊ¥≤'
    };
    return regionMap[region] || region;
  }

  private getWeeklyFlagRegion(): string {
    if (!this.weeklyFlag) return '';
    const country = getCountryByCode(this.weeklyFlag.countryCode);
    if (country) {
      return this.getRegionName(country.region);
    }
    return '';
  }

  // ÂõΩÊóóË∂£Âë≥Â∞èÁü•ËØÜ
  private funFacts: string[] = [
    'üá≥üáµ Â∞ºÊ≥äÂ∞îÊòØ‰∏ñÁïå‰∏äÂîØ‰∏ÄÈùûÁü©ÂΩ¢ÁöÑÂõΩÊóóÔºåÁî±‰∏§‰∏™‰∏âËßíÂΩ¢ÁªÑÊàêÔºÅ',
    'üá®üá≠ ÁëûÂ£´ÂíåÊ¢µËíÇÂÜàÊòØ‰∏ñÁïå‰∏ä‰ªÖÊúâÁöÑ‰∏§‰∏™Ê≠£ÊñπÂΩ¢ÂõΩÊóóÔºÅ',
    'üáØüáµ Êó•Êú¨ÂõΩÊóó‰∏äÁöÑÁ∫¢Ëâ≤ÂúÜÂΩ¢‰ª£Ë°®Â§™Èò≥ÔºåÊó•Êú¨Ë¢´Áß∞‰∏∫"Êó•Âá∫‰πãÂõΩ"ÔºÅ',
    'üá±üáæ Âà©ÊØî‰∫öÂú®1977-2011Âπ¥‰ΩøÁî®Ëøá‰∏ñÁïå‰∏äÂîØ‰∏ÄÁöÑÁ∫ØËâ≤ÂõΩÊóóÔºàÁªøËâ≤ÔºâÔºÅ',
    'üá≤üá® Êë©Á∫≥Âì•ÂíåÂç∞Â∫¶Â∞ºË•ø‰∫öÁöÑÂõΩÊóóÂá†‰πéÁõ∏ÂêåÔºåÂè™ÊòØÂ∞∫ÂØ∏ÊØî‰æã‰∏çÂêåÔºÅ',
    'üá©üá∞ ‰∏πÈ∫¶ÂõΩÊóóÊòØ‰∏ñÁïå‰∏ä‰ΩøÁî®Êó∂Èó¥ÊúÄÈïøÁöÑÂõΩÊóóÔºåËá™1219Âπ¥ÂºÄÂßã‰ΩøÁî®ÔºÅ',
    'üáßüá∑ Â∑¥Ë•øÂõΩÊóó‰∏äÁöÑ27È¢óÊòüÊòü‰ª£Ë°®26‰∏™Â∑ûÂíå1‰∏™ËÅîÈÇ¶Âå∫ÔºÅ',
    'üá∫üá∏ ÁæéÂõΩÂõΩÊóóÁöÑ50È¢óÊòü‰ª£Ë°®50‰∏™Â∑ûÔºå13ÈÅìÊù°Á∫π‰ª£Ë°®ÊúÄÂàùÁöÑ13‰∏™ÊÆñÊ∞ëÂú∞ÔºÅ',
    'üá®üá¶ Âä†ÊãøÂ§ßÂõΩÊóó‰∏äÁöÑÊû´Âè∂Êúâ11‰∏™Â∞ñËßíÔºåËøôÊòØÁªèËøáÈ£éÊ¥ûÊµãËØïÊúÄÊ∏ÖÊô∞ÁöÑËÆæËÆ°ÔºÅ',
    'üá¨üáß Ëã±ÂõΩÂõΩÊóó"Á±≥Â≠óÊóó"Áî±Ëã±Ê†ºÂÖ∞„ÄÅËãèÊ†ºÂÖ∞ÂíåÁà±Â∞îÂÖ∞ÁöÑÊóóÂ∏úÁªÑÂêàËÄåÊàêÔºÅ'
  ];

  private switchFunFact(): void {
    this.funFactIndex = (this.funFactIndex + 1) % this.funFacts.length;
  }

  build() {
    Scroll() {
      Column() {
        // Ê¨¢ËøéÂç°Áâá
        Column() {
          Row() {
            Column() {
              Text('ÂõΩÊóóÂ∞èÁôæÁßë')
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.text_white'))
              Text('Êé¢Á¥¢‰∏ñÁïåÂêÑÂõΩÂõΩÊóóÁöÑÂ••Áßò')
                .fontSize(14)
                .fontColor($r('app.color.text_white'))
                .opacity(0.85)
                .margin({ top: 8 })
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)

            // ÊâáÂΩ¢ÂõΩÊóóË£ÖÈ•∞
            Stack() {
              // Âç∞Â∫¶ - ÊúÄÂ∑¶‰æß
              Image(getFlagImageSource('in'))
                .width(40)
                .height(27)
                .objectFit(ImageFit.Contain)
                .rotate({ angle: -25 })
                .offset({ x: -32, y: 12 })

              // ÁæéÂõΩ - Â∑¶‰æß
              Image(getFlagImageSource('us'))
                .width(42)
                .height(28)
                .objectFit(ImageFit.Contain)
                .rotate({ angle: -12 })
                .offset({ x: -16, y: 4 })

              // Â∑¥Ë•ø - Âè≥‰æß
              Image(getFlagImageSource('br'))
                .width(42)
                .height(28)
                .objectFit(ImageFit.Contain)
                .rotate({ angle: 12 })
                .offset({ x: 16, y: 4 })

              // Ê≥ïÂõΩ - ÊúÄÂè≥‰æß
              Image(getFlagImageSource('fr'))
                .width(40)
                .height(27)
                .objectFit(ImageFit.Contain)
                .rotate({ angle: 25 })
                .offset({ x: 32, y: 12 })

              // ‰∏≠ÂõΩ - ‰∏≠Èó¥ÔºåÊúÄ‰∏äÂ±Ç
              Image(getFlagImageSource('cn'))
                .width(48)
                .height(32)
                .objectFit(ImageFit.Contain)
                .offset({ x: 0, y: -8 })
            }
            .width(110)
            .height(65)
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)
        }
        .width('100%')
        .padding({ top: 24, bottom: 24, left: 20, right: 20 })
        .linearGradient({
          angle: 135,
          colors: [[$r('app.color.button_primary'), 0], [$r('app.color.blue'), 1]]
        })
        .borderRadius(16)
        .margin({ top: 16 })

        // Êú¨Âë®ÂõΩÊóó
        if (this.weeklyFlag) {
          Column() {
            Row() {
              Text('Êú¨Âë®ÂõΩÊóó')
                .fontSize(17)
                .fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.text_primary'))
            }
            .width('100%')
            .margin({ bottom: 16 })

            Row() {
              // ÂõΩÊóóÂõæÁâá
              Image(getFlagImageSource(this.weeklyFlag.countryCode))
                .width(120)
                .height(80)
                .objectFit(ImageFit.Contain)
                .margin({ right: 16 })

              // ÂõΩÂÆ∂‰ø°ÊÅØ
              Column() {
                Text(this.weeklyFlag.countryNameCN)
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.text_primary'))
                  .margin({ bottom: 6 })
                Text(`ÂõΩÂ∫ÜÊó•: ${this.weeklyFlag.nationalDay.replace('-', 'Êúà')}Êó•`)
                  .fontSize(13)
                  .fontColor($r('app.color.text_secondary'))
                  .margin({ bottom: 4 })
                Text(this.getWeeklyFlagRegion())
                  .fontSize(12)
                  .fontColor($r('app.color.text_tertiary'))
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
            }
            .width('100%')
            .padding(16)
            .backgroundColor($r('app.color.bg_secondary'))
            .borderRadius(12)
          }
          .width('100%')
          .padding(20)
          .backgroundColor($r('app.color.bg_card'))
          .borderRadius(16)
          .margin({ top: 16 })
          .onClick(() => {
            if (this.weeklyFlag) {
              router.pushUrl({
                url: 'pages/gallery/FlagDetailPage',
                params: { countryCode: this.weeklyFlag.countryCode }
              });
            }
          })
        }

        // Âø´Êç∑ÂÖ•Âè£Âå∫
        Column() {
          Row() {
            Text('Âø´Êç∑ÂÖ•Âè£')
              .fontSize(17)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
          }
          .width('100%')
          .margin({ bottom: 16 })

          Row() {
            // ÂõΩÊóóÁîªÂªä
            Column() {
              Stack() {
                Circle()
                  .width(48)
                  .height(48)
                  .fill($r('app.color.bg_blue_light'))
                Text('üá∫üá≥')
                  .fontSize(22)
              }
              Text('ÂõΩÊóóÁîªÂªä')
                .fontSize(13)
                .fontColor($r('app.color.text_dark'))
                .margin({ top: 10 })
            }
            .layoutWeight(1)
            .onClick(() => {
              this.onTabChange(1);
            })

            // ÂêÑÂõΩÂ∑ûÊóó
            Column() {
              Stack() {
                Circle()
                  .width(48)
                  .height(48)
                  .fill($r('app.color.bg_blue_light'))
                Text('üá∫üá∏')
                  .fontSize(22)
              }
              Text('ÂêÑÂõΩÂ∑ûÊóó')
                .fontSize(13)
                .fontColor($r('app.color.text_dark'))
                .margin({ top: 10 })
            }
            .layoutWeight(1)
            .onClick(() => {
              router.pushUrl({ url: 'pages/stateflag/StateFlagCountryListPage' });
            })

            // ÂõΩÊóóÁåúÁåú
            Column() {
              Stack() {
                Circle()
                  .width(48)
                  .height(48)
                  .fill($r('app.color.bg_blue_light'))
                Text('üéØ')
                  .fontSize(22)
              }
              Text('ÂõΩÊóóÁåúÁåú')
                .fontSize(13)
                .fontColor($r('app.color.text_dark'))
                .margin({ top: 10 })
            }
            .layoutWeight(1)
            .onClick(() => {
              router.pushUrl({ url: 'pages/quiz/QuizSelectPage' });
            })

            // Êî∂ËóèÂ§π
            Column() {
              Stack() {
                Circle()
                  .width(48)
                  .height(48)
                  .fill($r('app.color.bg_blue_light'))
                Text('‚≠ê')
                  .fontSize(22)
              }
              Text('Êî∂ËóèÂ§π')
                .fontSize(13)
                .fontColor($r('app.color.text_dark'))
                .margin({ top: 10 })
            }
            .layoutWeight(1)
            .onClick(() => {
              router.pushUrl({ url: 'pages/profile/FavoritesPage' });
            })
          }
          .width('100%')
        }
        .width('100%')
        .padding(20)
        .backgroundColor($r('app.color.bg_card'))
        .borderRadius(16)
        .margin({ top: 16 })

        // ‰∏ìÈ¢òÊé®Ëçê
        Column() {
          Row() {
            Text('‰∏ìÈ¢òÊé®Ëçê')
              .fontSize(17)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
            Blank()
            Text('‚Ä∫')
              .fontSize(22)
              .fontColor($r('app.color.button_primary'))
              .onClick(() => {
                router.pushUrl({ url: 'pages/topic/TopicListPage' });
              })
          }
          .width('100%')
          .margin({ bottom: 16 })

          // Ê®™ÂêëÊªöÂä®ÁöÑ‰∏ìÈ¢òÂç°Áâá
          Scroll() {
            Row() {
              ForEach(getAllTopics().slice(0, 4), (topic: TopicItem) => {
                Column() {
                  Text(topic.emoji)
                    .fontSize(32)
                    .margin({ bottom: 8 })
                  Text(topic.name)
                    .fontSize(14)
                    .fontWeight(FontWeight.Medium)
                    .fontColor($r('app.color.text_primary'))
                    .maxLines(1)
                }
                .width(90)
                .height(90)
                .padding(12)
                .backgroundColor($r('app.color.bg_secondary'))
                .borderRadius(12)
                .margin({ right: 12 })
                .onClick(() => {
                  router.pushUrl({
                    url: 'pages/topic/TopicDetailPage',
                    params: { topicId: topic.id }
                  });
                })
              })
            }
          }
          .width('100%')
          .scrollable(ScrollDirection.Horizontal)
          .scrollBar(BarState.Off)
        }
        .width('100%')
        .padding(20)
        .backgroundColor($r('app.color.bg_card'))
        .borderRadius(16)
        .margin({ top: 16 })

        // Ë∂£Âë≥Â∞èÁü•ËØÜ
        Column() {
          Row() {
            Text('üí° Ë∂£Âë≥Â∞èÁü•ËØÜ')
              .fontSize(17)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
            Blank()
            Image($r('app.media.icon_redo'))
              .width(20)
              .height(20)
              .onClick(() => {
                this.switchFunFact();
              })
          }
          .width('100%')
          .margin({ bottom: 16 })

          Text(this.funFacts[this.funFactIndex])
            .fontSize(15)
            .fontColor($r('app.color.text_dark'))
            .lineHeight(24)
        }
        .width('100%')
        .padding(20)
        .backgroundColor($r('app.color.bg_card'))
        .borderRadius(16)
        .margin({ top: 16, bottom: 16 })
      }
      .width('100%')
      .padding({ left: 16, right: 16 })
    }
    .width('100%')
    .height('100%')
    .scrollBar(BarState.Off)
    .edgeEffect(EdgeEffect.Spring)
    .focusable(true)
    .defaultFocus(true)
  }
}
