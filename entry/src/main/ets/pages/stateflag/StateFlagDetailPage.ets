import router from '@ohos.router';
import common from '@ohos.app.ability.common';
import promptAction from '@ohos.promptAction';
import { image } from '@kit.ImageKit';
import { systemShare } from '@kit.ShareKit';
import { uniformTypeDescriptor } from '@kit.ArkData';
import { BusinessError } from '@kit.BasicServicesKit';
import fs from '@ohos.file.fs';
import { fileUri } from '@kit.CoreFileKit';
import { CountryStateData, StateInfo, getCountryStateData, getStateFlagPath } from '../../utils/StateFlagData';
import { screenshotManager } from '../../utils/ScreenshotManager';
import { SaveFlagDialog } from '../../components/SaveFlagDialog';
import { FavoritesManager } from '../../utils/favoritesManager';
import { TextReaderUtil } from '../../utils/TextReaderUtil';
import { getContentMaxWidth } from '../../utils/LayoutHelper';

interface RouterParams {
  countryCode: string;
  stateCode: string;
}

@Entry
@Component
struct StateFlagDetailPage {
  @State countryData: CountryStateData | undefined = undefined;
  @State stateInfo: StateInfo | undefined = undefined;
  @State isLoading: boolean = true;
  @State flagPixelMap: image.PixelMap | null = null;
  @State isFavorite: boolean = false;
  @State isReading: boolean = false;
  @State isSharing: boolean = false;
  @State sharePixelMap: image.PixelMap | null = null;
  private context = getContext(this) as common.UIAbilityContext;
  private readonly FLAG_CONTAINER_ID = 'stateFlagContainer';
  private readonly FLAG_DOWNLOAD_CONTAINER_ID = 'stateFlagDownloadContainer';
  private readonly SHARE_CONTAINER_ID = 'stateFlagShareContainer';
  private saveDialogController: CustomDialogController | null = null;
  private countryCode: string = '';
  private stateCode: string = '';

  async aboutToAppear() {
    const params = router.getParams() as RouterParams;
    if (params && params.countryCode && params.stateCode) {
      this.countryCode = params.countryCode;
      this.stateCode = params.stateCode;
    }

    // å»¶è¿ŸåŠ è½½ä»¥æ˜¾ç¤ºloadingçŠ¶æ€
    setTimeout(async () => {
      if (this.countryCode && this.stateCode) {
        this.countryData = getCountryStateData(this.countryCode);
        if (this.countryData) {
          this.stateInfo = this.countryData.states.find(s => s.code === this.stateCode);
        }
      }
      this.isLoading = false;

      // æ£€æŸ¥æ”¶è—çŠ¶æ€
      await this.checkFavoriteStatus();
    }, 600);

    // åˆå§‹åŒ–æˆªå›¾ç®¡ç†å™¨
    screenshotManager.init(this.getUIContext());

    // åˆå§‹åŒ–æ”¶è—ç®¡ç†å™¨
    await FavoritesManager.init(this.context);
  }

  private async checkFavoriteStatus(): Promise<void> {
    const pageUrl = `stateflag:${this.countryCode}:${this.stateCode}`;
    this.isFavorite = await FavoritesManager.isFavorite(pageUrl);
  }

  private async toggleFavorite(): Promise<void> {
    const name = this.stateInfo?.nameCN || 'æœªçŸ¥';
    const pageUrl = `stateflag:${this.countryCode}:${this.stateCode}`;

    if (this.isFavorite) {
      await FavoritesManager.removeFavorite(pageUrl);
      this.isFavorite = false;
      promptAction.showToast({
        message: 'å·²å–æ¶ˆæ”¶è—',
        duration: 2000
      });
    } else {
      await FavoritesManager.addFavorite({ name: name, pageUrl: pageUrl });
      this.isFavorite = true;
      promptAction.showToast({
        message: 'å·²æ·»åŠ åˆ°æ”¶è—',
        duration: 2000
      });
    }
  }

  private releaseFlagPixelMap(): void {
    if (this.flagPixelMap) {
      try {
        this.flagPixelMap.release();
      } catch (e) {
        console.warn('[StateFlagDetailPage] Failed to release pixelmap:', e);
      }
      this.flagPixelMap = null;
    }
  }

  private releaseSharePixelMap(): void {
    if (this.sharePixelMap) {
      try {
        this.sharePixelMap.release();
      } catch (e) {
        console.warn('[StateFlagDetailPage] Failed to release share pixelmap:', e);
      }
      this.sharePixelMap = null;
    }
  }

  private async onDownloadClick(): Promise<void> {
    if (!this.countryData || !this.stateInfo) return;

    try {
      promptAction.showToast({
        message: 'æ­£åœ¨å‡†å¤‡å›¾ç‰‡...',
        duration: 1000
      });

      // å…ˆé‡Šæ”¾ä¹‹å‰çš„ PixelMapï¼Œé¿å…å†…å­˜æ³„æ¼
      this.releaseFlagPixelMap();

      // æˆªå–ä¸‹è½½å®¹å™¨å¿«ç…§ï¼ˆæ—  paddingï¼‰
      const pixmap = await screenshotManager.captureSnapshot(this.FLAG_DOWNLOAD_CONTAINER_ID);
      if (!pixmap) {
        promptAction.showToast({
          message: 'æˆªå–å›¾ç‰‡å¤±è´¥',
          duration: 2000
        });
        return;
      }

      this.flagPixelMap = pixmap;

      this.saveDialogController = new CustomDialogController({
        builder: SaveFlagDialog({
          pixelMap: this.flagPixelMap,
          onClose: () => {
            this.releaseFlagPixelMap();
          },
          onSaveSuccess: () => {
            promptAction.showToast({
              message: 'æ——å¸œå›¾ç‰‡å·²ä¿å­˜åˆ°ç›¸å†Œ',
              duration: 2000
            });
          },
          onSaveError: (error: Error) => {
            promptAction.showToast({
              message: `ä¿å­˜å¤±è´¥: ${error.message}`,
              duration: 2000
            });
            this.releaseFlagPixelMap();
          },
          saveScreenshot: async () => {
            await this.doSaveFlag();
          }
        }),
        autoCancel: false,
        customStyle: true
      });

      this.saveDialogController.open();
    } catch (error) {
      console.error('[StateFlagDetailPage] Download error:', error);
      promptAction.showToast({
        message: 'ä¸‹è½½å¤±è´¥',
        duration: 2000
      });
    }
  }

  private async doSaveFlag(): Promise<void> {
    if (!this.flagPixelMap || !this.stateInfo) {
      throw new Error('å›¾ç‰‡æˆ–å·æ——ä¿¡æ¯ä¸å­˜åœ¨');
    }

    const fileName = screenshotManager.generateFileName('å·æ——', this.stateInfo.nameCN);
    const success = await screenshotManager.saveToGallery(
      this.flagPixelMap,
      fileName,
      this.context,
      false
    );

    if (!success) {
      throw new Error('ä¿å­˜åˆ°ç›¸å†Œå¤±è´¥');
    }
  }

  build() {
    Navigation() {
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .color($r('app.color.button_primary'))
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor($r('app.color.text_tertiary'))
            .margin({ top: 12 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .backgroundColor($r('app.color.bg_page'))
      } else if (this.countryData && this.stateInfo) {
        Scroll() {
          Row() {
            Column() {
            // éšè—çš„åˆ†äº«å®¹å™¨ï¼ˆåŒ…å«å·æ——å’ŒåŸºæœ¬ä¿¡æ¯ï¼‰
            Column({ space: 16 }) {
              // å·æ——å›¾ç‰‡
              Column() {
                Image($rawfile(getStateFlagPath(this.countryData.countryCode, this.stateInfo.code)))
                  .width('100%')
                  .height(200)
                  .objectFit(ImageFit.Contain)
              }
              .width('100%')
                .padding(16)
                .backgroundColor($r('app.color.bg_page'))

              // å·åç§°
              Column() {
                Text(this.stateInfo.nameCN)
                  .fontSize(28)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.text_primary'))
                  .textAlign(TextAlign.Center)
                  .margin({ bottom: 4 })

                Text(this.stateInfo.name)
                  .fontSize(16)
                  .fontColor($r('app.color.text_secondary'))
                  .textAlign(TextAlign.Center)
              }
              .width('100%')
                .padding({ left: 16, right: 16, top: 20, bottom: 16 })
                .alignItems(HorizontalAlign.Center)

              // åŸºæœ¬ä¿¡æ¯å¡ç‰‡
              Row() {
                Column() {
                  Text('åŸºæœ¬ä¿¡æ¯')
                    .fontSize(17)
                    .fontWeight(FontWeight.Bold)
                    .fontColor($r('app.color.text_primary'))
                    .alignSelf(ItemAlign.Start)
                    .margin({ bottom: 16 })

                  this.InfoRow('æ‰€å±å›½å®¶', `${this.countryData.countryEmoji} ${this.countryData.countryNameCN}`)
                  Divider().color($r('app.color.gray_very_light')).margin({ top: 12, bottom: 12 })
                  this.InfoRow('é¦–åºœ', this.stateInfo.capitalCN)
                  Divider().color($r('app.color.gray_very_light')).margin({ top: 12, bottom: 12 })
                  this.InfoRow('åœ°åŒº', this.stateInfo.regionCN)
                }
                .padding(20)
                  .layoutWeight(1)
                  .backgroundColor($r('app.color.bg_card'))
                  .borderRadius(16)
              }
              .width('100%')
                .padding({ left: 16, right: 16 })
            }
            .width('100%')
              .padding({ top: 20, bottom: 20 })
              .backgroundColor($r('app.color.bg_page'))
              .id(this.SHARE_CONTAINER_ID)
              .position({ x: -1000, y: -1000 })

            // éšè—çš„ä¸‹è½½å®¹å™¨ï¼ˆæ—  paddingï¼Œä»…ç”¨äºæˆªå›¾ï¼‰
            Column() {
              Image($rawfile(getStateFlagPath(this.countryData.countryCode, this.stateInfo.code)))
                .width('100%')
                .height('100%')
                .objectFit(ImageFit.Fill)
            }
            .width(400)
            .height(240)
            .id(this.FLAG_DOWNLOAD_CONTAINER_ID)
            .position({ x: -1000, y: -1000 })

            // å·æ——å›¾ç‰‡ï¼ˆå±•ç¤ºç”¨ï¼Œæœ‰ paddingï¼‰
            Column() {
              Image($rawfile(getStateFlagPath(this.countryData.countryCode, this.stateInfo.code)))
                .width('100%')
                .height(240)
                .objectFit(ImageFit.Contain)
            }
            .width('100%')
            .padding(16)
            .backgroundColor($r('app.color.bg_secondary'))
            .id(this.FLAG_CONTAINER_ID)

            // å·åç§°
            Column() {
              Text(this.stateInfo.nameCN)
                .fontSize(28)
                .fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.text_primary'))
                .textAlign(TextAlign.Center)
                .margin({ bottom: 4 })

              Text(this.stateInfo.name)
                .fontSize(16)
                .fontColor($r('app.color.text_secondary'))
                .textAlign(TextAlign.Center)
            }
            .width('100%')
            .padding({ left: 16, right: 16, top: 20, bottom: 16 })
            .alignItems(HorizontalAlign.Center)

            // åŸºæœ¬ä¿¡æ¯å¡ç‰‡
            Row() {
              Column() {
                Text('åŸºæœ¬ä¿¡æ¯')
                  .fontSize(17)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.text_primary'))
                  .alignSelf(ItemAlign.Start)
                  .margin({ bottom: 16 })

                this.InfoRow('æ‰€å±å›½å®¶', `${this.countryData.countryEmoji} ${this.countryData.countryNameCN}`)
                Divider().color($r('app.color.gray_very_light')).margin({ top: 12, bottom: 12 })
                this.InfoRow('é¦–åºœ', this.stateInfo.capitalCN)
                Divider().color($r('app.color.gray_very_light')).margin({ top: 12, bottom: 12 })
                this.InfoRow('åœ°åŒº', this.stateInfo.regionCN)
              }
              .padding(20)
              .layoutWeight(1)
              .backgroundColor($r('app.color.bg_card'))
              .borderRadius(16)
            }
            .width('100%')
            .padding({ left: 16, right: 16 })
            .margin({ top: 16 })

            // åº•éƒ¨æ“ä½œæŒ‰é’®
            Row({ space: 16 }) {
              // æ”¶è—æŒ‰é’®
              Button() {
                Row({ space: 8 }) {
                  Image(this.isFavorite ? $r('app.media.icon_favorite_selected') : $r('app.media.icon_favorite'))
                    .width(20)
                    .height(20)
                  Text(this.isFavorite ? 'å·²æ”¶è—' : 'æ”¶è—')
                    .fontSize(15)
                    .fontColor(this.isFavorite ? $r('app.color.button_primary') : $r('app.color.text_primary'))
                }
              }
              .layoutWeight(1)
              .height(48)
              .backgroundColor($r('app.color.bg_card'))
              .borderRadius(12)
              .onClick(() => {
                this.toggleFavorite();
              })

              // ä¸‹è½½æŒ‰é’®
              Button() {
                Row({ space: 8 }) {
                  Image($r('app.media.icon_download'))
                    .width(20)
                    .height(20)
                  Text('ä¸‹è½½')
                    .fontSize(15)
                    .fontColor($r('app.color.text_primary'))
                }
              }
              .layoutWeight(1)
              .height(48)
              .backgroundColor($r('app.color.bg_card'))
              .borderRadius(12)
              .onClick(() => {
                this.onDownloadClick();
              })
            }
            .width('100%')
            .padding({ left: 16, right: 16 })
            .margin({ top: 20, bottom: 24 })
            }
            .width('100%')
            .constraintSize({ maxWidth: getContentMaxWidth() })
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
        }
        .width('100%')
        .height('100%')
        .scrollBar(BarState.Off)
        .edgeEffect(EdgeEffect.Spring)
        .backgroundColor($r('app.color.bg_page'))
      } else {
        Column() {
          Text('æš‚æ— æ•°æ®')
            .fontSize(14)
            .fontColor($r('app.color.text_tertiary'))
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .backgroundColor($r('app.color.bg_page'))
      }
    }
    .title(this.stateInfo?.nameCN || 'å·æ——è¯¦æƒ…')
    .titleMode(NavigationTitleMode.Mini)
    .mode(NavigationMode.Stack)
    .backgroundColor($r('app.color.bg_page'))
    .menus(this.MenuBuilder)
  }

  @Builder
  MenuBuilder() {
    Row({ space: 20 }) {
      Image($r('app.media.icon_voice'))
        .width(24)
        .height(24)
        .onClick(() => {
          this.onReadClick();
        })

      Image($r('app.media.icon_share'))
        .width(22)
        .height(22)
        .onClick(() => {
          this.onShareClick();
        })
    }
    .height('100%')
    .justifyContent(FlexAlign.End)
    .alignItems(VerticalAlign.Center)
    .padding({ right: 16 })
  }

  @Builder
  InfoRow(label: string, value: string) {
    Row() {
      Text(label)
        .fontSize(15)
        .fontColor($r('app.color.text_secondary'))
        .width(80)

      Text(value)
        .fontSize(15)
        .fontColor($r('app.color.text_primary'))
        .layoutWeight(1)
        .textAlign(TextAlign.End)
    }
    .width('100%')
  }

  private getReadContent(): string {
    if (!this.countryData || !this.stateInfo) {
      return '';
    }

    const lines: string[] = [];
    lines.push(`${this.stateInfo.nameCN}ï¼Œè‹±æ–‡å${this.stateInfo.name}ã€‚`);
    lines.push(`æ‰€å±å›½å®¶æ˜¯${this.countryData.countryNameCN}ã€‚`);
    lines.push(`é¦–åºœæ˜¯${this.stateInfo.capitalCN}ã€‚`);
    lines.push(`åœ°åŒºæ˜¯${this.stateInfo.regionCN}ã€‚`);

    return lines.join('');
  }

  private async onReadClick(): Promise<void> {
    if (this.isReading) {
      TextReaderUtil.stopRead();
      this.isReading = false;
      promptAction.showToast({
        message: 'å·²åœæ­¢æœ—è¯»',
        duration: 2000
      });
    } else {
      try {
        const title = this.stateInfo?.nameCN || 'å·æ——è¯¦æƒ…';
        const content = this.getReadContent();
        await TextReaderUtil.startRead(this.context, title, content);
        this.isReading = true;
        promptAction.showToast({
          message: 'å¼€å§‹æœ—è¯»',
          duration: 2000
        });
      } catch (err) {
        console.error(`Failed to start read: ${JSON.stringify(err)}`);
        promptAction.showToast({
          message: 'æœ—è¯»åŠŸèƒ½æš‚ä¸å¯ç”¨',
          duration: 2000
        });
      }
    }
  }

  private async onShareClick(): Promise<void> {
    if (this.isSharing || !this.countryData || !this.stateInfo) return;

    this.isSharing = true;
    promptAction.showToast({
      message: 'æ­£åœ¨å‡†å¤‡åˆ†äº«...',
      duration: 1500
    });

    let tempFilePath: string | null = null;

    try {
      // å…ˆé‡Šæ”¾ä¹‹å‰çš„ PixelMap
      this.releaseSharePixelMap();

      // æˆªå–åˆ†äº«å®¹å™¨å†…å®¹
      const pixmap = await screenshotManager.captureSnapshot(this.SHARE_CONTAINER_ID);
      if (!pixmap) {
        promptAction.showToast({
          message: 'æˆªå–å›¾ç‰‡å¤±è´¥',
          duration: 2000
        });
        this.isSharing = false;
        return;
      }

      this.sharePixelMap = pixmap;

      // åˆ›å»ºå›¾åƒæ‰“åŒ…å™¨å¹¶æ‰“åŒ…ä¸º ArrayBuffer
      const imagePacker = image.createImagePacker();
      const packOpts: image.PackingOption = {
        format: 'image/jpeg',
        quality: 90
      };

      const imageData: ArrayBuffer = await imagePacker.packing(pixmap, packOpts);

      // ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶
      const timestamp = Date.now();
      tempFilePath = this.context.cacheDir + '/share_state_flag_' + timestamp + '.jpg';

      // ä½¿ç”¨åŒæ­¥æ–‡ä»¶æ“ä½œ
      const fileHandle = fs.openSync(tempFilePath, fs.OpenMode.CREATE | fs.OpenMode.WRITE_ONLY);
      fs.writeSync(fileHandle.fd, imageData);
      fs.closeSync(fileHandle);

      // éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºç©º
      const stat = fs.statSync(tempFilePath);
      if (stat.size === 0) {
        throw new Error('Image file is empty');
      }

      // è·å–æ–‡ä»¶URI
      const imageUri = fileUri.getUriFromPath(tempFilePath);

      // è·å–å›¾ç‰‡ç±»å‹æè¿°ç¬¦
      const utdTypeId = uniformTypeDescriptor.getUniformDataTypeByFilenameExtension('.jpg', uniformTypeDescriptor.UniformDataType.IMAGE);

      // ä½¿ç”¨å›¾ç‰‡URIåˆ†äº«
      const stateName = this.stateInfo.nameCN;
      const shareData = new systemShare.SharedData({
        utd: utdTypeId,
        uri: imageUri,
        title: `${stateName}å·æ——`,
        description: 'æ¥è‡ªå›½æ——å°ç™¾ç§‘'
      });

      const controller = new systemShare.ShareController(shareData);

      // æ˜¾ç¤ºåˆ†äº«é¢æ¿
      await controller.show(this.context, {
        selectionMode: systemShare.SelectionMode.SINGLE,
        previewMode: systemShare.SharePreviewMode.DETAIL
      });

      // åˆ†äº«æˆåŠŸåé‡Šæ”¾ PixelMap
      this.releaseSharePixelMap();

      // å»¶è¿Ÿåˆ é™¤æ–‡ä»¶ï¼Œç¡®ä¿åˆ†äº«å®Œæˆ
      setTimeout(() => {
        if (tempFilePath) {
          try {
            fs.unlinkSync(tempFilePath);
          } catch (unlinkError) {
            console.warn('[StateFlagDetailPage] Failed to delete temp file:', unlinkError);
          }
        }
      }, 5000);

    } catch (err) {
      const error = err as BusinessError;
      console.error(`Failed to share: code: ${error?.code}, message: ${error?.message}`);
      promptAction.showToast({
        message: 'åˆ†äº«å¤±è´¥',
        duration: 2000
      });

      // æ¸…ç†èµ„æº
      this.releaseSharePixelMap();
      if (tempFilePath) {
        try {
          fs.unlinkSync(tempFilePath);
        } catch (e) {
          // ignore
        }
      }
    } finally {
      this.isSharing = false;
    }
  }

  private buildShareText(): string {
    if (!this.countryData || !this.stateInfo) {
      return '';
    }

    const lines: string[] = [];
    lines.push(`ğŸ³ï¸ ${this.stateInfo.nameCN} (${this.stateInfo.name})`);
    lines.push('');
    lines.push(`ğŸ“ æ‰€å±å›½å®¶ï¼š${this.countryData.countryEmoji} ${this.countryData.countryNameCN}`);
    lines.push(`ğŸ›ï¸ é¦–åºœï¼š${this.stateInfo.capitalCN}`);
    lines.push(`ğŸŒ åœ°åŒºï¼š${this.stateInfo.regionCN}`);
    lines.push('');
    lines.push('â€”â€” æ¥è‡ªã€Œå›½æ——å°ç™¾ç§‘ã€');

    return lines.join('\n');
  }
}

