/**
 * æ¶‚é¸¦æ¸¸æˆé¡µé¢
 * ä½¿ç”¨Webç»„ä»¶åŠ è½½HTMLæ¶‚é¸¦æ¸¸æˆ
 */
import router from '@ohos.router';
import web_webview from '@ohos.web.webview';
import common from '@ohos.app.ability.common';
import { ConfigurationConstant } from '@kit.AbilityKit';
import { BusinessError } from '@kit.BasicServicesKit';
import { util } from '@kit.ArkTS';
import curves from '@ohos.curves';
import { getCountryByCode, Country } from '../../utils/countryData';
import { getPaintLevel, getFlagPaintInfo, getTotalLevels, PaintLevel } from './PaintGameData';
import { GameProgressManager, GameType } from '../../utils/GameProgressManager';
import { PreferencesManager } from '../../utils/PreferencesManager';

interface RouterParams {
  categoryId: string;
  levelId: number;
}

// ç¾å›½å·åä¸­æ–‡æ˜ å°„
const US_STATE_NAMES: Record<string, string> = {
  'alabama': 'é˜¿æ‹‰å·´é©¬å·',
  'alaska': 'é˜¿æ‹‰æ–¯åŠ å·',
  'arizona': 'äºšåˆ©æ¡‘é‚£å·',
  'arkansas': 'é˜¿è‚¯è‰²å·',
  'california': 'åŠ åˆ©ç¦å°¼äºšå·',
  'colorado': 'ç§‘ç½—æ‹‰å¤šå·',
  'connecticut': 'åº·æ¶…ç‹„æ ¼å·',
  'delaware': 'ç‰¹æ‹‰åå·',
  'district_of_columbia': 'åç››é¡¿ç‰¹åŒº',
  'florida': 'ä½›ç½—é‡Œè¾¾å·',
  'georgia': 'ä½æ²»äºšå·',
  'hawaii': 'å¤å¨å¤·å·',
  'idaho': 'çˆ±è¾¾è·å·',
  'illinois': 'ä¼Šåˆ©è¯ºä¼Šå·',
  'indiana': 'å°ç¬¬å®‰çº³å·',
  'iowa': 'è‰¾å¥¥ç“¦å·',
  'kansas': 'å ªè¨æ–¯å·',
  'kentucky': 'è‚¯å¡”åŸºå·',
  'louisiana': 'è·¯æ˜“æ–¯å®‰é‚£å·',
  'maine': 'ç¼…å› å·',
  'maryland': 'é©¬é‡Œå…°å·',
  'massachusetts': 'é©¬è¨è¯¸å¡å·',
  'michigan': 'å¯†æ­‡æ ¹å·',
  'minnesota': 'æ˜å°¼è‹è¾¾å·',
  'mississippi': 'å¯†è¥¿è¥¿æ¯”å·',
  'missouri': 'å¯†è‹é‡Œå·',
  'montana': 'è’™å¤§æ‹¿å·',
  'nebraska': 'å†…å¸ƒæ‹‰æ–¯åŠ å·',
  'nevada': 'å†…åè¾¾å·',
  'new_hampshire': 'æ–°ç½•å¸ƒä»€å°”å·',
  'new_jersey': 'æ–°æ³½è¥¿å·',
  'new_mexico': 'æ–°å¢¨è¥¿å“¥å·',
  'new_york': 'çº½çº¦å·',
  'north_carolina': 'åŒ—å¡ç½—æ¥çº³å·',
  'north_dakota': 'åŒ—è¾¾ç§‘ä»–å·',
  'ohio': 'ä¿„äº¥ä¿„å·',
  'oklahoma': 'ä¿„å…‹æ‹‰è·é©¬å·',
  'oregon': 'ä¿„å‹’å†ˆå·',
  'pennsylvania': 'å®¾å¤•æ³•å°¼äºšå·',
  'rhode_island': 'ç½—å¾·å²›å·',
  'south_carolina': 'å—å¡ç½—æ¥çº³å·',
  'south_dakota': 'å—è¾¾ç§‘ä»–å·',
  'tennessee': 'ç”°çº³è¥¿å·',
  'texas': 'å¾·å…‹è¨æ–¯å·',
  'utah': 'çŠ¹ä»–å·',
  'vermont': 'ä½›è’™ç‰¹å·',
  'virginia': 'å¼—å‰å°¼äºšå·',
  'washington': 'åç››é¡¿å·',
  'west_virginia': 'è¥¿å¼—å‰å°¼äºšå·',
  'wisconsin': 'å¨æ–¯åº·æ˜Ÿå·',
  'wyoming': 'æ€€ä¿„æ˜å·'
};

@Entry
@Component
  struct PaintPlayPage {
  @State categoryId: string = 'world';
  @State levelId: number = 1;
  @State currentLevel: PaintLevel | undefined = undefined;
  @State currentFlagIndex: number = 0;
  @State showNextButton: boolean = false;
  @State showHint: boolean = false;
  @State levelCompleted: boolean = false;
  @State isWebReady: boolean = false;
  @State currentFlagPath: string = 'flags/us.svg';
  @State backgroundColorStr: string = '#F5F6F7'; // é»˜è®¤æµ…è‰²èƒŒæ™¯
  @State webOpacity: number = 0; // Web ç»„ä»¶é€æ˜åº¦ï¼Œç”¨äºæ¸æ˜¾åŠ¨ç”»

  private webController: web_webview.WebviewController = new web_webview.WebviewController();
  private context = getContext(this) as common.UIAbilityContext;

  async aboutToAppear() {
    const params = router.getParams() as RouterParams;
    if (params) {
      this.categoryId = params.categoryId || 'world';
      this.levelId = params.levelId || 1;
    }
    this.currentLevel = getPaintLevel(this.categoryId, this.levelId);
    this.updateCurrentFlagPath();
    await this.updateBackgroundColor();
  }

  private async updateBackgroundColor(): Promise<void> {
    try {
      // è¯»å–ä¿å­˜çš„ä¸»é¢˜è®¾ç½®
      const prefs = await PreferencesManager.getPreferences('app_settings');
      const savedColorMode: number = await prefs.get('colorMode', ConfigurationConstant.ColorMode.COLOR_MODE_NOT_SET) as number;
      const colorMode = savedColorMode as ConfigurationConstant.ColorMode;

      let isDarkMode = false;

      if (colorMode === ConfigurationConstant.ColorMode.COLOR_MODE_DARK) {
        // æ˜ç¡®è®¾ç½®ä¸ºæš—é»‘æ¨¡å¼
        isDarkMode = true;
      } else if (colorMode === ConfigurationConstant.ColorMode.COLOR_MODE_NOT_SET) {
        // è·Ÿéšç³»ç»Ÿï¼Œå°è¯•æ£€æµ‹ç³»ç»Ÿä¸»é¢˜
        // é€šè¿‡æ£€æŸ¥èµ„æºç®¡ç†å™¨å½“å‰ä½¿ç”¨çš„èµ„æºç±»å‹æ¥åˆ¤æ–­
        try {
          const resourceManager = this.context.resourceManager;
          const config = await resourceManager.getConfiguration();
          // å¦‚æœ colorMode ä¸º 1ï¼Œè¡¨ç¤ºæš—é»‘æ¨¡å¼
          if (config.colorMode === 1) {
            isDarkMode = true;
          }
        } catch (e) {
          // å¦‚æœæ£€æµ‹å¤±è´¥ï¼Œé»˜è®¤ä½¿ç”¨æµ…è‰²
          console.error(`Failed to detect system theme: ${JSON.stringify(e)}`);
        }
      }

      // è®¾ç½®èƒŒæ™¯è‰²
      if (isDarkMode) {
        // æš—é»‘æ¨¡å¼ä½¿ç”¨æ·±é»‘è‰²ï¼ˆéçº¯é»‘ï¼‰
        this.backgroundColorStr = '#1C1C1E';
      } else {
        // æµ…è‰²æ¨¡å¼ä½¿ç”¨ç°è‰²
        this.backgroundColorStr = '#F5F6F7';
      }

      // å¦‚æœ Web å·²ç»å‡†å¤‡å¥½ï¼Œç«‹å³æ³¨å…¥èƒŒæ™¯è‰²
      if (this.isWebReady) {
        await this.injectBackgroundColor();
      }
    } catch (err) {
      console.error(`Failed to update background color: ${JSON.stringify(err)}`);
      // é»˜è®¤ä½¿ç”¨æµ…è‰²èƒŒæ™¯
      this.backgroundColorStr = '#F5F6F7';
      if (this.isWebReady) {
        await this.injectBackgroundColor();
      }
    }
  }


  private updateCurrentFlagPath(): void {
    if (this.currentLevel) {
      const code = this.currentLevel.flags[this.currentFlagIndex];
      this.currentFlagPath = this.getFlagImagePath(code);
    }
  }

  private getCurrentCountry(): Country | undefined {
    if (!this.currentLevel) return undefined;
    const code = this.currentLevel.flags[this.currentFlagIndex];
    return getCountryByCode(code);
  }

  private getCurrentFlagColors(): string[] {
    if (!this.currentLevel) return [];
    const code = this.currentLevel.flags[this.currentFlagIndex];
    const info = getFlagPaintInfo(code);
    return info ? info.colors : [];
  }

  private async loadSvgAsBase64(countryCode: string): Promise<string> {
    try {
      const resourceManager = this.context.resourceManager;
      const svgPath = `paint_flags/${countryCode}.svg`;
      const uint8Array = await resourceManager.getRawFileContent(svgPath);
      // ä½¿ç”¨ Base64 ç¼–ç 
      const base64Helper = new util.Base64Helper();
      return base64Helper.encodeToStringSync(uint8Array);
    } catch (e) {
      console.error('Failed to load SVG:', e);
      return '';
    }
  }

  private getFlagDisplayName(code: string): string {
    // å…ˆå°è¯•è·å–ç¾å›½å·å
    if (US_STATE_NAMES[code]) {
      return US_STATE_NAMES[code];
    }
    // å¦åˆ™å°è¯•è·å–å›½å®¶åç§°
    const country = getCountryByCode(code);
    return country ? country.nameCN : code;
  }

  private async injectBackgroundColor(): Promise<void> {
    try {
      if (!this.isWebReady) {
        return;
      }
      // ç›´æ¥è°ƒç”¨ HTML ä¸­çš„ setBackgroundColor å‡½æ•°
      await this.webController.runJavaScript(
        `if (typeof setBackgroundColor === 'function') { setBackgroundColor('${this.backgroundColorStr}'); }`
      );
    } catch (e) {
      console.error('Failed to inject background color:', e);
    }
  }

  private async setupGame(): Promise<void> {
    if (!this.currentLevel || !this.isWebReady) return;

    const countryCode = this.currentLevel.flags[this.currentFlagIndex];
    const colors = this.getCurrentFlagColors();

    if (colors.length === 0) {
      console.error('No colors found for:', countryCode);
      return;
    }

    // æ›´æ–°å½“å‰æ——å¸œè·¯å¾„ï¼ˆç”¨äºæç¤ºæ˜¾ç¤ºï¼‰
    this.updateCurrentFlagPath();

    const colorsJson = JSON.stringify(colors);
    const displayName = this.getFlagDisplayName(countryCode);

    // åŠ è½½ SVG å†…å®¹ï¼ˆBase64 ç¼–ç ï¼‰
    const svgBase64 = await this.loadSvgAsBase64(countryCode);

    // è°ƒç”¨JSè®¾ç½®æ¸¸æˆï¼Œä¼ å…¥ Base64 ç¼–ç çš„ SVG å†…å®¹
    try {
      // å…ˆè®¾ç½®èƒŒæ™¯è‰²
      await this.injectBackgroundColor();
      // ç„¶åè®¾ç½®æ¸¸æˆ
      await this.webController.runJavaScript(
        `if (typeof setupPaintGame === 'function') { setupPaintGame('${countryCode}', '${displayName}', ${colorsJson}, '${svgBase64}'); }`
      );
    } catch (e) {
      console.error('Failed to setup game:', e);
    }
  }

  private async onNext(): Promise<void> {
    this.showNextButton = false;
    this.showHint = false;

    if (!this.currentLevel) return;

    if (this.currentFlagIndex < this.currentLevel.flags.length - 1) {
      // ä¸‹ä¸€ä¸ªå›½æ——
      this.currentFlagIndex++;
      await this.setupGame();
    } else {
      // å…³å¡å®Œæˆ
      await this.onLevelComplete();
    }
  }

  private getGameType(): GameType {
    const gameTypeMap: Record<string, GameType> = {
      'world': GameType.PAINT_WORLD,
      'us': GameType.PAINT_US,
      'de': GameType.PAINT_DE,
      'it': GameType.PAINT_IT,
      'br': GameType.PAINT_BR
    };
    return gameTypeMap[this.categoryId] || GameType.PAINT_WORLD;
  }

  private async onLevelComplete(): Promise<void> {
    // ä¿å­˜è¿›åº¦
    await GameProgressManager.init(this.context);
    const gameType = this.getGameType();
    await GameProgressManager.unlockNextLevel(gameType, this.levelId);

    this.levelCompleted = true;
  }

  private async onNextLevel(): Promise<void> {
    const totalLevels = getTotalLevels(this.categoryId);
    if (this.levelId < totalLevels) {
      this.levelId++;
      this.currentLevel = getPaintLevel(this.categoryId, this.levelId);
      this.currentFlagIndex = 0;
      this.levelCompleted = false;
      this.showNextButton = false;
      await this.setupGame();
    } else {
      // æ‰€æœ‰å…³å¡å®Œæˆ
      router.back();
    }
  }

  private onHintTapped(): void {
    this.showHint = !this.showHint;
  }

  private getFlagImagePath(code: string): string {
    // ç¾å›½å·æ——ä½¿ç”¨ state_flags/us/ ç›®å½•
    if (US_STATE_NAMES[code]) {
      return `state_flags/us/${code}.svg`;
    }
    // å…¶ä»–å›½æ——ä½¿ç”¨ flags/ ç›®å½•
    return `flags/${code}.svg`;
  }

  build() {
    Navigation() {
      if (this.levelCompleted) {
        this.LevelCompleteView()
      } else {
        Stack({ alignContent: Alignment.TopStart }) {
          // Webæ¸¸æˆåŒºåŸŸ
          Column() {
            Web({
              src: $rawfile('paint_game.html'),
              controller: this.webController
            })
              .javaScriptAccess(true)
              .domStorageAccess(true)
              .opacity(this.webOpacity)
              .onPageEnd(() => {
                this.isWebReady = true;
                // é¡µé¢åŠ è½½å®Œæˆåï¼Œå…ˆè®¾ç½®èƒŒæ™¯è‰²ï¼Œå†è®¾ç½®æ¸¸æˆï¼Œç„¶åæ¸æ˜¾
                // å…ˆä¿å­˜èƒŒæ™¯è‰²åˆ° windowï¼Œè®© HTML åœ¨ DOMContentLoaded æ—¶å°±èƒ½åº”ç”¨
                this.webController.runJavaScript(
                  `window.savedBackgroundColor = '${this.backgroundColorStr}';`
                ).then(() => {
                  return this.injectBackgroundColor();
                }).then(() => {
                  return this.setupGame();
                }).then(() => {
                  // èƒŒæ™¯è‰²å’Œæ¸¸æˆéƒ½è®¾ç½®å¥½åï¼Œå»¶è¿Ÿä¸€ç‚¹å†æ¸æ˜¾ï¼Œç¡®ä¿èƒŒæ™¯è‰²å·²åº”ç”¨
                  setTimeout(() => {
                    this.webOpacity = 1;
                  }, 200);
                }).catch(() => {
                  console.error('Failed to setup game');
                  // å³ä½¿å‡ºé”™ä¹Ÿæ˜¾ç¤º
                  this.webOpacity = 1;
                });
              })
              .onConsole((event) => {
                if (event) {
                  console.info('WebConsole:', event.message.getMessage());
                }
                return false;
              })
              .javaScriptProxy({
                object: {
                  onPaintCorrect: () => {
                    this.showNextButton = true;
                  },
                  onPaintIncorrect: () => {
                    // é”™è¯¯æ—¶é‡ç½®æ¸¸æˆ
                    setTimeout(() => {
                      this.setupGame();
                    }, 2000);
                  },
                  onPaintSound: () => {
                    // æ’­æ”¾å¡«è‰²éŸ³æ•ˆï¼ˆå¯é€‰ï¼‰
                  }
                },
                name: 'NativeInterface',
                methodList: ['onPaintCorrect', 'onPaintIncorrect', 'onPaintSound'],
                controller: this.webController
              })
              .width('100%')
              .layoutWeight(1)

            // åº•éƒ¨æŒ‰é’®åŒºåŸŸ
            if (this.showNextButton) {
              Button(this.currentFlagIndex < (this.currentLevel?.flags.length || 0) - 1 ? 'ä¸‹ä¸€ä¸ª' : 'å®Œæˆ')
                .width('80%')
                .height(48)
                .fontSize(17)
                .fontWeight(FontWeight.Bold)
                .backgroundColor($r('app.color.button_primary'))
                .margin({ bottom: 32 })
                .onClick(() => {
                  this.onNext();
                })
            }
          }
          .width('100%')
            .height('100%')
            .backgroundColor(this.backgroundColorStr as ResourceColor)
            .transition(TransitionEffect.OPACITY.animation({ duration: 600, curve: curves.cubicBezier(0.4, 0.0, 0.2, 1.0) }))

          // é¡¶éƒ¨çŠ¶æ€æ 
          Row() {
            // è¿”å›æŒ‰é’®
            Image($r('app.media.icon_back'))
              .width(24)
              .height(24)
              .onClick(() => {
                router.back();
              })

            // å…³å¡ä¿¡æ¯
            Column() {
              Text(`ç¬¬ ${this.levelId} å…³`)
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.button_primary'))

              // è¿›åº¦æŒ‡ç¤ºå™¨
              Row({ space: 4 }) {
                ForEach(Array.from({ length: this.currentLevel?.flags.length || 3 }), (_: undefined, index: number) => {
                  Circle()
                    .width(8)
                    .height(8)
                    .fill(index <= this.currentFlagIndex ? '#1677FF' : '#B3E5FC')
                })
              }
              .margin({ top: 4 })
            }
            .layoutWeight(1)
              .alignItems(HorizontalAlign.Center)

            // æç¤ºæŒ‰é’®
            Image($r('app.media.icon_hint'))
              .width(24)
              .height(24)
              .onClick(() => {
                this.onHintTapped();
              })
          }
          .width('100%')
            .height(56)
            .padding({ left: 16, right: 16 })
            .backgroundColor(Color.Transparent)

          // æç¤ºå›½æ——æ˜¾ç¤º
          if (this.showHint) {
            Column() {
              Image($rawfile(this.currentFlagPath))
                .width(140)
                .height(90)
                .objectFit(ImageFit.Contain)
            }
            .width(160)
              .height(110)
              .backgroundColor(Color.White)
              .borderRadius(8)
              .justifyContent(FlexAlign.Center)
              .shadow({
                radius: 8,
                color: 'rgba(0, 0, 0, 0.2)',
                offsetX: 0,
                offsetY: 3
              })
              .position({ x: '50%', y: 70 })
              .translate({ x: '-50%' })
          }
        }
        .width('100%')
          .height('100%')
      }
    }
    .hideTitleBar(true)
      .hideBackButton(true)
  }

  @Builder
  LevelCompleteView() {
    Column() {
      Text('ğŸ‰')
        .fontSize(72)
        .margin({ top: 80 })

      Text('æ­å–œè¿‡å…³ï¼')
        .fontSize(28)
        .fontWeight(FontWeight.Bold)
        .fontColor($r('app.color.text_primary'))
        .margin({ top: 24 })

      Text(`ç¬¬ ${this.levelId} å…³`)
        .fontSize(16)
        .fontColor($r('app.color.text_secondary'))
        .margin({ top: 8 })

      // å®Œæˆçš„å›½æ——å±•ç¤º
      Row({ space: 12 }) {
        ForEach(this.currentLevel?.flags || [], (code: string) => {
          Image($rawfile(this.getFlagImagePath(code)))
            .width(80)
            .height(50)
            .objectFit(ImageFit.Contain)
            .shadow({
              radius: 4,
              color: 'rgba(0, 0, 0, 0.1)',
              offsetX: 0,
              offsetY: 2
            })
        })
      }
      .margin({ top: 32 })

      Blank()

      // ä¸‹ä¸€å…³æŒ‰é’®
      Button(this.levelId < getTotalLevels(this.categoryId) ? 'ä¸‹ä¸€å…³' : 'è¿”å›')
        .width('80%')
        .height(48)
        .fontSize(17)
        .fontWeight(FontWeight.Bold)
        .backgroundColor($r('app.color.button_primary'))
        .margin({ bottom: 16 })
        .onClick(() => {
          this.onNextLevel();
        })

      // è¿”å›æŒ‰é’®
      Button('è¿”å›')
        .width('80%')
        .height(48)
        .fontSize(17)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.button_primary'))
        .backgroundColor(Color.Transparent)
        .border({ width: 1, color: $r('app.color.button_primary') })
        .margin({ bottom: 32 })
        .onClick(() => {
          router.back();
        })
    }
    .width('100%')
      .height('100%')
      .backgroundColor($r('app.color.bg_page'))
  }
}

