/**
 * æ¶‚é¸¦æ¸¸æˆé¡µé¢
 * ä½¿ç”¨Webç»„ä»¶åŠ è½½HTMLæ¶‚é¸¦æ¸¸æˆ
 */
import router from '@ohos.router';
import web_webview from '@ohos.web.webview';
import common from '@ohos.app.ability.common';
import promptAction from '@ohos.promptAction';
import { BusinessError } from '@kit.BasicServicesKit';
import { util } from '@kit.ArkTS';
import curves from '@ohos.curves';
import { getCountryByCode, Country, getLocalizedCountryName } from '../../utils/countryData';
import { getPaintLevel, getFlagPaintInfo, getTotalLevels, PaintLevel } from './PaintGameData';
import { GameProgressManager, GameType } from '../../utils/GameProgressManager';
import { SoundEffectUtil, SoundType } from '../../utils/SoundEffectUtil';
import { VibratorUtil } from '../../utils/VibratorUtil';
import { LocalizationUtil } from '../../utils/LocalizationUtil';

interface RouterParams {
  categoryId: string;
  levelId: number;
}

// ç¾å›½å·åä¸­æ–‡æ˜ å°„
const US_STATE_NAMES_CN: Record<string, string> = {
  'alabama': 'é˜¿æ‹‰å·´é©¬å·',
  'alaska': 'é˜¿æ‹‰æ–¯åŠ å·',
  'arizona': 'äºšåˆ©æ¡‘é‚£å·',
  'arkansas': 'é˜¿è‚¯è‰²å·',
  'california': 'åŠ åˆ©ç¦å°¼äºšå·',
  'colorado': 'ç§‘ç½—æ‹‰å¤šå·',
  'connecticut': 'åº·æ¶…ç‹„æ ¼å·',
  'delaware': 'ç‰¹æ‹‰åå·',
  'district_of_columbia': 'åç››é¡¿ç‰¹åŒº',
  'florida': 'ä½›ç½—é‡Œè¾¾å·',
  'georgia': 'ä½æ²»äºšå·',
  'hawaii': 'å¤å¨å¤·å·',
  'idaho': 'çˆ±è¾¾è·å·',
  'illinois': 'ä¼Šåˆ©è¯ºä¼Šå·',
  'indiana': 'å°ç¬¬å®‰çº³å·',
  'iowa': 'è‰¾å¥¥ç“¦å·',
  'kansas': 'å ªè¨æ–¯å·',
  'kentucky': 'è‚¯å¡”åŸºå·',
  'louisiana': 'è·¯æ˜“æ–¯å®‰é‚£å·',
  'maine': 'ç¼…å› å·',
  'maryland': 'é©¬é‡Œå…°å·',
  'massachusetts': 'é©¬è¨è¯¸å¡å·',
  'michigan': 'å¯†æ­‡æ ¹å·',
  'minnesota': 'æ˜å°¼è‹è¾¾å·',
  'mississippi': 'å¯†è¥¿è¥¿æ¯”å·',
  'missouri': 'å¯†è‹é‡Œå·',
  'montana': 'è’™å¤§æ‹¿å·',
  'nebraska': 'å†…å¸ƒæ‹‰æ–¯åŠ å·',
  'nevada': 'å†…åè¾¾å·',
  'new_hampshire': 'æ–°ç½•å¸ƒä»€å°”å·',
  'new_jersey': 'æ–°æ³½è¥¿å·',
  'new_mexico': 'æ–°å¢¨è¥¿å“¥å·',
  'new_york': 'çº½çº¦å·',
  'north_carolina': 'åŒ—å¡ç½—æ¥çº³å·',
  'north_dakota': 'åŒ—è¾¾ç§‘ä»–å·',
  'ohio': 'ä¿„äº¥ä¿„å·',
  'oklahoma': 'ä¿„å…‹æ‹‰è·é©¬å·',
  'oregon': 'ä¿„å‹’å†ˆå·',
  'pennsylvania': 'å®¾å¤•æ³•å°¼äºšå·',
  'rhode_island': 'ç½—å¾·å²›å·',
  'south_carolina': 'å—å¡ç½—æ¥çº³å·',
  'south_dakota': 'å—è¾¾ç§‘ä»–å·',
  'tennessee': 'ç”°çº³è¥¿å·',
  'texas': 'å¾·å…‹è¨æ–¯å·',
  'utah': 'çŠ¹ä»–å·',
  'vermont': 'ä½›è’™ç‰¹å·',
  'virginia': 'å¼—å‰å°¼äºšå·',
  'washington': 'åç››é¡¿å·',
  'west_virginia': 'è¥¿å¼—å‰å°¼äºšå·',
  'wisconsin': 'å¨æ–¯åº·æ˜Ÿå·',
  'wyoming': 'æ€€ä¿„æ˜å·'
};

// ç¾å›½å·åè‹±æ–‡æ˜ å°„
const US_STATE_NAMES_EN: Record<string, string> = {
  'alabama': 'Alabama',
  'alaska': 'Alaska',
  'arizona': 'Arizona',
  'arkansas': 'Arkansas',
  'california': 'California',
  'colorado': 'Colorado',
  'connecticut': 'Connecticut',
  'delaware': 'Delaware',
  'district_of_columbia': 'District of Columbia',
  'florida': 'Florida',
  'georgia': 'Georgia',
  'hawaii': 'Hawaii',
  'idaho': 'Idaho',
  'illinois': 'Illinois',
  'indiana': 'Indiana',
  'iowa': 'Iowa',
  'kansas': 'Kansas',
  'kentucky': 'Kentucky',
  'louisiana': 'Louisiana',
  'maine': 'Maine',
  'maryland': 'Maryland',
  'massachusetts': 'Massachusetts',
  'michigan': 'Michigan',
  'minnesota': 'Minnesota',
  'mississippi': 'Mississippi',
  'missouri': 'Missouri',
  'montana': 'Montana',
  'nebraska': 'Nebraska',
  'nevada': 'Nevada',
  'new_hampshire': 'New Hampshire',
  'new_jersey': 'New Jersey',
  'new_mexico': 'New Mexico',
  'new_york': 'New York',
  'north_carolina': 'North Carolina',
  'north_dakota': 'North Dakota',
  'ohio': 'Ohio',
  'oklahoma': 'Oklahoma',
  'oregon': 'Oregon',
  'pennsylvania': 'Pennsylvania',
  'rhode_island': 'Rhode Island',
  'south_carolina': 'South Carolina',
  'south_dakota': 'South Dakota',
  'tennessee': 'Tennessee',
  'texas': 'Texas',
  'utah': 'Utah',
  'vermont': 'Vermont',
  'virginia': 'Virginia',
  'washington': 'Washington',
  'west_virginia': 'West Virginia',
  'wisconsin': 'Wisconsin',
  'wyoming': 'Wyoming'
};

@Entry
@Component
  struct PaintPlayPage {
  @State categoryId: string = 'world';
  @State levelId: number = 1;
  @State currentLevel: PaintLevel | undefined = undefined;
  @State currentFlagIndex: number = 0;
  @State showNextButton: boolean = false;
  @State showNextButtonAnimated: boolean = false; // æŒ‰é’®åŠ¨ç”»çŠ¶æ€
  @State showHint: boolean = false;
  @State levelCompleted: boolean = false;
  @State isWebReady: boolean = false;
  @State currentFlagPath: string = 'flags/us.svg';
  @State webOpacity: number = 0; // Web ç»„ä»¶é€æ˜åº¦ï¼Œç”¨äºæ¸æ˜¾åŠ¨ç”»
  @State contentTranslateY: number = 0; // å†…å®¹å‘ä¸Šç§»åŠ¨çš„è·ç¦»
  @State showButtons: boolean = false; // æŒ‰é’®æ˜¯å¦æ˜¾ç¤º
  @StorageLink('currentLanguage') currentLanguage: string = 'zh';

  private get isEnglish(): boolean {
    return LocalizationUtil.isEnglish(this.currentLanguage);
  }

  private webController: web_webview.WebviewController = new web_webview.WebviewController();
  private context = getContext(this) as common.UIAbilityContext;
  private timeoutIds: number[] = []; // å­˜å‚¨æ‰€æœ‰setTimeoutçš„IDï¼Œç”¨äºæ¸…ç†

  async aboutToAppear() {
    // åˆå§‹åŒ–éŸ³æ•ˆæ’­æ”¾å™¨å’ŒæŒ¯åŠ¨å·¥å…·
    await SoundEffectUtil.init(this.context);
    await VibratorUtil.init(this.context);

    const params = router.getParams() as RouterParams;
    if (params) {
      this.categoryId = params.categoryId || 'world';
      this.levelId = params.levelId || 1;
    }
    
    // æ£€æŸ¥å…³å¡æ˜¯å¦æœ‰æ•ˆ
    const totalLevels = getTotalLevels(this.categoryId);
    if (this.levelId > totalLevels) {
      // å…³å¡è¶…å‡ºèŒƒå›´ï¼Œè¿”å›é¦–é¡µ
      promptAction.showToast({
        message: this.context.resourceManager.getStringSync($r('app.string.level_not_found').id),
        duration: 2000
      });
      setTimeout(() => {
        router.back();
      }, 500);
      return;
    }
    
    this.currentLevel = getPaintLevel(this.categoryId, this.levelId);
    if (!this.currentLevel) {
      // å…³å¡æ•°æ®ä¸å­˜åœ¨ï¼Œè¿”å›é¦–é¡µ
      promptAction.showToast({
        message: this.context.resourceManager.getStringSync($r('app.string.level_data_load_failed').id),
        duration: 2000
      });
      setTimeout(() => {
        router.back();
      }, 500);
      return;
    }
    this.updateCurrentFlagPath();
  }

  aboutToDisappear() {
    // æ¸…ç†æ‰€æœ‰setTimeout
    this.clearAllTimeouts();
    // é‡Šæ”¾éŸ³æ•ˆèµ„æº
    SoundEffectUtil.release();
  }

  private clearAllTimeouts(): void {
    for (const id of this.timeoutIds) {
      clearTimeout(id);
    }
    this.timeoutIds = [];
  }

  private updateCurrentFlagPath(): void {
    if (this.currentLevel) {
      const code = this.currentLevel.flags[this.currentFlagIndex];
      this.currentFlagPath = this.getFlagImagePath(code);
    }
  }

  private getCurrentCountry(): Country | undefined {
    if (!this.currentLevel) return undefined;
    const code = this.currentLevel.flags[this.currentFlagIndex];
    return getCountryByCode(code);
  }

  private getCurrentFlagColors(): string[] {
    if (!this.currentLevel) return [];
    const code = this.currentLevel.flags[this.currentFlagIndex];
    const info = getFlagPaintInfo(code);
    return info ? info.colors : [];
  }

  private async loadSvgAsBase64(countryCode: string): Promise<string> {
    try {
      const resourceManager = this.context.resourceManager;
      const svgPath = `paint_flags/${countryCode}.svg`;
      const uint8Array = await resourceManager.getRawFileContent(svgPath);
      // ä½¿ç”¨ Base64 ç¼–ç 
      const base64Helper = new util.Base64Helper();
      return base64Helper.encodeToStringSync(uint8Array);
    } catch (e) {
      console.error('Failed to load SVG:', e);
      return '';
    }
  }

  private getFlagDisplayName(code: string): string {
    const isEnglish = LocalizationUtil.isEnglish(this.currentLanguage);
    
    // å…ˆå°è¯•è·å–ç¾å›½å·å
    if (US_STATE_NAMES_EN[code] || US_STATE_NAMES_CN[code]) {
      // è¿™æ˜¯ç¾å›½å·æ——ï¼Œç›´æ¥è¿”å›å·å
      if (isEnglish) {
        return US_STATE_NAMES_EN[code];
      } else {
        return US_STATE_NAMES_CN[code];
      }
    }
    
    // å¦åˆ™å°è¯•è·å–å›½å®¶æœ¬åœ°åŒ–åç§°
    const country = getCountryByCode(code);
    return country ? getLocalizedCountryName(country, this.currentLanguage) : code;
  }


  private async setupGame(): Promise<void> {
    if (!this.currentLevel || !this.isWebReady) {
      return;
    }

    const countryCode = this.currentLevel.flags[this.currentFlagIndex];
    const colors = this.getCurrentFlagColors();

    if (colors.length === 0) {
      console.error('No colors found for:', countryCode);
      return;
    }

    // æ›´æ–°å½“å‰æ——å¸œè·¯å¾„ï¼ˆç”¨äºæç¤ºæ˜¾ç¤ºï¼‰
    this.updateCurrentFlagPath();

    const colorsJson = JSON.stringify(colors);
    const displayName = this.getFlagDisplayName(countryCode);

    // åŠ è½½ SVG å†…å®¹ï¼ˆBase64 ç¼–ç ï¼‰
    const svgBase64 = await this.loadSvgAsBase64(countryCode);

    // è°ƒç”¨JSè®¾ç½®æ¸¸æˆ
    try {
      const escapedDisplayName = displayName.replace(/'/g, "\\'").replace(/"/g, '\\"');
      const setupGameCode = `if (typeof setupPaintGame === 'function') { setupPaintGame('${countryCode}', '${escapedDisplayName}', ${colorsJson}, '${svgBase64}'); }`;
      await this.webController.runJavaScript(setupGameCode);
    } catch (e) {
      console.error('Failed to setup game:', e);
    }
  }

  private async onNext(): Promise<void> {
    // æ’­æ”¾æŒ‰é’®ç‚¹å‡»éŸ³æ•ˆå’ŒæŒ¯åŠ¨
    await SoundEffectUtil.playButton();
    VibratorUtil.vibrateTap();
    
    this.showNextButton = false;
    this.showNextButtonAnimated = false;
    this.showHint = false;

    if (!this.currentLevel) return;

    if (this.currentFlagIndex < this.currentLevel.flags.length - 1) {
      // ä¸‹ä¸€ä¸ªå›½æ——
      this.currentFlagIndex++;
      await this.setupGame();
    } else {
      // å…³å¡å®Œæˆ
      await this.onLevelComplete();
    }
  }

  private getGameType(): GameType {
    const gameTypeMap: Record<string, GameType> = {
      'world': GameType.PAINT_WORLD,
      'us': GameType.PAINT_US
    };
    return gameTypeMap[this.categoryId] || GameType.PAINT_WORLD;
  }

  private async onLevelComplete(): Promise<void> {
    // æ’­æ”¾æ­å–œéŸ³æ•ˆå’ŒæŒ¯åŠ¨
    await SoundEffectUtil.playCongrats();
    VibratorUtil.vibrateWin();
    
    // ä¿å­˜è¿›åº¦ï¼ˆé˜²æ­¢æº¢å‡ºï¼‰
    await GameProgressManager.init(this.context);
    const gameType = this.getGameType();
    const totalLevels = getTotalLevels(this.categoryId);
    
    // åªæœ‰åœ¨æœªå®Œæˆæ‰€æœ‰å…³å¡æ—¶æ‰è§£é”ä¸‹ä¸€å…³ï¼ˆé˜²æ­¢æº¢å‡ºï¼‰
    if (this.levelId < totalLevels) {
      await GameProgressManager.unlockNextLevel(gameType, this.levelId, totalLevels);
    } else {
      // å·²å®Œæˆæ‰€æœ‰å…³å¡ï¼Œç¡®ä¿è¿›åº¦ä¸è¶…è¿‡æ€»å…³å¡æ•°
      await GameProgressManager.setUnlockedLevel(gameType, totalLevels);
    }

    // è®¾ç½®å®ŒæˆçŠ¶æ€ï¼Œå†…å®¹ä»åº•éƒ¨å¼€å§‹ï¼ˆåˆå§‹ä½ç½®åœ¨å±å¹•ä¸‹æ–¹ï¼‰
    this.levelCompleted = true;
    this.contentTranslateY = 200; // åˆå§‹ä½ç½®åœ¨å±å¹•ä¸‹æ–¹200px
    
    // å»¶è¿Ÿä¸€å¸§åè§¦å‘å‘ä¸Šç§»åŠ¨åŠ¨ç”»ï¼ˆä»åº•éƒ¨å‘ä¸Šæ»‘å…¥ï¼‰
    const id1 = setTimeout(() => {
      animateTo({
        duration: 1200,
        curve: Curve.EaseOut
      }, () => {
        this.contentTranslateY = 0; // ç§»åŠ¨åˆ°æœ€ç»ˆä½ç½®ï¼ˆåŸå§‹ä½ç½®ï¼‰
      });
      // ç§»é™¤å·²æ‰§è¡Œçš„å®šæ—¶å™¨ID
      const index1 = this.timeoutIds.indexOf(id1);
      if (index1 > -1) {
        this.timeoutIds.splice(index1, 1);
      }
    }, 50);
    this.timeoutIds.push(id1);

    // å»¶è¿Ÿæ˜¾ç¤ºæŒ‰é’®ï¼ˆåœ¨åŠ¨ç”»å’ŒéŸ³æ•ˆæ’­æ”¾åï¼‰
    const id2 = setTimeout(() => {
      this.showButtons = true;
      // ç§»é™¤å·²æ‰§è¡Œçš„å®šæ—¶å™¨ID
      const index2 = this.timeoutIds.indexOf(id2);
      if (index2 > -1) {
        this.timeoutIds.splice(index2, 1);
      }
    }, 1300);
    this.timeoutIds.push(id2);
  }

  private async onNextLevel(): Promise<void> {
    // æ’­æ”¾æŒ‰é’®ç‚¹å‡»éŸ³æ•ˆå’ŒæŒ¯åŠ¨
    await SoundEffectUtil.playButton();
    VibratorUtil.vibrateTap();
    
    // é‡ç½®åŠ¨ç”»çŠ¶æ€
    this.contentTranslateY = 0;
    this.showButtons = false;
    
    const totalLevels = getTotalLevels(this.categoryId);
    
    // é˜²æ­¢å…³å¡æº¢å‡º
    if (this.levelId >= totalLevels) {
      // æ‰€æœ‰å…³å¡å®Œæˆï¼Œè¿”å›é¦–é¡µ
      router.back();
      return;
    }
    
    // è¿›å…¥ä¸‹ä¸€å…³ï¼ˆç¡®ä¿ä¸è¶…è¿‡æ€»å…³å¡æ•°ï¼‰
    const nextLevel = this.levelId + 1;
    if (nextLevel <= totalLevels) {
      this.levelId = nextLevel;
      this.currentLevel = getPaintLevel(this.categoryId, this.levelId);
      if (!this.currentLevel) {
        // å…³å¡æ•°æ®ä¸å­˜åœ¨ï¼Œè¿”å›é¦–é¡µ
        promptAction.showToast({
          message: this.context.resourceManager.getStringSync($r('app.string.level_data_load_failed').id),
          duration: 2000
        });
        router.back();
        return;
      }
      this.currentFlagIndex = 0;
      this.levelCompleted = false;
      this.showNextButton = false;
      this.showNextButtonAnimated = false;
      await this.setupGame();
    } else {
      // æ‰€æœ‰å…³å¡å®Œæˆ
      router.back();
    }
  }

  private async onHintTapped(): Promise<void> {
    // æ’­æ”¾æç¤ºéŸ³æ•ˆå’ŒæŒ¯åŠ¨
    await SoundEffectUtil.playSound(SoundType.HINT);
    VibratorUtil.vibrateTap();
    this.showHint = !this.showHint;
  }

  private getFlagImagePath(code: string): string {
    // ç¾å›½å·æ——ä½¿ç”¨ state_flags/us/ ç›®å½•
    if (US_STATE_NAMES_CN[code]) {
      return `state_flags/us/${code}.svg`;
    }
    // å…¶ä»–å›½æ——ä½¿ç”¨ flags/ ç›®å½•
    return `flags/${code}.svg`;
  }

  build() {
    Navigation() {
      if (this.levelCompleted) {
        this.LevelCompleteView()
      } else {
        Stack({ alignContent: Alignment.TopStart }) {
          // Webæ¸¸æˆåŒºåŸŸ
          Column() {
            Web({
              src: $rawfile('paint_game.html'),
              controller: this.webController
            })
              .javaScriptAccess(true)
              .domStorageAccess(true)
              .backgroundColor($r('app.color.bg_page'))
              .opacity(this.webOpacity)
              .transition(TransitionEffect.OPACITY.animation({ duration: 400, curve: curves.cubicBezier(0.42, 0, 0.58, 1) }))
              .onPageEnd(() => {
                this.isWebReady = true;
                // ç­‰å¾… HTML å’Œ JavaScript å‡½æ•°åŠ è½½å®Œæˆ
                const id = setTimeout(() => {
                  this.setupGame().then(() => {
                    // ä½¿ç”¨åŠ¨ç”»æ¸æ˜¾
                    animateTo({
                      duration: 300,
                      curve: curves.cubicBezier(0.42, 0, 0.58, 1)
                    }, () => {
                      this.webOpacity = 1;
                    });
                  }).catch(() => {
                    // å³ä½¿å‡ºé”™ä¹Ÿæ˜¾ç¤º
                    animateTo({
                      duration: 300,
                      curve: curves.cubicBezier(0.42, 0, 0.58, 1)
                    }, () => {
                      this.webOpacity = 1;
                    });
                  });
                  // ç§»é™¤å·²æ‰§è¡Œçš„å®šæ—¶å™¨ID
                  const index = this.timeoutIds.indexOf(id);
                  if (index > -1) {
                    this.timeoutIds.splice(index, 1);
                  }
                }, 150);
                this.timeoutIds.push(id);
              })
              .onConsole((event) => {
                if (event) {
                  console.info('WebConsole:', event.message.getMessage());
                }
                return false;
              })
              .javaScriptProxy({
                object: {
                  onPaintCorrect: async () => {
                    // æ’­æ”¾æ­£ç¡®ç­”æ¡ˆéŸ³æ•ˆå’ŒæŒ¯åŠ¨
                    await SoundEffectUtil.playCorrect();
                    VibratorUtil.vibrateCorrect();
                    // å»¶è¿Ÿæ˜¾ç¤ºæŒ‰é’®ï¼ˆåœ¨éŸ³æ•ˆæ’­æ”¾åï¼‰
                    this.showNextButton = true;
                    const id1 = setTimeout(() => {
                      this.showNextButtonAnimated = true;
                      // ç§»é™¤å·²æ‰§è¡Œçš„å®šæ—¶å™¨ID
                      const index1 = this.timeoutIds.indexOf(id1);
                      if (index1 > -1) {
                        this.timeoutIds.splice(index1, 1);
                      }
                    }, 400);
                    this.timeoutIds.push(id1);
                  },
                  onPaintIncorrect: async () => {
                    // æ’­æ”¾é”™è¯¯ç­”æ¡ˆéŸ³æ•ˆå’ŒæŒ¯åŠ¨
                    await SoundEffectUtil.playIncorrect();
                    VibratorUtil.vibrateIncorrect();
                    // é”™è¯¯æ—¶é‡ç½®æ¸¸æˆ
                    const id2 = setTimeout(() => {
                      this.setupGame();
                      // ç§»é™¤å·²æ‰§è¡Œçš„å®šæ—¶å™¨ID
                      const index2 = this.timeoutIds.indexOf(id2);
                      if (index2 > -1) {
                        this.timeoutIds.splice(index2, 1);
                      }
                    }, 2000);
                    this.timeoutIds.push(id2);
                  },
                  onPaintSound: async () => {
                    // æ’­æ”¾å¡«è‰²éŸ³æ•ˆ
                    await SoundEffectUtil.playSound(SoundType.TAP);
                  }
                },
                name: 'NativeInterface',
                methodList: ['onPaintCorrect', 'onPaintIncorrect', 'onPaintSound'],
                controller: this.webController
              })
              .width('100%')
              .layoutWeight(1)

            // åº•éƒ¨æŒ‰é’®åŒºåŸŸï¼ˆå»¶è¿Ÿæ˜¾ç¤ºï¼‰
            if (this.showNextButton) {
              Button(this.currentFlagIndex < (this.currentLevel?.flags.length || 0) - 1 
                ? this.context.resourceManager.getStringSync($r('app.string.next').id)
                : this.context.resourceManager.getStringSync($r('app.string.complete').id))
                .width('80%')
                .height(48)
                .fontSize(17)
                .fontWeight(FontWeight.Bold)
                .backgroundColor($r('app.color.button_primary'))
                .margin({ bottom: 32 })
                .opacity(this.showNextButtonAnimated ? 1 : 0)
                .scale({ x: this.showNextButtonAnimated ? 1 : 0.8, y: this.showNextButtonAnimated ? 1 : 0.8 })
                .animation({
                  duration: 300,
                  curve: Curve.EaseOut
                })
                .onClick(async () => {
                  await this.onNext();
                })
            }
          }
          .width('100%')
            .height('100%')
            .backgroundColor($r('app.color.bg_page'))
            .transition(TransitionEffect.OPACITY.animation({ duration: 600, curve: curves.cubicBezier(0.4, 0.0, 0.2, 1.0) }))

          // é¡¶éƒ¨çŠ¶æ€æ 
          Row() {
            // è¿”å›æŒ‰é’®
            Image($r('app.media.icon_back'))
              .width(24)
              .height(24)
              .onClick(async () => {
                await SoundEffectUtil.playButton();
                VibratorUtil.vibrateTap();
                router.back();
              })

            // å…³å¡ä¿¡æ¯
            Column() {
              Text(this.context.resourceManager.getStringSync($r('app.string.level_number').id, this.levelId.toString()))
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.button_primary'))

              // è¿›åº¦æŒ‡ç¤ºå™¨
              Row({ space: 4 }) {
                ForEach(Array.from({ length: this.currentLevel?.flags.length || 3 }), (_: undefined, index: number) => {
                  Circle()
                    .width(8)
                    .height(8)
                    .fill(index <= this.currentFlagIndex ? '#1677FF' : '#B3E5FC')
                })
              }
              .margin({ top: 4 })
            }
            .layoutWeight(1)
              .alignItems(HorizontalAlign.Center)

            // æç¤ºæŒ‰é’®
            Image($r('app.media.icon_hint'))
              .width(24)
              .height(24)
              .onClick(() => {
                this.onHintTapped();
              })
          }
          .width('100%')
            .height(56)
            .padding({ left: 16, right: 16 })
            .backgroundColor(Color.Transparent)

          // æç¤ºå›½æ——æ˜¾ç¤º
          if (this.showHint) {
            Column() {
              Image($rawfile(this.currentFlagPath))
                .width(140)
                .height(90)
                .objectFit(ImageFit.Contain)
            }
            .width(160)
              .height(110)
              .backgroundColor(Color.White)
              .borderRadius(8)
              .justifyContent(FlexAlign.Center)
              .shadow({
                radius: 8,
                color: 'rgba(0, 0, 0, 0.2)',
                offsetX: 0,
                offsetY: 3
              })
              .position({ x: '50%', y: 70 })
              .translate({ x: '-50%' })
          }
        }
        .width('100%')
          .height('100%')
      }
    }
    .hideTitleBar(true)
      .hideBackButton(true)
  }

  @Builder
  LevelCompleteView() {
    Column() {
      // å†…å®¹åŒºåŸŸï¼ˆä»åº•éƒ¨å‘ä¸Šæ»‘å…¥ï¼‰
      Column() {
        Text('ğŸ‰')
          .fontSize(72)
          .margin({ top: 80 })

        Text($r('app.string.congratulations'))
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))
          .margin({ top: 24 })

        Text(this.context.resourceManager.getStringSync($r('app.string.level_number').id, this.levelId.toString()))
          .fontSize(16)
          .fontColor($r('app.color.text_secondary'))
          .margin({ top: 8 })

        // å®Œæˆçš„å›½æ——å±•ç¤º
        Row({ space: 12 }) {
          ForEach(this.currentLevel?.flags || [], (code: string) => {
            Image($rawfile(this.getFlagImagePath(code)))
              .width(80)
              .height(50)
              .objectFit(ImageFit.Contain)
              .shadow({
                radius: 4,
                color: 'rgba(0, 0, 0, 0.1)',
                offsetX: 0,
                offsetY: 2
              })
          })
        }
        .margin({ top: 32 })
      }
      .width('100%')
        .translate({ y: this.contentTranslateY })
        .animation({
          duration: 1200,
          curve: Curve.EaseOut
        })

      Blank()

      // æŒ‰é’®åŒºåŸŸï¼ˆå»¶è¿Ÿæ˜¾ç¤ºï¼‰
      if (this.showButtons) {
        Column() {
          // ä¸‹ä¸€å…³æŒ‰é’®
          Button(this.levelId < getTotalLevels(this.categoryId) 
            ? this.context.resourceManager.getStringSync($r('app.string.next_level').id)
            : this.context.resourceManager.getStringSync($r('app.string.perfect_finish').id))
            .width('80%')
            .height(48)
            .fontSize(17)
            .fontWeight(FontWeight.Bold)
            .backgroundColor($r('app.color.button_primary'))
            .margin({ bottom: 16 })
            .opacity(this.showButtons ? 1 : 0)
            .scale({ x: this.showButtons ? 1 : 0.8, y: this.showButtons ? 1 : 0.8 })
            .animation({
              duration: 300,
              curve: Curve.EaseOut
            })
            .onClick(async () => {
              if (this.levelId < getTotalLevels(this.categoryId)) {
                await this.onNextLevel();
              } else {
                // å®Œç¾æ”¶å®˜ï¼Œé€€å‡º
                await SoundEffectUtil.playButton();
                VibratorUtil.vibrateTap();
                router.back();
              }
            })

          // è¿”å›æŒ‰é’®
          Button(this.context.resourceManager.getStringSync($r('app.string.back').id))
            .width('80%')
            .height(48)
            .fontSize(17)
            .fontWeight(FontWeight.Medium)
            .fontColor($r('app.color.button_primary'))
            .backgroundColor(Color.Transparent)
            .border({ width: 1, color: $r('app.color.button_primary') })
            .margin({ bottom: 32 })
            .opacity(this.showButtons ? 1 : 0)
            .scale({ x: this.showButtons ? 1 : 0.8, y: this.showButtons ? 1 : 0.8 })
            .animation({
              duration: 300,
              curve: Curve.EaseOut,
              delay: 100
            })
            .onClick(async () => {
              await SoundEffectUtil.playButton();
              VibratorUtil.vibrateTap();
              router.back();
            })
        }
        .width('100%')
      }
    }
    .width('100%')
      .height('100%')
      .backgroundColor($r('app.color.bg_page'))
  }
}

