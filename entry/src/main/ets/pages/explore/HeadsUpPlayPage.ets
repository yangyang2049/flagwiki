import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import common from '@ohos.app.ability.common';
import curves from '@ohos.curves';
import { Country, Countries, getFlagImageSource } from '../../utils/countryData';
import { PreferencesManager } from '../../utils/PreferencesManager';
import { SoundEffectUtil } from '../../utils/SoundEffectUtil';
import { VibratorUtil } from '../../utils/VibratorUtil';
import { LocalizationUtil } from '../../utils/LocalizationUtil';
import { getContentMaxWidth } from '../../utils/LayoutHelper';

const QUESTIONS_PER_SESSION = 10;
const PREFS_NAME = 'heads_up_settings';
const KEY_FIRST_TIME = 'has_shown_tutorial';

@Entry
@Component
export struct HeadsUpPlayPage {
  @State currentCountry: Country | undefined = undefined;
  @State showAnswer: boolean = false;
  @State currentIndex: number = 0;
  @State sessionCountries: Country[] = [];
  @State showSessionOver: boolean = false;
  @State sessionNumber: number = 1;
  @StorageLink('currentLanguage') currentLanguage: string = 'zh';
  @State isEnglish: boolean = false;
  @State flagOpacity: number = 0;
  @State enableFlagTransition: boolean = false;
  private context = getContext(this) as common.UIAbilityContext;

  async aboutToAppear() {
    // åˆå§‹åŒ–éŸ³æ•ˆæ’­æ”¾å™¨å’ŒæŒ¯åŠ¨å·¥å…·
    await SoundEffectUtil.init(this.context);
    await VibratorUtil.init(this.context);
    
    // è·å–å½“å‰è¯­è¨€
    this.isEnglish = LocalizationUtil.isEnglish(this.currentLanguage);
    
    await this.checkAndShowTutorial();
    this.startNewSession();
  }

  aboutToDisappear() {
    // é‡Šæ”¾éŸ³æ•ˆèµ„æº
    SoundEffectUtil.release();
  }

  private async checkAndShowTutorial(): Promise<void> {
    try {
      const prefs = await PreferencesManager.getPreferences(PREFS_NAME);
      const hasShown = await prefs.get(KEY_FIRST_TIME, false) as boolean;
      
      if (!hasShown) {
        // é¦–æ¬¡è¿›å…¥ï¼Œæ˜¾ç¤ºæç¤ºå¼¹çª—
        promptAction.showDialog({
          title: this.context.resourceManager.getStringSync($r('app.string.headsup_tutorial_title').id),
          message: this.context.resourceManager.getStringSync($r('app.string.headsup_tutorial_message').id),
          buttons: [
            { text: this.context.resourceManager.getStringSync($r('app.string.got_it').id), color: '#1677FF' }
          ]
        }).then(() => {
          // ä¿å­˜å·²æ˜¾ç¤ºçŠ¶æ€
          this.saveTutorialShown();
        }).catch(() => {
          // å³ä½¿å–æ¶ˆä¹Ÿä¿å­˜ï¼Œé¿å…é‡å¤æ˜¾ç¤º
          this.saveTutorialShown();
        });
      }
    } catch (err) {
      console.error(`Failed to check tutorial: ${JSON.stringify(err)}`);
    }
  }

  private async saveTutorialShown(): Promise<void> {
    try {
      const prefs = await PreferencesManager.getPreferences(PREFS_NAME);
      await prefs.put(KEY_FIRST_TIME, true);
      await prefs.flush();
    } catch (err) {
      console.error(`Failed to save tutorial status: ${JSON.stringify(err)}`);
    }
  }

  private startNewSession(): void {
    this.sessionCountries = this.generateRandomCountries(QUESTIONS_PER_SESSION);
    this.currentIndex = 0;
    this.showAnswer = false;
    this.showSessionOver = false;
    this.flagOpacity = 0;
    this.enableFlagTransition = true;
    this.loadNextCountry();
  }

  private generateRandomCountries(count: number): Country[] {
    // ä½¿ç”¨ Fisher-Yates æ´—ç‰Œç®—æ³•ç¡®ä¿çœŸæ­£çš„éšæœº
    const shuffled = [...Countries];
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      // ä½¿ç”¨ä¸´æ—¶å˜é‡äº¤æ¢å…ƒç´ ï¼ˆArkTS ä¸æ”¯æŒè§£æ„èµ‹å€¼ï¼‰
      const temp = shuffled[i];
      shuffled[i] = shuffled[j];
      shuffled[j] = temp;
    }
    return shuffled.slice(0, count);
  }

  private loadNextCountry(): void {
    if (this.currentIndex < this.sessionCountries.length) {
      // å¦‚æœæœ‰å½“å‰å›½æ——ï¼Œç«‹å³éšè—ï¼ˆä¸ä½¿ç”¨åŠ¨ç”»ï¼‰
      if (this.currentCountry) {
        // ç¦ç”¨ transitionï¼Œç«‹å³å°†é€æ˜åº¦è®¾ä¸º 0
        this.enableFlagTransition = false;
        this.flagOpacity = 0;
      }
      
      // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿éšè—å®Œæˆï¼Œç„¶åæ›´æ–°å›½å®¶æ•°æ®
      setTimeout(() => {
        this.currentCountry = this.sessionCountries[this.currentIndex];
        this.showAnswer = false;
        
        // å¯ç”¨ transitionï¼Œå‡†å¤‡æ¸æ˜¾åŠ¨ç”»
        this.enableFlagTransition = true;
        
        // å†ç­‰å¾…ä¸€å°æ®µæ—¶é—´åè§¦å‘æ¸æ˜¾åŠ¨ç”»
        setTimeout(() => {
          animateTo({
            duration: 400,
            curve: curves.cubicBezier(0.42, 0, 0.58, 1)
          }, () => {
            this.flagOpacity = 1;
          });
        }, 50);
      }, 50);
    } else {
      this.showSessionOver = true;
    }
  }

  private async handleTap(): Promise<void> {
    if (!this.currentCountry) return;

    // ç‚¹å‡»æŒ¯åŠ¨åé¦ˆ
    VibratorUtil.vibrateTap();

    if (!this.showAnswer) {
      // ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼šæ˜¾ç¤ºç­”æ¡ˆ
      await SoundEffectUtil.playButton();
      this.showAnswer = true;
    } else {
      // ç¬¬äºŒæ¬¡ç‚¹å‡»ï¼šä¸‹ä¸€ä¸ª
      await SoundEffectUtil.playButton();
      this.currentIndex++;
      this.loadNextCountry();
    }
  }

  private async continueSession(): Promise<void> {
    // æ’­æ”¾æŒ‰é’®ç‚¹å‡»éŸ³æ•ˆå’ŒæŒ¯åŠ¨
    await SoundEffectUtil.playButton();
    VibratorUtil.vibrateTap();
    
    this.sessionNumber++;
    this.startNewSession();
  }

  private async exitGame(): Promise<void> {
    // æ’­æ”¾æŒ‰é’®ç‚¹å‡»éŸ³æ•ˆå’ŒæŒ¯åŠ¨
    await SoundEffectUtil.playButton();
    VibratorUtil.vibrateTap();
    
    router.back();
  }

  build() {
    Navigation() {
      Row() {
        Column() {
          Stack() {
            if (this.showSessionOver) {
              this.SessionOverView()
            } else if (this.currentCountry) {
              this.GameView()
            } else {
              Column() {
                Text(this.context.resourceManager.getStringSync($r('app.string.loading').id))
                  .fontSize(16)
                  .fontColor($r('app.color.text_tertiary'))
              }
              .width('100%')
              .height('100%')
              .justifyContent(FlexAlign.Center)
            }
          }
          .width('100%')
          .height('100%')
          .backgroundColor($r('app.color.bg_page'))
          .constraintSize({ maxWidth: getContentMaxWidth() })
        }
        .width('100%')
        .height('100%')
      }
      .width('100%')
      .height('100%')
      .justifyContent(FlexAlign.Center)
    }
    .title('')
    .titleMode(NavigationTitleMode.Mini)
    .mode(NavigationMode.Stack)
    .backgroundColor($r('app.color.bg_page'))
  }

  @Builder
  GameView() {
    Column() {
      // é¡¶éƒ¨ boxï¼ˆå›ºå®šé«˜åº¦ï¼‰
      Row() {
        Blank()
        Text(`${this.currentIndex + 1} / ${QUESTIONS_PER_SESSION}`)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_secondary'))
        Blank()
      }
      .width('100%')
      .height(120)
      .justifyContent(FlexAlign.Center)

      // ä¸­é—´ï¼šå›½æ——ï¼ˆå æ®å‰©ä½™ç©ºé—´ï¼‰
      Column() {
        if (this.currentCountry) {
          Image(getFlagImageSource(this.currentCountry.code))
            .width('90%')
            .height('100%')
            .objectFit(ImageFit.Contain)
            .opacity(this.flagOpacity)
            .key(`${this.currentCountry.code}_${this.currentIndex}`)
            .transition(this.enableFlagTransition ? TransitionEffect.OPACITY.animation({ duration: 400, curve: curves.cubicBezier(0.42, 0, 0.58, 1) }) : TransitionEffect.OPACITY.animation({ duration: 0 }))
        }
      }
      .width('100%')
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)

      // åº•éƒ¨ boxï¼ˆå›ºå®šé«˜åº¦ï¼Œä¸é¡¶éƒ¨ä¸€æ ·ï¼‰
      Column() {
        if (this.currentCountry) {
          // åœ¨è‹±æ–‡æ¨¡å¼ä¸‹åªæ˜¾ç¤ºè‹±æ–‡åç§°ï¼Œä¸­æ–‡æ¨¡å¼ä¸‹æ˜¾ç¤ºä¸­æ–‡å’Œè‹±æ–‡
          if (this.isEnglish) {
            Text(this.currentCountry.name)
              .fontSize(36)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .visibility(this.showAnswer ? Visibility.Visible : Visibility.Hidden)
          } else {
            Text(this.currentCountry.nameCN)
              .fontSize(36)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .margin({ bottom: 12 })
              .visibility(this.showAnswer ? Visibility.Visible : Visibility.Hidden)

            Text(this.currentCountry.name)
              .fontSize(20)
              .fontColor($r('app.color.text_secondary'))
              .visibility(this.showAnswer ? Visibility.Visible : Visibility.Hidden)
          }
        }
      }
      .width('100%')
      .height(120)
      .justifyContent(FlexAlign.Center)
      .padding({ left: 20, right: 20 })
    }
    .width('100%')
    .height('100%')
    .onClick(async () => {
      await this.handleTap();
    })
  }

  @Builder
  SessionOverView() {
    Column() {
      Text('ğŸ‰')
        .fontSize(80)
        .margin({ bottom: 20 })

      Text($r('app.string.headsup_session_over'))
        .fontSize(28)
        .fontWeight(FontWeight.Bold)
        .fontColor($r('app.color.text_primary'))
        .margin({ bottom: 12 })

      Text(this.context.resourceManager.getStringSync($r('app.string.headsup_session_count').id, this.sessionNumber.toString()))
        .fontSize(16)
        .fontColor($r('app.color.text_secondary'))
        .margin({ bottom: 60 })

      Row() {
        Button($r('app.string.headsup_exit'))
          .width(120)
          .height(48)
          .fontSize(17)
          .fontWeight(FontWeight.Medium)
          .backgroundColor($r('app.color.bg_card'))
          .fontColor($r('app.color.text_primary'))
          .onClick(async () => {
            await this.exitGame();
          })

        Button($r('app.string.headsup_continue'))
          .width(120)
          .height(48)
          .fontSize(17)
          .fontWeight(FontWeight.Bold)
          .backgroundColor($r('app.color.button_primary'))
          .margin({ left: 16 })
          .onClick(async () => {
            await this.continueSession();
          })
      }
      .margin({ top: 20 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .padding(40)
  }
}

