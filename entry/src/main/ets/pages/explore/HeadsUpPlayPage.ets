import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import common from '@ohos.app.ability.common';
import { Country, Countries, getFlagImageSource } from '../../utils/countryData';
import { PreferencesManager } from '../../utils/PreferencesManager';
import { SoundEffectUtil } from '../../utils/SoundEffectUtil';
import { VibratorUtil } from '../../utils/VibratorUtil';

const QUESTIONS_PER_SESSION = 10;
const PREFS_NAME = 'heads_up_settings';
const KEY_FIRST_TIME = 'has_shown_tutorial';

@Entry
@Component
export struct HeadsUpPlayPage {
  @State currentCountry: Country | undefined = undefined;
  @State showAnswer: boolean = false;
  @State currentIndex: number = 0;
  @State sessionCountries: Country[] = [];
  @State showSessionOver: boolean = false;
  @State sessionNumber: number = 1;
  private context = getContext(this) as common.UIAbilityContext;

  async aboutToAppear() {
    // åˆå§‹åŒ–éŸ³æ•ˆæ’­æ”¾å™¨å’ŒæŒ¯åŠ¨å·¥å…·
    await SoundEffectUtil.init(this.context);
    await VibratorUtil.init(this.context);
    
    await this.checkAndShowTutorial();
    this.startNewSession();
  }

  aboutToDisappear() {
    // é‡Šæ”¾éŸ³æ•ˆèµ„æº
    SoundEffectUtil.release();
  }

  private async checkAndShowTutorial(): Promise<void> {
    try {
      const prefs = await PreferencesManager.getPreferences(PREFS_NAME);
      const hasShown = await prefs.get(KEY_FIRST_TIME, false) as boolean;
      
      if (!hasShown) {
        // é¦–æ¬¡è¿›å…¥ï¼Œæ˜¾ç¤ºæç¤ºå¼¹çª—
        promptAction.showDialog({
          title: 'ä½¿ç”¨è¯´æ˜',
          message: 'â€¢ ç‚¹å‡»å±å¹•æŸ¥çœ‹ç­”æ¡ˆ\nâ€¢ å†ç‚¹ä¸‹ä¸€ä¸ª\nâ€¢ æ¯åä¸ªä¸€è½®',
          buttons: [
            { text: 'çŸ¥é“äº†', color: '#1677FF' }
          ]
        }).then(() => {
          // ä¿å­˜å·²æ˜¾ç¤ºçŠ¶æ€
          this.saveTutorialShown();
        }).catch(() => {
          // å³ä½¿å–æ¶ˆä¹Ÿä¿å­˜ï¼Œé¿å…é‡å¤æ˜¾ç¤º
          this.saveTutorialShown();
        });
      }
    } catch (err) {
      console.error(`Failed to check tutorial: ${JSON.stringify(err)}`);
    }
  }

  private async saveTutorialShown(): Promise<void> {
    try {
      const prefs = await PreferencesManager.getPreferences(PREFS_NAME);
      await prefs.put(KEY_FIRST_TIME, true);
      await prefs.flush();
    } catch (err) {
      console.error(`Failed to save tutorial status: ${JSON.stringify(err)}`);
    }
  }

  private startNewSession(): void {
    this.sessionCountries = this.generateRandomCountries(QUESTIONS_PER_SESSION);
    this.currentIndex = 0;
    this.showAnswer = false;
    this.showSessionOver = false;
    this.loadNextCountry();
  }

  private generateRandomCountries(count: number): Country[] {
    // ä½¿ç”¨ Fisher-Yates æ´—ç‰Œç®—æ³•ç¡®ä¿çœŸæ­£çš„éšæœº
    const shuffled = [...Countries];
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      // ä½¿ç”¨ä¸´æ—¶å˜é‡äº¤æ¢å…ƒç´ ï¼ˆArkTS ä¸æ”¯æŒè§£æ„èµ‹å€¼ï¼‰
      const temp = shuffled[i];
      shuffled[i] = shuffled[j];
      shuffled[j] = temp;
    }
    return shuffled.slice(0, count);
  }

  private loadNextCountry(): void {
    if (this.currentIndex < this.sessionCountries.length) {
      this.currentCountry = this.sessionCountries[this.currentIndex];
      this.showAnswer = false;
    } else {
      this.showSessionOver = true;
    }
  }

  private async handleTap(): Promise<void> {
    if (!this.currentCountry) return;

    // ç‚¹å‡»æŒ¯åŠ¨åé¦ˆ
    VibratorUtil.vibrateTap();

    if (!this.showAnswer) {
      // ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼šæ˜¾ç¤ºç­”æ¡ˆ
      await SoundEffectUtil.playButton();
      this.showAnswer = true;
    } else {
      // ç¬¬äºŒæ¬¡ç‚¹å‡»ï¼šä¸‹ä¸€ä¸ª
      await SoundEffectUtil.playButton();
      this.currentIndex++;
      this.loadNextCountry();
    }
  }

  private async continueSession(): Promise<void> {
    // æ’­æ”¾æŒ‰é’®ç‚¹å‡»éŸ³æ•ˆå’ŒæŒ¯åŠ¨
    await SoundEffectUtil.playButton();
    VibratorUtil.vibrateTap();
    
    this.sessionNumber++;
    this.startNewSession();
  }

  private async exitGame(): Promise<void> {
    // æ’­æ”¾æŒ‰é’®ç‚¹å‡»éŸ³æ•ˆå’ŒæŒ¯åŠ¨
    await SoundEffectUtil.playButton();
    VibratorUtil.vibrateTap();
    
    router.back();
  }

  build() {
    Navigation() {
      Stack() {
        if (this.showSessionOver) {
          this.SessionOverView()
        } else if (this.currentCountry) {
          this.GameView()
        } else {
          Column() {
            Text('åŠ è½½ä¸­...')
              .fontSize(16)
              .fontColor($r('app.color.text_tertiary'))
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor($r('app.color.bg_page'))
    }
    .title('')
    .titleMode(NavigationTitleMode.Mini)
    .backgroundColor($r('app.color.bg_page'))
  }

  @Builder
  GameView() {
    Column() {
      // é¡¶éƒ¨ boxï¼ˆå›ºå®šé«˜åº¦ï¼‰
      Row() {
        Blank()
        Text(`${this.currentIndex + 1} / ${QUESTIONS_PER_SESSION}`)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_secondary'))
        Blank()
      }
      .width('100%')
      .height(120)
      .justifyContent(FlexAlign.Center)

      // ä¸­é—´ï¼šå›½æ——ï¼ˆå æ®å‰©ä½™ç©ºé—´ï¼‰
      Column() {
        if (this.currentCountry) {
          Image(getFlagImageSource(this.currentCountry.code))
            .width('90%')
            .height('100%')
            .objectFit(ImageFit.Contain)
        }
      }
      .width('100%')
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)

      // åº•éƒ¨ boxï¼ˆå›ºå®šé«˜åº¦ï¼Œä¸é¡¶éƒ¨ä¸€æ ·ï¼‰
      Column() {
        if (this.currentCountry) {
          Text(this.currentCountry.nameCN)
            .fontSize(36)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.text_primary'))
            .margin({ bottom: 12 })
            .visibility(this.showAnswer ? Visibility.Visible : Visibility.Hidden)

          Text(this.currentCountry.name)
            .fontSize(20)
            .fontColor($r('app.color.text_secondary'))
            .visibility(this.showAnswer ? Visibility.Visible : Visibility.Hidden)
        }
      }
      .width('100%')
      .height(120)
      .justifyContent(FlexAlign.Center)
      .padding({ left: 20, right: 20 })
    }
    .width('100%')
    .height('100%')
    .onClick(async () => {
      await this.handleTap();
    })
  }

  @Builder
  SessionOverView() {
    Column() {
      Text('ğŸ‰')
        .fontSize(80)
        .margin({ bottom: 20 })

      Text('æœ¬è½®å®Œæˆï¼')
        .fontSize(28)
        .fontWeight(FontWeight.Bold)
        .fontColor($r('app.color.text_primary'))
        .margin({ bottom: 12 })

      Text(`å·²å®Œæˆ ${this.sessionNumber} è½®`)
        .fontSize(16)
        .fontColor($r('app.color.text_secondary'))
        .margin({ bottom: 60 })

      Row() {
        Button('é€€å‡º')
          .width(120)
          .height(48)
          .fontSize(17)
          .fontWeight(FontWeight.Medium)
          .backgroundColor($r('app.color.bg_card'))
          .fontColor($r('app.color.text_primary'))
          .onClick(async () => {
            await this.exitGame();
          })

        Button('ç»§ç»­')
          .width(120)
          .height(48)
          .fontSize(17)
          .fontWeight(FontWeight.Bold)
          .backgroundColor($r('app.color.button_primary'))
          .margin({ left: 16 })
          .onClick(async () => {
            await this.continueSession();
          })
      }
      .margin({ top: 20 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .padding(40)
  }
}

