import router from '@ohos.router';
import { preferences } from '@kit.ArkData';
import common from '@ohos.app.ability.common';
import promptAction from '@ohos.promptAction';
import { CITY_DATA, CityData } from '../../utils/cityData';
import { AmountInput } from '../../components/AmountInput';
import { inputMethod } from '@kit.IMEKit';

@Entry
@Component
export struct CityEditPage {
    @State currentCity: string = 'åŒ—äº¬';
    @State currentMaxBase: string = '';
    @State searchText: string = '';
    @State filteredCities: CityData[] = [];
    @State isCustom: boolean = false;
    @State showCityDialog: boolean = false;
    private allCities: CityData[] = [];
    private prefs: preferences.Preferences | null = null;
    private context = getContext(this) as common.UIAbilityContext;

    async aboutToAppear() {
        this.allCities = CITY_DATA;
        this.filteredCities = this.allCities;
        await this.loadCurrentCity();
    }

    private async loadCurrentCity(): Promise<void> {
        try {
            this.prefs = await preferences.getPreferences(this.context, 'app_settings');
            const savedCity: string = await this.prefs.get('selectedCity', 'åŒ—äº¬') as string;
            const savedMaxBase: string = await this.prefs.get('currentCityMaxBase', '') as string;
            
            this.currentCity = savedCity;
            
            // å¦‚æœæœ‰ä¿å­˜çš„åŸºæ•°ï¼Œä½¿ç”¨ä¿å­˜çš„
            if (savedMaxBase) {
                this.currentMaxBase = savedMaxBase;
                this.isCustom = true;
            } else {
                // å¦åˆ™æŸ¥æ‰¾åŸå¸‚çš„é»˜è®¤åŸºæ•°
                const cityData = this.allCities.find(c => c.city === savedCity);
                if (cityData) {
                    this.currentMaxBase = cityData.maxBase.toString();
                    this.isCustom = false;
                }
            }
        } catch (err) {
            console.error(`Failed to load city: ${JSON.stringify(err)}`);
        }
    }

    private onSearchChange(value: string): void {
        this.searchText = value;
        if (!value || value.trim() === '') {
            this.filteredCities = this.allCities;
            return;
        }
        
        const searchLower = value.toLowerCase().trim();
        this.filteredCities = this.allCities.filter((cityData: CityData) => {
            return cityData.city.includes(value) || cityData.city.toLowerCase().includes(searchLower);
        });
    }

    private selectCity(cityData: CityData): void {
        this.currentCity = cityData.city;
        // å¦‚æœæ˜¯ä»åˆ—è¡¨é€‰æ‹©çš„åŸå¸‚ï¼Œå…ˆå¡«å…¥é»˜è®¤åŸºæ•°ï¼Œä½†å…è®¸ç¼–è¾‘
        this.currentMaxBase = cityData.maxBase.toString();
        this.searchText = '';
        this.filteredCities = this.allCities;
        this.isCustom = false; // æ ‡è®°ä¸ºéè‡ªå®šä¹‰ï¼Œä½†ç”¨æˆ·å¯ä»¥ä¿®æ”¹
    }

    private async saveCity(): Promise<void> {
        if (!this.currentCity || this.currentCity.trim() === '') {
            promptAction.showToast({
                message: 'è¯·è¾“å…¥åŸå¸‚åç§°',
                duration: 2000
            });
            return;
        }

        if (!this.currentMaxBase || this.currentMaxBase.trim() === '') {
            promptAction.showToast({
                message: 'è¯·è¾“å…¥ç¼´è´¹åŸºæ•°ä¸Šé™',
                duration: 2000
            });
            return;
        }

        const maxBase = parseFloat(this.currentMaxBase);
        if (isNaN(maxBase) || maxBase <= 0) {
            promptAction.showToast({
                message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„ç¼´è´¹åŸºæ•°',
                duration: 2000
            });
            return;
        }

        try {
            if (!this.prefs) {
                this.prefs = await preferences.getPreferences(this.context, 'app_settings');
            }

            await this.prefs.put('selectedCity', this.currentCity);
            await this.prefs.put('currentCityMaxBase', this.currentMaxBase);
            await this.prefs.flush();

            promptAction.showToast({
                message: 'ä¿å­˜æˆåŠŸ',
                duration: 1500
            });

            // å»¶è¿Ÿè¿”å›ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæç¤º
            setTimeout(() => {
                router.back();
            }, 500);
        } catch (err) {
            console.error(`Failed to save city: ${JSON.stringify(err)}`);
            promptAction.showToast({
                message: 'ä¿å­˜å¤±è´¥',
                duration: 2000
            });
        }
    }

    build() {
        Stack() {
            Navigation() {
                Scroll() {
                    Column() {
                        // åŸå¸‚
                        Column() {
                            Text('åŸå¸‚')
                                .fontSize(14)
                                .fontColor($r('app.color.text_secondary'))
                                .alignSelf(ItemAlign.Start)
                                .margin({ bottom: 8 })
                            
                            Row() {
                                TextInput({ text: this.currentCity, placeholder: 'è¯·è¾“å…¥åŸå¸‚åç§°' })
                                    .layoutWeight(1)
                                    .height(48)
                                    .backgroundColor($r('app.color.bg_secondary'))
                                    .borderRadius(8)
                                    .onChange((value: string) => {
                                        this.currentCity = value;
                                    })
                                
                                Image($r('app.media.icon_arrow_right'))
                                    .width(20)
                                    .height(20)
                                    .margin({ left: 12 })
                                    .onClick(() => {
                                        this.showCityDialog = true;
                                    })
                            }
                            .width('100%')
                            .alignItems(VerticalAlign.Center)
                        }
                        .width('100%')
                        .padding(20)
                        .backgroundColor($r('app.color.bg_card'))
                        .margin({ top: 0, left: 16, right: 16 })

                        // ç¼´è´¹åŸºæ•°ä¸Šé™
                        Column() {
                            AmountInput({
                                label: 'ç¼´è´¹åŸºæ•°ä¸Šé™ï¼ˆå…ƒ/æœˆï¼‰',
                                placeholder: 'è¯·è¾“å…¥ç¼´è´¹åŸºæ•°ä¸Šé™',
                                value: this.currentMaxBase,
                                onChange: (value: string) => {
                                    this.currentMaxBase = value;
                                    this.isCustom = true;
                                }
                            })
                            
                            Text('* å¯ä¿®æ”¹é¢„è®¾åŸå¸‚çš„ç¼´è´¹åŸºæ•°')
                                .fontSize(12)
                                .fontColor($r('app.color.text_tertiary'))
                                .margin({ top: 8 })
                                .alignSelf(ItemAlign.Start)
                        }
                        .width('100%')
                        .padding(20)
                        .backgroundColor($r('app.color.bg_card'))
                        .margin({ top: 16, left: 16, right: 16 })

                        // ä¿å­˜æŒ‰é’®
                        Button('ä¿å­˜')
                            .type(ButtonType.Normal)
                            .backgroundColor($r('app.color.button_primary'))
                            .fontColor($r('app.color.text_white'))
                            .fontSize(16)
                            .width('80%')
                            .constraintSize({ maxWidth: 320 })
                            .height(48)
                            .borderRadius(8)
                            .margin({ top: 24, bottom: 24 })
                            .onClick(() => {
                                this.saveCity();
                                inputMethod.getController().stopInputSession();
                            })

                        // ä½¿ç”¨è¯´æ˜
                        Column() {
                            Text('ä½¿ç”¨è¯´æ˜')
                                .fontSize(15)
                                .fontWeight(FontWeight.Bold)
                                .fontColor($r('app.color.text_primary'))
                                .alignSelf(ItemAlign.Start)
                                .margin({ bottom: 12 })
                            Text('â€¢ å¯ä»¥ç›´æ¥è¾“å…¥åŸå¸‚åç§°ï¼Œæˆ–ä»é¢„è®¾åˆ—è¡¨ä¸­é€‰æ‹©')
                                .fontSize(13)
                                .fontColor($r('app.color.text_secondary'))
                                .margin({ bottom: 4 })
                                .alignSelf(ItemAlign.Start)
                            Text('â€¢ ç¼´è´¹åŸºæ•°ä¸Šé™ç”¨äºäº”é™©ä¸€é‡‘è®¡ç®—æ—¶çš„éªŒè¯')
                                .fontSize(13)
                                .fontColor($r('app.color.text_secondary'))
                                .margin({ bottom: 4 })
                                .alignSelf(ItemAlign.Start)
                            Text('â€¢ å³ä½¿é€‰æ‹©é¢„è®¾åŸå¸‚ï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹ç¼´è´¹åŸºæ•°')
                                .fontSize(13)
                                .fontColor($r('app.color.text_secondary'))
                                .alignSelf(ItemAlign.Start)
                        }
                        .width('100%')
                        .padding(20)
                        .backgroundColor($r('app.color.bg_card'))
                        .margin({ top: 16, left: 16, right: 16, bottom: 16 })
                        .alignItems(HorizontalAlign.Start)
                    }
                    .width('100%')
                    .alignItems(HorizontalAlign.Center)
                }
                .scrollBar(BarState.Off)
                .edgeEffect(EdgeEffect.Spring)
                .backgroundColor($r('app.color.bg_page'))
            }
            .title('å½“å‰åŸå¸‚')
            .titleMode(NavigationTitleMode.Mini)
            .hideBackButton(false)
            .backgroundColor($r('app.color.bg_page'))

            // åŸå¸‚é€‰æ‹©å¯¹è¯æ¡†
            if (this.showCityDialog) {
                this.CitySelectionDialog()
            }
        }
        .width('100%')
        .height('100%')
    }

    @Builder
    CitySelectionDialog() {
        Stack({ alignContent: Alignment.Center }) {
            // é®ç½©å±‚
            Column()
                .width('100%')
                .height('100%')
                .backgroundColor('rgba(0, 0, 0, 0.5)')
                .onClick(() => {
                    this.showCityDialog = false;
                    this.searchText = '';
                    this.filteredCities = this.allCities;
                })

            // å¯¹è¯æ¡†
            Column() {
                Text('é€‰æ‹©åŸå¸‚')
                    .fontSize(18)
                    .fontWeight(FontWeight.Bold)
                    .fontColor($r('app.color.text_primary'))
                    .margin({ bottom: 16 })

                // æœç´¢æ¡†
                Row() {
                    TextInput({ placeholder: 'æœç´¢åŸå¸‚...', text: this.searchText })
                        .layoutWeight(1)
                        .height(40)
                        .backgroundColor($r('app.color.bg_secondary'))
                        .borderRadius(20)
                        .padding({ left: 16, right: 16 })
                        .fontColor($r('app.color.text_primary'))
                        .onChange((value: string) => {
                            this.onSearchChange(value);
                        })
                    if (this.searchText) {
                        Button('æ¸…é™¤')
                            .type(ButtonType.Normal)
                            .fontSize(12)
                            .fontColor($r('app.color.text_secondary'))
                            .backgroundColor(Color.Transparent)
                            .height(32)
                            .margin({ left: 8 })
                            .onClick(() => {
                                this.searchText = '';
                                this.onSearchChange('');
                            })
                    }
                }
                    .width('100%')
                    .margin({ bottom: 16 })

                // åŸå¸‚åˆ—è¡¨
                if (this.filteredCities.length === 0 && this.searchText) {
                    Column() {
                        Text('ğŸ”')
                            .fontSize(48)
                            .margin({ bottom: 16 })
                        Text('æœªæ‰¾åˆ°ç›¸å…³åŸå¸‚')
                            .fontSize(16)
                            .fontColor($r('app.color.text_secondary'))
                            .margin({ bottom: 8 })
                        Text('è¯·å°è¯•å…¶ä»–å…³é”®è¯')
                            .fontSize(14)
                            .fontColor($r('app.color.text_tertiary'))
                    }
                        .width('100%')
                        .height(200)
                        .justifyContent(FlexAlign.Center)
                        .alignItems(HorizontalAlign.Center)
                } else {
                    Scroll() {
                        Column() {
                            ForEach(this.filteredCities, (cityData: CityData) => {
                                this.CityOption(cityData)
                            }, (cityData: CityData) => cityData.city)
                        }
                            .width('100%')
                    }
                        .width('100%')
                        .constraintSize({ maxHeight: 400 })
                        .layoutWeight(1)
                }
            }
            .width('90%')
                .constraintSize({ maxWidth: 400, maxHeight: 600 })
                .padding({ left: 24, right: 24, top: 24, bottom: 24 })
                .backgroundColor($r('app.color.bg_card'))
                .borderRadius(16)
                .shadow({
                    radius: 20,
                    color: $r('app.color.shadow'),
                    offsetX: 0,
                    offsetY: 4
                })
        }
        .width('100%')
            .height('100%')
    }

    @Builder
    CityOption(cityData: CityData) {
        Row() {
            Column() {
                Text(cityData.city)
                    .fontSize(16)
                    .fontColor($r('app.color.text_primary'))
                    .alignSelf(ItemAlign.Start)
                Text(`ç¼´è´¹åŸºæ•°ä¸Šé™ï¼š${cityData.maxBase}å…ƒ/æœˆ`)
                    .fontSize(12)
                    .fontColor($r('app.color.text_tertiary'))
                    .margin({ top: 4 })
                    .alignSelf(ItemAlign.Start)
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Start)

            if (this.currentCity === cityData.city) {
                Text('âœ“')
                    .fontSize(18)
                    .fontColor($r('app.color.button_primary'))
                    .fontWeight(FontWeight.Bold)
            }
        }
        .width('100%')
            .padding({ top: 16, bottom: 16, left: 16, right: 16 })
            .borderRadius(8)
            .backgroundColor(this.currentCity === cityData.city ? $r('app.color.bg_blue_light') : $r('app.color.bg_secondary'))
            .margin({ bottom: 12 })
            .onClick(() => {
                this.selectCity(cityData);
                this.showCityDialog = false;
                this.searchText = '';
                this.filteredCities = this.allCities;
            })
    }
}

