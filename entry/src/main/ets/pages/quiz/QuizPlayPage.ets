import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import common from '@ohos.app.ability.common';
import { systemShare } from '@kit.ShareKit';
import { uniformTypeDescriptor } from '@kit.ArkData';
import { BusinessError } from '@kit.BasicServicesKit';
import { image } from '@kit.ImageKit';
import fs from '@ohos.file.fs';
import { fileUri } from '@kit.CoreFileKit';
import { Country, getCountryByCode, Countries } from '../../utils/countryData';
import { QuizLevel, getQuizLevel, getAllQuizLevels } from './QuizLevels';
import { GameProgressManager, GameType } from '../../utils/GameProgressManager';
import { SoundEffectUtil } from '../../utils/SoundEffectUtil';
import { VibratorUtil } from '../../utils/VibratorUtil';
import { screenshotManager } from '../../utils/ScreenshotManager';

interface RouterParams {
  quizType: string;
  levelId: number;
}

interface QuizQuestion {
  correctCountry: Country;
  choices: Country[];
}

@Entry
@Component
  struct QuizPlayPage {
  @State quizType: string = 'flagToName';
  @State level: QuizLevel | undefined = undefined;
  @State questions: QuizQuestion[] = [];
  @State currentIndex: number = 0;
  @State lives: number = 5;
  @State selectedIndex: number = -1;
  @State isAnswered: boolean = false;
  @State isCorrect: boolean = false;
  @State correctAnswers: number = 0;
  @State combo: number = 0;
  @State maxCombo: number = 0;
  @State showResult: boolean = false;
  @State animatingIndex: number = -1;
  @State scaleValue: number = 1;
  @State isSharing: boolean = false;
  @State sharePixelMap: image.PixelMap | null = null;
  @State optionVisible: boolean[] = [false, false, false, false];  // é€‰é¡¹å¯è§æ€§
  private context = getContext(this) as common.UIAbilityContext;
  private readonly SHARE_CONTAINER_ID = 'quizShareContainer';
  private timeoutIds: number[] = []; // å­˜å‚¨æ‰€æœ‰setTimeoutçš„IDï¼Œç”¨äºæ¸…ç†

  async aboutToAppear() {
    // åˆå§‹åŒ–éŸ³æ•ˆæ’­æ”¾å™¨å’ŒæŒ¯åŠ¨å·¥å…·
    await SoundEffectUtil.init(this.context);
    await VibratorUtil.init(this.context);

    // åˆå§‹åŒ–æˆªå›¾ç®¡ç†å™¨
    screenshotManager.init(this.getUIContext());

    const params = router.getParams() as RouterParams;
    if (params) {
      this.quizType = params.quizType || 'flagToName';
      const levelId = params.levelId || 1;
      this.loadLevel(levelId);
    }
  }

  aboutToDisappear() {
    // æ¸…ç†æ‰€æœ‰setTimeout
    this.clearAllTimeouts();
    // é‡Šæ”¾éŸ³æ•ˆèµ„æº
    SoundEffectUtil.release();
    // é‡Šæ”¾åˆ†äº« PixelMap
    this.releaseSharePixelMap();
  }

  private releaseSharePixelMap(): void {
    if (this.sharePixelMap) {
      try {
        this.sharePixelMap.release();
      } catch (e) {
        console.warn('[QuizPlayPage] Failed to release share pixelmap:', e);
      }
      this.sharePixelMap = null;
    }
  }

  private clearAllTimeouts(): void {
    for (const id of this.timeoutIds) {
      clearTimeout(id);
    }
    this.timeoutIds = [];
  }

  private loadLevel(levelId: number): void {
    // æ¸…ç†ä¹‹å‰çš„å®šæ—¶å™¨
    this.clearAllTimeouts();
    this.level = getQuizLevel(levelId);
    if (this.level) {
      this.lives = this.level.lives;
      this.currentIndex = 0;
      this.selectedIndex = -1;
      this.isAnswered = false;
      this.isCorrect = false;
      this.correctAnswers = 0;
      this.combo = 0;
      this.maxCombo = 0;
      this.showResult = false;
      this.animatingIndex = -1;
      this.scaleValue = 1;
      this.optionVisible = [false, false, false, false];
      this.generateQuestions();
      // è§¦å‘é€‰é¡¹åŠ¨ç”»
      this.animateOptions();
    }
  }

  private generateQuestions(): void {
    if (!this.level) return;

    this.questions = [];
    for (const code of this.level.countries) {
      const country = getCountryByCode(code);
      if (country) {
        const choices = this.generateChoices(country);
        this.questions.push({
          correctCountry: country,
          choices: choices
        });
      }
    }
    // éšæœºæ‰“ä¹±é¢˜ç›®é¡ºåº
    this.shuffleArray(this.questions);
  }

  private generateChoices(correctCountry: Country): Country[] {
    const choices: Country[] = [correctCountry];
    const allCountries = Countries.filter(c => c.code !== correctCountry.code);

    // éšæœºé€‰æ‹©3ä¸ªé”™è¯¯é€‰é¡¹
    while (choices.length < 4 && allCountries.length > 0) {
      const randomIndex = Math.floor(Math.random() * allCountries.length);
      choices.push(allCountries[randomIndex]);
      allCountries.splice(randomIndex, 1);
    }

    // æ‰“ä¹±é€‰é¡¹é¡ºåº
    this.shuffleArray(choices);
    return choices;
  }

  private shuffleArray<T>(array: T[]): void {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      const temp = array[i];
      array[i] = array[j];
      array[j] = temp;
    }
  }

  private selectAnswer(index: number): void {
    if (this.isAnswered || this.animatingIndex !== -1) return;

    // ç‚¹å‡»æŒ¯åŠ¨åé¦ˆ
    VibratorUtil.vibrateTap();

    // å¼€å§‹åŠ¨ç”»
    this.animatingIndex = index;
    this.scaleValue = 1.1;

    // åŠ¨ç”»ç»“æŸåæ£€æŸ¥ç­”æ¡ˆ
    const id1 = setTimeout(() => {
      this.scaleValue = 1;
      const id2 = setTimeout(async () => {
        await this.checkAnswer(index);
        // ç§»é™¤å·²æ‰§è¡Œçš„å®šæ—¶å™¨ID
        const index2 = this.timeoutIds.indexOf(id2);
        if (index2 > -1) {
          this.timeoutIds.splice(index2, 1);
        }
      }, 100);
      this.timeoutIds.push(id2);
      // ç§»é™¤å·²æ‰§è¡Œçš„å®šæ—¶å™¨ID
      const index1 = this.timeoutIds.indexOf(id1);
      if (index1 > -1) {
        this.timeoutIds.splice(index1, 1);
      }
    }, 150);
    this.timeoutIds.push(id1);
  }

  private async checkAnswer(index: number): Promise<void> {
    this.selectedIndex = index;
    this.isAnswered = true;
    this.animatingIndex = -1;

    const question = this.questions[this.currentIndex];
    const selectedCountry = question.choices[index];
    this.isCorrect = selectedCountry.code === question.correctCountry.code;

    if (this.isCorrect) {
      // æ’­æ”¾æ­£ç¡®ç­”æ¡ˆéŸ³æ•ˆå’ŒæŒ¯åŠ¨
      await SoundEffectUtil.playCorrect();
      VibratorUtil.vibrateCorrect();
      this.correctAnswers++;
      this.combo++;
      if (this.combo > this.maxCombo) {
        this.maxCombo = this.combo;
      }
    } else {
      // æ’­æ”¾é”™è¯¯ç­”æ¡ˆéŸ³æ•ˆå’ŒæŒ¯åŠ¨
      await SoundEffectUtil.playIncorrect();
      VibratorUtil.vibrateIncorrect();
      this.lives--;
      this.combo = 0;

      if (this.lives <= 0) {
        // å»¶è¿Ÿæ˜¾ç¤ºå¤±è´¥
        const id = setTimeout(async () => {
          await SoundEffectUtil.playOver();
          this.showGameOver();
          // ç§»é™¤å·²æ‰§è¡Œçš„å®šæ—¶å™¨ID
          const index = this.timeoutIds.indexOf(id);
          if (index > -1) {
            this.timeoutIds.splice(index, 1);
          }
        }, 1500);
        this.timeoutIds.push(id);
        return;
      }
    }
  }

  private async nextQuestion(): Promise<void> {
    // æ’­æ”¾æŒ‰é’®ç‚¹å‡»éŸ³æ•ˆå’ŒæŒ¯åŠ¨
    await SoundEffectUtil.playButton();
    VibratorUtil.vibrateTap();
    
    if (this.currentIndex < this.questions.length - 1) {
      this.currentIndex++;
      this.selectedIndex = -1;
      this.isAnswered = false;
      this.isCorrect = false;
      this.animatingIndex = -1;
      this.scaleValue = 1;
      this.optionVisible = [false, false, false, false];
      // è§¦å‘é€‰é¡¹åŠ¨ç”»
      this.animateOptions();
    } else {
      // å®Œæˆæ‰€æœ‰é¢˜ç›®ï¼Œè§£é”ä¸‹ä¸€å…³
      if (this.level) {
        await GameProgressManager.init(this.context);
        await GameProgressManager.unlockNextLevel(GameType.QUIZ, this.level.id);
      }
      // æ’­æ”¾æ­å–œéŸ³æ•ˆå’ŒæŒ¯åŠ¨
      await SoundEffectUtil.playCongrats();
      VibratorUtil.vibrateWin();
      this.showResult = true;
    }
  }

  private showGameOver(): void {
    const challengeFailed = this.context.resourceManager.getStringSync($r('app.string.challenge_failed').id);
    const correctAnswersText = this.context.resourceManager.getStringSync($r('app.string.correct_answers_count').id, this.correctAnswers.toString());
    const maxComboText = this.context.resourceManager.getStringSync($r('app.string.max_combo').id, this.maxCombo.toString());
    const backText = this.context.resourceManager.getStringSync($r('app.string.back').id);
    const restartText = this.context.resourceManager.getStringSync($r('app.string.restart').id);
    
    promptAction.showDialog({
      title: challengeFailed,
      message: `${correctAnswersText}\n${maxComboText}`,
      buttons: [
        { text: backText, color: '#666666' },
        { text: restartText, color: '#1677FF' }
      ]
    }).then((result) => {
      if (result.index === 0) {
        router.back();
      } else {
        this.restartQuiz();
      }
    });
  }

  private restartQuiz(): void {
    this.currentIndex = 0;
    this.selectedIndex = -1;
    this.isAnswered = false;
    this.isCorrect = false;
    this.correctAnswers = 0;
    this.combo = 0;
    this.maxCombo = 0;
    this.showResult = false;
    this.animatingIndex = -1;
    this.scaleValue = 1;
    if (this.level) {
      this.lives = this.level.lives;
    }
    this.generateQuestions();
  }

  private getTitle(): string {
    return this.quizType === 'flagToName' 
      ? this.context.resourceManager.getStringSync($r('app.string.quiz_flag_to_name').id)
      : this.context.resourceManager.getStringSync($r('app.string.quiz_name_to_flag').id);
  }

  private getCorrectIndex(): number {
    const question = this.questions[this.currentIndex];
    return question.choices.findIndex(c => c.code === question.correctCountry.code);
  }

  private animateOptions(): void {
    // é‡ç½®æ‰€æœ‰é€‰é¡¹ä¸ºä¸å¯è§
    this.optionVisible = [false, false, false, false];
    
    // é€ä¸ªæ˜¾ç¤ºé€‰é¡¹
    for (let i = 0; i < 4; i++) {
      const id = setTimeout(() => {
        const newVisible = [...this.optionVisible];
        newVisible[i] = true;
        this.optionVisible = newVisible;
        // ç§»é™¤å·²æ‰§è¡Œçš„å®šæ—¶å™¨ID
        const index = this.timeoutIds.indexOf(id);
        if (index > -1) {
          this.timeoutIds.splice(index, 1);
        }
      }, i * 100); // æ¯ä¸ªé€‰é¡¹å»¶è¿Ÿ100ms
      this.timeoutIds.push(id);
    }
  }

  build() {
    Navigation() {
      Column() {
        if (this.showResult) {
          this.ResultView()
        } else if (this.questions.length > 0) {
          Column() {
            // éšè—çš„åˆ†äº«å®¹å™¨ï¼ˆåŒ…å«é—®é¢˜ UIï¼‰
            Column() {
              if (this.questions.length > 0) {
                this.ShareContentBuilder()
              }
            }
            .id(this.SHARE_CONTAINER_ID)
            .position({ x: -1000, y: -1000 })
            .width(400)
            .backgroundColor($r('app.color.bg_page'))

            Column() {
              // é¡¶éƒ¨çŠ¶æ€æ 
              Row() {
                // å·¦ä¾§ï¼šç¬¬å‡ å…³
                Text(this.context.resourceManager.getStringSync($r('app.string.level_number').id, (this.level?.id || 1).toString()))
                  .fontSize(15)
                  .fontWeight(FontWeight.Medium)
                  .fontColor($r('app.color.text_secondary'))
                  .layoutWeight(1)

                // ä¸­é—´ï¼šç”Ÿå‘½å€¼
                Row() {
                  ForEach(Array.from({ length: this.level?.lives || 5 }), (_: undefined, index: number) => {
                    Text(index < this.lives ? 'â¤ï¸' : 'ğŸ–¤')
                      .fontSize(14)
                      .margin({ left: 1, right: 1 })
                  })
                }
                .layoutWeight(1)
                  .justifyContent(FlexAlign.Center)

                // å³ä¾§ï¼šåºå·
                Text(`${this.currentIndex + 1} / ${this.questions.length}`)
                  .fontSize(15)
                  .fontWeight(FontWeight.Medium)
                  .fontColor($r('app.color.text_secondary'))
                  .layoutWeight(1)
                  .textAlign(TextAlign.End)
              }
              .width('100%')
                .padding({ left: 20, right: 20, top: 12, bottom: 12 })

              // è¿å‡»æç¤º
              if (this.combo >= 3) {
                Text(`ğŸ”¥ ${this.context.resourceManager.getStringSync($r('app.string.combo_streak').id, this.combo.toString())}`)
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.color_orange'))
                  .padding({ top: 8, bottom: 8 })
              }

              // é¢˜ç›®åŒºåŸŸ
              if (this.quizType === 'flagToName') {
                this.FlagToNameQuestion()
              } else {
                this.NameToFlagQuestion()
              }

              Blank()

              // ä¸‹ä¸€é¢˜æŒ‰é’®
              if (this.isAnswered) {
                Button(this.currentIndex < this.questions.length - 1 
                  ? this.context.resourceManager.getStringSync($r('app.string.next_question').id)
                  : this.context.resourceManager.getStringSync($r('app.string.view_results').id))
                  .width('80%')
                  .height(48)
                  .fontSize(17)
                  .fontWeight(FontWeight.Bold)
                  .backgroundColor($r('app.color.button_primary'))
                  .margin({ bottom: 32 })
                  .onClick(async () => {
                    await this.nextQuestion();
                  })
              }
            }
            .width('100%')
              .height('100%')
              .backgroundColor($r('app.color.bg_page'))
          }
        } else {
          Column() {
            Text(this.context.resourceManager.getStringSync($r('app.string.loading').id))
              .fontSize(16)
              .fontColor($r('app.color.text_tertiary'))
          }
          .width('100%')
            .height('100%')
            .justifyContent(FlexAlign.Center)
        }
      }
      .width('100%')
        .height('100%')
    }
    .title('')
    .titleMode(NavigationTitleMode.Mini)
    .backgroundColor($r('app.color.bg_page'))
    .menus(this.MenuBuilder)
  }

  @Builder
  MenuBuilder() {
    Row({ space: 20 }) {
      Image($r('app.media.icon_share'))
        .width(22)
        .height(22)
        .onClick(() => {
          this.onShareClick();
        })
    }
    .height('100%')
      .justifyContent(FlexAlign.End)
      .alignItems(VerticalAlign.Center)
      .padding({ right: 16 })
  }

  @Builder
  ShareContentBuilder() {
    if (this.questions.length > 0 && this.currentIndex < this.questions.length) {
      Column({ space: 16 }) {
        // å…³å¡ä¿¡æ¯
        Row() {
          Text(this.context.resourceManager.getStringSync($r('app.string.level_number').id, (this.level?.id || 1).toString()))
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor($r('app.color.text_secondary'))
            .layoutWeight(1)

          Text(`${this.currentIndex + 1} / ${this.questions.length}`)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor($r('app.color.text_secondary'))
            .textAlign(TextAlign.End)
        }
        .width('100%')
          .padding({ left: 16, right: 16, top: 20, bottom: 12 })

        // é—®é¢˜å†…å®¹
        if (this.quizType === 'flagToName') {
          // çœ‹æ——çŒœå
          Column() {
            // æ˜¾ç¤ºå›½æ——
            Column() {
              Image($rawfile(`flags/${this.questions[this.currentIndex].correctCountry.code}.svg`))
                .width('80%')
                .height(160)
                .objectFit(ImageFit.Contain)
            }
            .width('100%')
              .padding(24)
              .backgroundColor($r('app.color.bg_secondary'))
              .margin({ bottom: 24 })

            Text(this.context.resourceManager.getStringSync($r('app.string.which_country_flag').id))
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor($r('app.color.text_primary'))
              .margin({ bottom: 20 })

            // é€‰é¡¹
            Column() {
              ForEach(this.questions[this.currentIndex].choices, (country: Country, index: number) => {
                Row() {
                  Text(country.nameCN)
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor($r('app.color.text_primary'))
                }
                .width('100%')
                  .height(52)
                  .justifyContent(FlexAlign.Center)
                  .backgroundColor($r('app.color.bg_card'))
                  .borderRadius(12)
                  .margin({ bottom: 12 })
              })
            }
            .width('100%')
              .padding({ left: 20, right: 20 })
          }
          .width('100%')
        } else {
          // çœ‹åçŒœæ——
          Column() {
            // æ˜¾ç¤ºå›½å®¶åç§°
            Column() {
              Text(this.questions[this.currentIndex].correctCountry.nameCN)
                .fontSize(32)
                .fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.text_primary'))

              Text(this.questions[this.currentIndex].correctCountry.name)
                .fontSize(16)
                .fontColor($r('app.color.text_secondary'))
                .margin({ top: 8 })
            }
            .width('100%')
              .padding(32)
              .margin({ bottom: 24 })

            Text(this.context.resourceManager.getStringSync($r('app.string.select_correct_flag').id))
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor($r('app.color.text_primary'))
              .margin({ bottom: 20 })

            // å›½æ——é€‰é¡¹ - 2x2 ç½‘æ ¼
            Grid() {
              ForEach(this.questions[this.currentIndex].choices, (country: Country, index: number) => {
                GridItem() {
                  Column() {
                    Image($rawfile(`flags/${country.code}.svg`))
                      .width('100%')
                      .height('100%')
                      .objectFit(ImageFit.Contain)
                      .padding(12)
                  }
                  .width('100%')
                    .height('100%')
                    .backgroundColor($r('app.color.bg_card'))
                    .borderRadius(12)
                }
              })
            }
            .columnsTemplate('1fr 1fr')
              .rowsTemplate('1fr 1fr')
              .columnsGap(12)
              .rowsGap(12)
              .width('100%')
              .height(280)
              .padding({ left: 20, right: 20 })
          }
          .width('100%')
        }

        Text(this.context.resourceManager.getStringSync($r('app.string.from_app').id))
          .fontSize(12)
          .fontColor($r('app.color.text_tertiary'))
          .margin({ top: 16, bottom: 20 })
      }
      .width('100%')
        .padding({ top: 20, bottom: 20 })
        .backgroundColor($r('app.color.bg_page'))
    }
  }

  private async onShareClick(): Promise<void> {
    if (this.isSharing || this.questions.length === 0) return;

    this.isSharing = true;
    promptAction.showToast({
      message: this.context.resourceManager.getStringSync($r('app.string.preparing_share').id),
      duration: 1500
    });

    let tempFilePath: string | null = null;

    try {
      // å…ˆé‡Šæ”¾ä¹‹å‰çš„ PixelMap
      this.releaseSharePixelMap();

      // æˆªå–åˆ†äº«å®¹å™¨å†…å®¹
      const pixmap = await screenshotManager.captureSnapshot(this.SHARE_CONTAINER_ID);
      if (!pixmap) {
        promptAction.showToast({
          message: this.context.resourceManager.getStringSync($r('app.string.screenshot_failed').id),
          duration: 2000
        });
        this.isSharing = false;
        return;
      }

      this.sharePixelMap = pixmap;

      // åˆ›å»ºå›¾åƒæ‰“åŒ…å™¨å¹¶æ‰“åŒ…ä¸º ArrayBuffer
      const imagePacker = image.createImagePacker();
      const packOpts: image.PackingOption = {
        format: 'image/jpeg',
        quality: 90
      };
      
      const imageData: ArrayBuffer = await imagePacker.packing(pixmap, packOpts);
      console.info(`[QuizPlayPage] Image packed, data size: ${imageData.byteLength} bytes`);

      // ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶
      const timestamp = Date.now();
      tempFilePath = this.context.cacheDir + '/share_quiz_' + timestamp + '.jpg';
      
      // ä½¿ç”¨åŒæ­¥æ–‡ä»¶æ“ä½œ
      const fileHandle = fs.openSync(tempFilePath, fs.OpenMode.CREATE | fs.OpenMode.WRITE_ONLY);
      fs.writeSync(fileHandle.fd, imageData);
      fs.closeSync(fileHandle);
      
      // éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºç©º
      const stat = fs.statSync(tempFilePath);
      if (stat.size === 0) {
        throw new Error('Image file is empty');
      }
      
      console.info(`[QuizPlayPage] Image file created: ${tempFilePath}, size: ${stat.size} bytes`);

      // è·å–æ–‡ä»¶URI
      const imageUri = fileUri.getUriFromPath(tempFilePath);
      console.info(`[QuizPlayPage] Image URI: ${imageUri}`);
      
      // è·å–å›¾ç‰‡ç±»å‹æè¿°ç¬¦
      const utdTypeId = uniformTypeDescriptor.getUniformDataTypeByFilenameExtension('.jpg', uniformTypeDescriptor.UniformDataType.IMAGE);
      console.info(`[QuizPlayPage] UTD Type ID: ${utdTypeId}`);

      // ä½¿ç”¨å›¾ç‰‡URIåˆ†äº«
      const levelText = this.context.resourceManager.getStringSync($r('app.string.level_number').id, (this.level?.id || 1).toString());
      const quizTypeName = this.context.resourceManager.getStringSync($r('app.string.quiz_flag_to_name').id);
      const fromAppText = this.context.resourceManager.getStringSync($r('app.string.from_app').id);
      const shareData = new systemShare.SharedData({
        utd: utdTypeId,
        uri: imageUri,
        title: `${levelText} - ${quizTypeName}`,
        description: fromAppText
      });
      
      console.info(`[QuizPlayPage] ShareData created: utd=${utdTypeId}, uri=${imageUri}`);

      const controller = new systemShare.ShareController(shareData);
      
      // æ˜¾ç¤ºåˆ†äº«é¢æ¿
      await controller.show(this.context, {
        selectionMode: systemShare.SelectionMode.SINGLE,
        previewMode: systemShare.SharePreviewMode.DETAIL
      });

      console.info('[QuizPlayPage] Share panel opened successfully');
      
      // åˆ†äº«æˆåŠŸåé‡Šæ”¾ PixelMap
      this.releaseSharePixelMap();
      
      // å»¶è¿Ÿåˆ é™¤æ–‡ä»¶ï¼Œç¡®ä¿åˆ†äº«å®Œæˆ
      setTimeout(() => {
        if (tempFilePath) {
          try {
            fs.unlinkSync(tempFilePath);
            console.info(`[QuizPlayPage] Temp file deleted: ${tempFilePath}`);
          } catch (unlinkError) {
            console.warn('[QuizPlayPage] Failed to delete temp file:', unlinkError);
          }
        }
      }, 5000); // 5ç§’ååˆ é™¤

    } catch (err) {
      const error = err as BusinessError;
      console.error(`[QuizPlayPage] Failed to share: code: ${error?.code}, message: ${error?.message}`);
      promptAction.showToast({
        message: this.context.resourceManager.getStringSync($r('app.string.share_failed').id),
        duration: 2000
      });
      
      // æ¸…ç†èµ„æº
      this.releaseSharePixelMap();
      if (tempFilePath) {
        try {
          fs.unlinkSync(tempFilePath);
        } catch (unlinkError) {
          console.warn('[QuizPlayPage] Failed to delete temp file on error:', unlinkError);
        }
      }
    } finally {
      this.isSharing = false;
    }
  }

  @Builder
  FlagToNameQuestion() {
    Column() {
      // æ˜¾ç¤ºå›½æ——
      Column() {
        Image($rawfile(`flags/${this.questions[this.currentIndex].correctCountry.code}.svg`))
          .width('80%')
          .height(160)
          .objectFit(ImageFit.Contain)
      }
      .width('100%')
        .padding(24)
        .backgroundColor($r('app.color.bg_secondary'))
        .margin({ bottom: 24 })

      Text(this.context.resourceManager.getStringSync($r('app.string.which_country_flag').id))
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
        .margin({ bottom: 20 })

      // é€‰é¡¹
      Column() {
        ForEach(this.questions[this.currentIndex].choices, (country: Country, index: number) => {
          this.ChoiceButton(country.nameCN, index)
        })
      }
      .width('100%')
        .padding({ left: 20, right: 20 })
    }
    .width('100%')
  }

  @Builder
  NameToFlagQuestion() {
    Column() {
      // æ˜¾ç¤ºå›½å®¶åç§°
      Column() {
        Text(this.questions[this.currentIndex].correctCountry.nameCN)
          .fontSize(32)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))

        Text(this.questions[this.currentIndex].correctCountry.name)
          .fontSize(16)
          .fontColor($r('app.color.text_secondary'))
          .margin({ top: 8 })
      }
      .width('100%')
        .padding(32)
        .margin({ bottom: 24 })

      Text(this.context.resourceManager.getStringSync($r('app.string.select_correct_flag').id))
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
        .margin({ bottom: 20 })

      // å›½æ——é€‰é¡¹ - 2x2 ç½‘æ ¼
      Grid() {
        ForEach(this.questions[this.currentIndex].choices, (country: Country, index: number) => {
          GridItem() {
            this.FlagChoiceButton(country, index)
          }
        })
      }
      .columnsTemplate('1fr 1fr')
        .rowsTemplate('1fr 1fr')
        .columnsGap(12)
        .rowsGap(12)
        .width('100%')
        .height(280)
        .padding({ left: 20, right: 20 })
    }
    .width('100%')
  }

  @Builder
  ChoiceButton(text: string, index: number) {
    Stack({ alignContent: Alignment.End }) {
      Row() {
        Text(text)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.getChoiceTextColor(index))
      }
      .width('100%')
        .height(52)
        .justifyContent(FlexAlign.Center)
        .backgroundColor(this.getChoiceBackgroundColor(index))
        .borderRadius(12)
        .border({
          width: 2,
          color: this.getChoiceBorderColor(index)
        })

      // ç»“æœæ˜¾ç¤ºå›¾æ ‡ï¼ˆåœ¨æŒ‰é’®ç¼©æ”¾åŠ¨ç”»ç»“æŸåæ˜¾ç¤ºï¼‰
      if (this.isAnswered && this.animatingIndex === -1) {
        this.ResultIcon(index, true)
      }
    }
    .width('100%')
      .height(52)
      .margin({ bottom: 12 })
      .opacity(this.optionVisible[index] ? 1 : 0)
      .scale({ 
        x: this.animatingIndex === index ? this.scaleValue : (this.optionVisible[index] ? 1 : 0.8), 
        y: this.animatingIndex === index ? this.scaleValue : (this.optionVisible[index] ? 1 : 0.8) 
      })
      .animation({ duration: 300, curve: Curve.EaseOut })
      .onClick(() => {
        this.selectAnswer(index);
      })
  }

  @Builder
  FlagChoiceButton(country: Country, index: number) {
    Stack({ alignContent: Alignment.TopStart }) {
      Column() {
        Image($rawfile(`flags/${country.code}.svg`))
          .width('100%')
          .height('100%')
          .objectFit(ImageFit.Contain)
          .padding(12)
      }
      .width('100%')
        .height('100%')
        .backgroundColor(this.getChoiceBackgroundColor(index))
        .borderRadius(12)
        .border({
          width: 1.5,
          color: this.getChoiceBorderColor(index)
        })

      // ç»“æœæ˜¾ç¤ºå›¾æ ‡ï¼ˆåœ¨æŒ‰é’®ç¼©æ”¾åŠ¨ç”»ç»“æŸåæ˜¾ç¤ºï¼‰
      if (this.isAnswered && this.animatingIndex === -1) {
        this.ResultIcon(index, false)
      }
    }
    .width('100%')
      .height('100%')
      .opacity(this.optionVisible[index] ? 1 : 0)
      .scale({ 
        x: this.animatingIndex === index ? this.scaleValue : (this.optionVisible[index] ? 1 : 0.8), 
        y: this.animatingIndex === index ? this.scaleValue : (this.optionVisible[index] ? 1 : 0.8) 
      })
      .animation({ duration: 300, curve: Curve.EaseOut })
      .onClick(() => {
        this.selectAnswer(index);
      })
  }

  private getChoiceBackgroundColor(index: number): Resource {
    if (!this.isAnswered) {
      return $r('app.color.bg_card');
    }

    const correctIndex = this.getCorrectIndex();
    if (index === correctIndex) {
      return $r('app.color.bg_green_light');
    }
    if (index === this.selectedIndex && !this.isCorrect) {
      return $r('app.color.bg_red_light');
    }
    return $r('app.color.bg_card');
  }

  private getChoiceBorderColor(index: number): Resource {
    if (!this.isAnswered) {
      return $r('app.color.gray_border');
    }

    const correctIndex = this.getCorrectIndex();
    if (index === correctIndex) {
      return $r('app.color.color_green');
    }
    if (index === this.selectedIndex && !this.isCorrect) {
      return $r('app.color.color_red');
    }
    return $r('app.color.gray_border');
  }

  private getChoiceTextColor(index: number): Resource {
    if (!this.isAnswered) {
      return $r('app.color.text_primary');
    }

    const correctIndex = this.getCorrectIndex();
    if (index === correctIndex) {
      return $r('app.color.color_green');
    }
    if (index === this.selectedIndex && !this.isCorrect) {
      return $r('app.color.color_red');
    }
    return $r('app.color.text_primary');
  }

  @Builder
  ResultIcon(index: number, isTextOption: boolean) {
    if (index === this.getCorrectIndex() || (index === this.selectedIndex && !this.isCorrect)) {
      if (isTextOption) {
        Stack() {
          Column()
            .width(28)
            .height(28)
            .backgroundColor(index === this.getCorrectIndex() ? $r('app.color.color_green') : $r('app.color.color_red'))
            .borderRadius(14)
          Text(index === this.getCorrectIndex() ? 'âœ“' : 'âœ—')
            .fontSize(14)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
        }
        .opacity(1)
          .animation({ duration: 200, curve: Curve.EaseOut })
          .margin({ right: 12 })
      } else {
        Stack() {
          Column()
            .width(28)
            .height(28)
            .backgroundColor(index === this.getCorrectIndex() ? $r('app.color.color_green') : $r('app.color.color_red'))
            .borderRadius(14)
          Text(index === this.getCorrectIndex() ? 'âœ“' : 'âœ—')
            .fontSize(14)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
        }
        .opacity(1)
          .animation({ duration: 200, curve: Curve.EaseOut })
          .position({ x: 8, y: 8 })
      }
    }
  }

  @Builder
  ResultView() {
    Column() {
      // å¯åˆ†äº«çš„å†…å®¹åŒºåŸŸ
      Column() {
        Text('ğŸ‰')
          .fontSize(64)
          .margin({ top: 40 })

        Text($r('app.string.congratulations'))
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))
          .margin({ top: 24 })

        Text(`${this.context.resourceManager.getStringSync($r('app.string.level_number').id, (this.level?.id || 1).toString())} Â· ${this.level?.name}`)
          .fontSize(16)
          .fontColor($r('app.color.text_secondary'))
          .margin({ top: 8 })

        // ç»Ÿè®¡ä¿¡æ¯
        Column() {
          Row() {
            Text(this.context.resourceManager.getStringSync($r('app.string.correct_answers').id))
              .fontSize(16)
              .fontColor($r('app.color.text_secondary'))
            Blank()
            Text(`${this.correctAnswers} / ${this.questions.length}`)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
          }
          .width('100%')
          .padding({ top: 16, bottom: 16 })

          Divider().color($r('app.color.gray_very_light'))

          Row() {
            Text(this.context.resourceManager.getStringSync($r('app.string.max_combo').id, this.maxCombo.toString()))
              .fontSize(16)
              .fontColor($r('app.color.text_secondary'))
            Blank()
            Text(`${this.maxCombo}`)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
          }
          .width('100%')
          .padding({ top: 16, bottom: 16 })

          Divider().color($r('app.color.gray_very_light'))

          Row() {
            Text(this.context.resourceManager.getStringSync($r('app.string.remaining_lives').id))
              .fontSize(16)
              .fontColor($r('app.color.text_secondary'))
            Blank()
            Text(`${this.lives} â¤ï¸`)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
          }
          .width('100%')
            .padding({ top: 16, bottom: 16 })
        }
        .width('100%')
          .padding({ left: 24, right: 24 })
          .margin({ top: 32 })
          .backgroundColor($r('app.color.bg_card'))
          .borderRadius(16)

        Text(this.context.resourceManager.getStringSync($r('app.string.from_app').id))
          .fontSize(12)
          .fontColor($r('app.color.text_tertiary'))
          .margin({ top: 16 })
      }
      .width('100%')
        .padding({ left: 16, right: 16, bottom: 16 })
        .backgroundColor($r('app.color.bg_page'))

      Blank()

      // æŒ‰é’®
      Row({ space: 12 }) {
        Button(this.context.resourceManager.getStringSync($r('app.string.share_score').id))
          .layoutWeight(1)
          .height(48)
          .fontSize(17)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.button_primary'))
          .backgroundColor(Color.Transparent)
          .border({ width: 1, color: $r('app.color.button_primary') })
          .onClick(() => {
            this.onShareResult();
          })

        Button(this.level && this.level.id < getAllQuizLevels().length ? $r('app.string.next_level') : $r('app.string.perfect_finish'))
          .layoutWeight(1)
          .height(48)
          .fontSize(17)
          .fontWeight(FontWeight.Bold)
          .backgroundColor($r('app.color.button_primary'))
          .onClick(async () => {
            if (this.level && this.level.id < getAllQuizLevels().length) {
              // ä¸‹ä¸€å…³ - åœ¨å½“å‰é¡µé¢é‡æ–°åŠ è½½æ•°æ®
              await GameProgressManager.init(this.context);
              await GameProgressManager.unlockNextLevel(GameType.QUIZ, this.level.id);
              this.loadLevel(this.level.id + 1);
            } else {
              // å®Œç¾æ”¶å®˜ï¼Œé€€å‡º
              router.back();
            }
          })
      }
      .width('100%')
        .padding({ left: 16, right: 16 })
        .margin({ bottom: 32 })
    }
    .width('100%')
      .height('100%')
      .backgroundColor($r('app.color.bg_page'))
  }

  private async onShareResult(): Promise<void> {
    if (this.isSharing) return;

    this.isSharing = true;
    promptAction.showToast({
      message: this.context.resourceManager.getStringSync($r('app.string.preparing_share').id),
      duration: 1500
    });

    try {
      // æ„å»ºåˆ†äº«æ–‡æœ¬
      const quizTypeNameRes = this.quizType === 'flagToName' 
        ? $r('app.string.quiz_flag_to_name') 
        : $r('app.string.quiz_name_to_flag');
      const quizTypeName = this.context.resourceManager.getStringSync(quizTypeNameRes.id);
      const shareText = await this.buildShareText(quizTypeName);

      // ä½¿ç”¨æ–‡æœ¬åˆ†äº«
      const gameQuizName = this.context.resourceManager.getStringSync($r('app.string.game_quiz').id);
      const levelChallengeSuccess = this.context.resourceManager.getStringSync(
        $r('app.string.level_challenge_success').id, 
        this.level?.id?.toString() || '1'
      );
      const shareData = new systemShare.SharedData({
        utd: uniformTypeDescriptor.UniformDataType.TEXT,
        content: shareText,
        title: `${gameQuizName} - ${quizTypeName}`,
        description: levelChallengeSuccess
      });

      const controller = new systemShare.ShareController(shareData);
      await controller.show(this.context, {
        selectionMode: systemShare.SelectionMode.SINGLE,
        previewMode: systemShare.SharePreviewMode.DEFAULT
      });

    } catch (err) {
      const error = err as BusinessError;
      console.error(`Failed to share: code: ${error?.code}, message: ${error?.message}`);
      promptAction.showToast({
        message: this.context.resourceManager.getStringSync($r('app.string.share_failed').id),
        duration: 2000
      });
    } finally {
      this.isSharing = false;
    }
  }

  private async buildShareText(quizTypeName: string): Promise<string> {
    const lines: string[] = [];
    const congratsText = await this.context.resourceManager.getStringValue($r('app.string.congratulations').id);
    lines.push(`ğŸ‰ ${congratsText}`);
    lines.push('');
    lines.push(`ğŸ® ${quizTypeName}`);
    const levelText = this.context.resourceManager.getStringSync($r('app.string.level_number').id, (this.level?.id || 1).toString());
    lines.push(`ğŸ† ${levelText} Â· ${this.level?.name}`);
    lines.push('');
    lines.push(`âœ… ${this.context.resourceManager.getStringSync($r('app.string.correct_answers_share').id, this.correctAnswers.toString(), this.questions.length.toString())}`);
    lines.push(`ğŸ”¥ ${this.context.resourceManager.getStringSync($r('app.string.max_combo_share').id, this.maxCombo.toString())}`);
    lines.push(`â¤ï¸ ${this.context.resourceManager.getStringSync($r('app.string.remaining_lives_share').id, this.lives.toString())}`);
    lines.push('');
    const fromAppText = this.context.resourceManager.getStringSync($r('app.string.from_app').id);
    lines.push(`â€”â€” ${fromAppText}`);

    return lines.join('\n');
  }
}

