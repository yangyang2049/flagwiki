import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import common from '@ohos.app.ability.common';
import { systemShare } from '@kit.ShareKit';
import { uniformTypeDescriptor } from '@kit.ArkData';
import { BusinessError } from '@kit.BasicServicesKit';
import { Country, getCountryByCode, Countries } from '../../utils/countryData';
import { QuizLevel, getQuizLevel, getAllQuizLevels } from './QuizLevels';
import { GameProgressManager, GameType } from '../../utils/GameProgressManager';

interface RouterParams {
  quizType: string;
  levelId: number;
}

interface QuizQuestion {
  correctCountry: Country;
  choices: Country[];
}

@Entry
@Component
  struct QuizPlayPage {
  @State quizType: string = 'flagToName';
  @State level: QuizLevel | undefined = undefined;
  @State questions: QuizQuestion[] = [];
  @State currentIndex: number = 0;
  @State lives: number = 5;
  @State selectedIndex: number = -1;
  @State isAnswered: boolean = false;
  @State isCorrect: boolean = false;
  @State correctAnswers: number = 0;
  @State combo: number = 0;
  @State maxCombo: number = 0;
  @State showResult: boolean = false;
  @State animatingIndex: number = -1;
  @State scaleValue: number = 1;
  @State isSharing: boolean = false;
  private context = getContext(this) as common.UIAbilityContext;

  aboutToAppear() {
    const params = router.getParams() as RouterParams;
    if (params) {
      this.quizType = params.quizType || 'flagToName';
      const levelId = params.levelId || 1;
      this.level = getQuizLevel(levelId);
      if (this.level) {
        this.lives = this.level.lives;
        this.generateQuestions();
      }
    }
  }

  private generateQuestions(): void {
    if (!this.level) return;

    this.questions = [];
    for (const code of this.level.countries) {
      const country = getCountryByCode(code);
      if (country) {
        const choices = this.generateChoices(country);
        this.questions.push({
          correctCountry: country,
          choices: choices
        });
      }
    }
    // éšæœºæ‰“ä¹±é¢˜ç›®é¡ºåº
    this.shuffleArray(this.questions);
  }

  private generateChoices(correctCountry: Country): Country[] {
    const choices: Country[] = [correctCountry];
    const allCountries = Countries.filter(c => c.code !== correctCountry.code);

    // éšæœºé€‰æ‹©3ä¸ªé”™è¯¯é€‰é¡¹
    while (choices.length < 4 && allCountries.length > 0) {
      const randomIndex = Math.floor(Math.random() * allCountries.length);
      choices.push(allCountries[randomIndex]);
      allCountries.splice(randomIndex, 1);
    }

    // æ‰“ä¹±é€‰é¡¹é¡ºåº
    this.shuffleArray(choices);
    return choices;
  }

  private shuffleArray<T>(array: T[]): void {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      const temp = array[i];
      array[i] = array[j];
      array[j] = temp;
    }
  }

  private selectAnswer(index: number): void {
    if (this.isAnswered || this.animatingIndex !== -1) return;

    // å¼€å§‹åŠ¨ç”»
    this.animatingIndex = index;
    this.scaleValue = 1.1;

    // åŠ¨ç”»ç»“æŸåæ£€æŸ¥ç­”æ¡ˆ
    setTimeout(() => {
      this.scaleValue = 1;
      setTimeout(() => {
        this.checkAnswer(index);
      }, 100);
    }, 150);
  }

  private checkAnswer(index: number): void {
    this.selectedIndex = index;
    this.isAnswered = true;
    this.animatingIndex = -1;

    const question = this.questions[this.currentIndex];
    const selectedCountry = question.choices[index];
    this.isCorrect = selectedCountry.code === question.correctCountry.code;

    if (this.isCorrect) {
      this.correctAnswers++;
      this.combo++;
      if (this.combo > this.maxCombo) {
        this.maxCombo = this.combo;
      }
    } else {
      this.lives--;
      this.combo = 0;

      if (this.lives <= 0) {
        // å»¶è¿Ÿæ˜¾ç¤ºå¤±è´¥
        setTimeout(() => {
          this.showGameOver();
        }, 1500);
        return;
      }
    }
  }

  private async nextQuestion(): Promise<void> {
    if (this.currentIndex < this.questions.length - 1) {
      this.currentIndex++;
      this.selectedIndex = -1;
      this.isAnswered = false;
      this.isCorrect = false;
      this.animatingIndex = -1;
      this.scaleValue = 1;
    } else {
      // å®Œæˆæ‰€æœ‰é¢˜ç›®ï¼Œè§£é”ä¸‹ä¸€å…³
      if (this.level) {
        await GameProgressManager.init(this.context);
        await GameProgressManager.unlockNextLevel(GameType.QUIZ, this.level.id);
      }
      this.showResult = true;
    }
  }

  private showGameOver(): void {
    promptAction.showDialog({
      title: 'æŒ‘æˆ˜å¤±è´¥',
      message: `æ­£ç¡®å›ç­”äº† ${this.correctAnswers} é“é¢˜\næœ€é«˜è¿å‡» ${this.maxCombo}`,
      buttons: [
        { text: 'è¿”å›', color: '#666666' },
        { text: 'é‡æ–°å¼€å§‹', color: '#1677FF' }
      ]
    }).then((result) => {
      if (result.index === 0) {
        router.back();
      } else {
        this.restartQuiz();
      }
    });
  }

  private restartQuiz(): void {
    this.currentIndex = 0;
    this.selectedIndex = -1;
    this.isAnswered = false;
    this.isCorrect = false;
    this.correctAnswers = 0;
    this.combo = 0;
    this.maxCombo = 0;
    this.showResult = false;
    this.animatingIndex = -1;
    this.scaleValue = 1;
    if (this.level) {
      this.lives = this.level.lives;
    }
    this.generateQuestions();
  }

  private getTitle(): string {
    return this.quizType === 'flagToName' ? 'çœ‹æ——çŒœå›½å' : 'çœ‹åçŒœå›½æ——';
  }

  private getCorrectIndex(): number {
    const question = this.questions[this.currentIndex];
    return question.choices.findIndex(c => c.code === question.correctCountry.code);
  }

  build() {
    Navigation() {
      if (this.showResult) {
        this.ResultView()
      } else if (this.questions.length > 0) {
        Column() {
          // é¡¶éƒ¨çŠ¶æ€æ 
          Row() {
            // å·¦ä¾§ï¼šç¬¬å‡ å…³
            Text(`ç¬¬ ${this.level?.id} å…³`)
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .fontColor($r('app.color.text_secondary'))
              .layoutWeight(1)

            // ä¸­é—´ï¼šç”Ÿå‘½å€¼
            Row() {
              ForEach(Array.from({ length: this.level?.lives || 5 }), (_: undefined, index: number) => {
                Text(index < this.lives ? 'â¤ï¸' : 'ğŸ–¤')
                  .fontSize(14)
                  .margin({ left: 1, right: 1 })
              })
            }
            .layoutWeight(1)
              .justifyContent(FlexAlign.Center)

            // å³ä¾§ï¼šåºå·
            Text(`${this.currentIndex + 1} / ${this.questions.length}`)
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .fontColor($r('app.color.text_secondary'))
              .layoutWeight(1)
              .textAlign(TextAlign.End)
          }
          .width('100%')
            .padding({ left: 20, right: 20, top: 12, bottom: 12 })

          // è¿å‡»æç¤º
          if (this.combo >= 3) {
            Text(`ğŸ”¥ ${this.combo} è¿å‡»ï¼`)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.color_orange'))
              .padding({ top: 8, bottom: 8 })
          }

          // é¢˜ç›®åŒºåŸŸ
          if (this.quizType === 'flagToName') {
            this.FlagToNameQuestion()
          } else {
            this.NameToFlagQuestion()
          }

          Blank()

          // ä¸‹ä¸€é¢˜æŒ‰é’®
          if (this.isAnswered) {
            Button(this.currentIndex < this.questions.length - 1 ? 'ä¸‹ä¸€é¢˜' : 'æŸ¥çœ‹ç»“æœ')
              .width('80%')
              .height(48)
              .fontSize(17)
              .fontWeight(FontWeight.Bold)
              .backgroundColor($r('app.color.button_primary'))
              .margin({ bottom: 32 })
              .onClick(() => {
                this.nextQuestion();
              })
          }
        }
        .width('100%')
          .height('100%')
          .backgroundColor($r('app.color.bg_page'))
      } else {
        Column() {
          Text('åŠ è½½ä¸­...')
            .fontSize(16)
            .fontColor($r('app.color.text_tertiary'))
        }
        .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
      }
    }
    .title('')
      .titleMode(NavigationTitleMode.Mini)
      .backgroundColor($r('app.color.bg_page'))
  }

  @Builder
  FlagToNameQuestion() {
    Column() {
      // æ˜¾ç¤ºå›½æ——
      Column() {
        Image($rawfile(`flags/${this.questions[this.currentIndex].correctCountry.code}.svg`))
          .width('80%')
          .height(160)
          .objectFit(ImageFit.Contain)
      }
      .width('100%')
        .padding(24)
        .backgroundColor($r('app.color.bg_secondary'))
        .margin({ bottom: 24 })

      Text('è¿™æ˜¯å“ªä¸ªå›½å®¶çš„å›½æ——ï¼Ÿ')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
        .margin({ bottom: 20 })

      // é€‰é¡¹
      Column() {
        ForEach(this.questions[this.currentIndex].choices, (country: Country, index: number) => {
          this.ChoiceButton(country.nameCN, index)
        })
      }
      .width('100%')
        .padding({ left: 20, right: 20 })
    }
    .width('100%')
  }

  @Builder
  NameToFlagQuestion() {
    Column() {
      // æ˜¾ç¤ºå›½å®¶åç§°
      Column() {
        Text(this.questions[this.currentIndex].correctCountry.nameCN)
          .fontSize(32)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))

        Text(this.questions[this.currentIndex].correctCountry.name)
          .fontSize(16)
          .fontColor($r('app.color.text_secondary'))
          .margin({ top: 8 })
      }
      .width('100%')
        .padding(32)
        .margin({ bottom: 24 })

      Text('è¯·é€‰æ‹©æ­£ç¡®çš„å›½æ——')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
        .margin({ bottom: 20 })

      // å›½æ——é€‰é¡¹ - 2x2 ç½‘æ ¼
      Grid() {
        ForEach(this.questions[this.currentIndex].choices, (country: Country, index: number) => {
          GridItem() {
            this.FlagChoiceButton(country, index)
          }
        })
      }
      .columnsTemplate('1fr 1fr')
        .rowsTemplate('1fr 1fr')
        .columnsGap(12)
        .rowsGap(12)
        .width('100%')
        .height(280)
        .padding({ left: 20, right: 20 })
    }
    .width('100%')
  }

  @Builder
  ChoiceButton(text: string, index: number) {
    Row() {
      Text(text)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.getChoiceTextColor(index))
    }
    .width('100%')
      .height(52)
      .justifyContent(FlexAlign.Center)
      .backgroundColor(this.getChoiceBackgroundColor(index))
      .borderRadius(12)
      .border({
        width: 2,
        color: this.getChoiceBorderColor(index)
      })
      .margin({ bottom: 12 })
      .scale({ x: this.animatingIndex === index ? this.scaleValue : 1, y: this.animatingIndex === index ? this.scaleValue : 1 })
      .animation({ duration: 150, curve: Curve.EaseOut })
      .onClick(() => {
        this.selectAnswer(index);
      })
  }

  @Builder
  FlagChoiceButton(country: Country, index: number) {
    Column() {
      Image($rawfile(`flags/${country.code}.svg`))
        .width('100%')
        .height('100%')
        .objectFit(ImageFit.Contain)
        .padding(12)
    }
    .width('100%')
      .height('100%')
      .backgroundColor(this.getChoiceBackgroundColor(index))
      .borderRadius(12)
      .border({
        width: 1.5,
        color: this.getChoiceBorderColor(index)
      })
      .scale({ x: this.animatingIndex === index ? this.scaleValue : 1, y: this.animatingIndex === index ? this.scaleValue : 1 })
      .animation({ duration: 150, curve: Curve.EaseOut })
      .onClick(() => {
        this.selectAnswer(index);
      })
  }

  private getChoiceBackgroundColor(index: number): Resource {
    if (!this.isAnswered) {
      return $r('app.color.bg_card');
    }

    const correctIndex = this.getCorrectIndex();
    if (index === correctIndex) {
      return $r('app.color.bg_green_light');
    }
    if (index === this.selectedIndex && !this.isCorrect) {
      return $r('app.color.bg_red_light');
    }
    return $r('app.color.bg_card');
  }

  private getChoiceBorderColor(index: number): Resource {
    if (!this.isAnswered) {
      return $r('app.color.gray_border');
    }

    const correctIndex = this.getCorrectIndex();
    if (index === correctIndex) {
      return $r('app.color.color_green');
    }
    if (index === this.selectedIndex && !this.isCorrect) {
      return $r('app.color.color_red');
    }
    return $r('app.color.gray_border');
  }

  private getChoiceTextColor(index: number): Resource {
    if (!this.isAnswered) {
      return $r('app.color.text_primary');
    }

    const correctIndex = this.getCorrectIndex();
    if (index === correctIndex) {
      return $r('app.color.color_green');
    }
    if (index === this.selectedIndex && !this.isCorrect) {
      return $r('app.color.color_red');
    }
    return $r('app.color.text_primary');
  }

  @Builder
  ResultView() {
    Column() {
      // å¯åˆ†äº«çš„å†…å®¹åŒºåŸŸ
      Column() {
        Text('ğŸ‰')
          .fontSize(64)
          .margin({ top: 40 })

        Text('æ­å–œè¿‡å…³ï¼')
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))
          .margin({ top: 24 })

        Text(`ç¬¬ ${this.level?.id} å…³ Â· ${this.level?.name}`)
          .fontSize(16)
          .fontColor($r('app.color.text_secondary'))
          .margin({ top: 8 })

        // ç»Ÿè®¡ä¿¡æ¯
        Column() {
          Row() {
            Text('æ­£ç¡®ç­”é¢˜')
              .fontSize(16)
              .fontColor($r('app.color.text_secondary'))
            Blank()
            Text(`${this.correctAnswers} / ${this.questions.length}`)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
          }
          .width('100%')
            .padding({ top: 16, bottom: 16 })

          Divider().color($r('app.color.gray_very_light'))

          Row() {
            Text('æœ€é«˜è¿å‡»')
              .fontSize(16)
              .fontColor($r('app.color.text_secondary'))
            Blank()
            Text(`${this.maxCombo}`)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
          }
          .width('100%')
            .padding({ top: 16, bottom: 16 })

          Divider().color($r('app.color.gray_very_light'))

          Row() {
            Text('å‰©ä½™ç”Ÿå‘½')
              .fontSize(16)
              .fontColor($r('app.color.text_secondary'))
            Blank()
            Text(`${this.lives} â¤ï¸`)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
          }
          .width('100%')
            .padding({ top: 16, bottom: 16 })
        }
        .width('100%')
          .padding({ left: 24, right: 24 })
          .margin({ top: 32 })
          .backgroundColor($r('app.color.bg_card'))
          .borderRadius(16)

        Text('å›½æ——å°ç™¾ç§‘')
          .fontSize(12)
          .fontColor($r('app.color.text_tertiary'))
          .margin({ top: 16 })
      }
      .width('100%')
        .padding({ left: 16, right: 16, bottom: 16 })
        .backgroundColor($r('app.color.bg_page'))

      Blank()

      // æŒ‰é’®
      Row({ space: 12 }) {
        Button('åˆ†äº«æˆç»©')
          .layoutWeight(1)
          .height(48)
          .fontSize(17)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.button_primary'))
          .backgroundColor(Color.Transparent)
          .border({ width: 1, color: $r('app.color.button_primary') })
          .onClick(() => {
            this.onShareResult();
          })

        Button('è¿”å›')
          .layoutWeight(1)
          .height(48)
          .fontSize(17)
          .fontWeight(FontWeight.Bold)
          .backgroundColor($r('app.color.button_primary'))
          .onClick(() => {
            router.back();
          })
      }
      .width('100%')
        .padding({ left: 16, right: 16 })
        .margin({ bottom: 16 })

      Button(this.level && this.level.id < getAllQuizLevels().length ? 'ä¸‹ä¸€å…³' : 'å®Œç¾æ”¶å®˜')
        .width('100%')
        .height(48)
        .fontSize(17)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.button_primary'))
        .backgroundColor(Color.Transparent)
        .border({ width: 1, color: $r('app.color.button_primary') })
        .margin({ left: 16, right: 16, bottom: 32 })
        .onClick(() => {
          if (this.level && this.level.id < getAllQuizLevels().length) {
            // ä¸‹ä¸€å…³
            router.pushUrl({
              url: 'pages/quiz/QuizPlayPage',
              params: {
                quizType: this.quizType,
                levelId: this.level.id + 1
              }
            });
          } else {
            // å®Œç¾æ”¶å®˜ï¼Œé€€å‡º
            router.back();
          }
        })
    }
    .width('100%')
      .height('100%')
      .backgroundColor($r('app.color.bg_page'))
  }

  private async onShareResult(): Promise<void> {
    if (this.isSharing) return;

    this.isSharing = true;
    promptAction.showToast({
      message: 'æ­£åœ¨å‡†å¤‡åˆ†äº«...',
      duration: 1500
    });

    try {
      // æ„å»ºåˆ†äº«æ–‡æœ¬
      const quizTypeName = this.quizType === 'flagToName' ? 'çœ‹æ——çŒœå›½å' : 'çœ‹åçŒœå›½æ——';
      const shareText = this.buildShareText(quizTypeName);

      // ä½¿ç”¨æ–‡æœ¬åˆ†äº«
      const shareData = new systemShare.SharedData({
        utd: uniformTypeDescriptor.UniformDataType.TEXT,
        content: shareText,
        title: `å›½æ——çŒœçŒœ - ${quizTypeName}`,
        description: `ç¬¬${this.level?.id}å…³æŒ‘æˆ˜æˆåŠŸ`
      });

      const controller = new systemShare.ShareController(shareData);
      await controller.show(this.context, {
        selectionMode: systemShare.SelectionMode.SINGLE,
        previewMode: systemShare.SharePreviewMode.DEFAULT
      });

    } catch (err) {
      const error = err as BusinessError;
      console.error(`Failed to share: code: ${error?.code}, message: ${error?.message}`);
      promptAction.showToast({
        message: 'åˆ†äº«å¤±è´¥',
        duration: 2000
      });
    } finally {
      this.isSharing = false;
    }
  }

  private buildShareText(quizTypeName: string): string {
    const lines: string[] = [];
    lines.push('ğŸ‰ æ­å–œè¿‡å…³ï¼');
    lines.push('');
    lines.push(`ğŸ® ${quizTypeName}`);
    lines.push(`ğŸ† ç¬¬ ${this.level?.id} å…³ Â· ${this.level?.name}`);
    lines.push('');
    lines.push(`âœ… æ­£ç¡®ç­”é¢˜ï¼š${this.correctAnswers} / ${this.questions.length}`);
    lines.push(`ğŸ”¥ æœ€é«˜è¿å‡»ï¼š${this.maxCombo}`);
    lines.push(`â¤ï¸ å‰©ä½™ç”Ÿå‘½ï¼š${this.lives}`);
    lines.push('');
    lines.push('â€”â€” æ¥è‡ªã€Œå›½æ——å°ç™¾ç§‘ã€');

    return lines.join('\n');
  }
}

